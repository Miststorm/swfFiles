"use strict";!function(e){var n=e.module("route-segment",[]);n.provider("$routeSegment",["$routeProvider",function(n){var t=this.options={autoLoadTemplates:!0,strictMode:!1},r=this.segments={},a=function e(n,r){if(!n)throw new Error("Invalid pointer segment");var i;return{segment:function(e,t){return n[o(e)]={name:e,params:t},i=e,this},within:function(r){var a;if(a=n[o(r=r||i)])void 0==a.children&&(a.children={});else{if(t.strictMode)throw new Error("Cannot get into unknown `"+r+"` segment");a=n[o(r)]={params:{},children:{}}}return e(a.children,this)},up:function(){return r},root:function(){return a}}}(r,null),i={};function o(e){return e.replace(/([\:\-\_]+(.))/g,function(e,n,t,r){return r?t.toUpperCase():t})}this.when=function(e,t){return n.when(e,{segment:t}),i[t]=e,this},e.extend(this,a),this.$get=["$rootScope","$q","$http","$templateCache","$route","$routeParams","$injector",function(n,a,u,c,l,s,m){var h={name:"",$routeParams:e.copy(s),chain:[],startsWith:function(e){return new RegExp("^"+e).test(h.name)},contains:function(e){for(var n=0;n<this.chain.length;n++)if(this.chain[n]&&this.chain[n].name==e)return!0;return!1},getSegmentUrl:function(n,t){var r,a,o;if(!i[n])throw new Error("Can not get URL for segment with name `"+n+"`");for(a in t=e.extend({},s,t||{}),r=i[n],t){var u=new RegExp(":"+a+"[*?]?","g");r=r.replace(u,t[a])}if(o=(r=r.replace(/\/\:.*?\?/g,"")).match(/\/\:([^\/]*)/))throw new Error("Route param `"+o[1]+"` is not specified for route `"+i[n]+"`");return r}},f={};function g(n){var t=!1;return n.params.dependencies&&e.forEach(n.params.dependencies,function(n){e.equals(h.$routeParams[n],s[n])||(t=!0)}),t}function p(e,n){return h.chain[e]&&h.chain[e].clearWatcher&&h.chain[e].clearWatcher(),n?(f[e]=n.name,n.params.untilResolved?v(e,n.name,n.params.untilResolved).then(function(t){return void 0!=t.success&&d(e),v(e,n.name,n.params)}):v(e,n.name,n.params)):(f[e]=null,void d(e))}function v(r,i,o){var l=e.extend({},o.resolve);return e.forEach(l,function(n,t){l[t]=e.isString(n)?m.get(n):m.invoke(n)}),o.template&&(l.$template=o.template,e.isFunction(l.$template)&&(l.$template=m.invoke(l.$template))),t.autoLoadTemplates&&o.templateUrl&&(l.$template=o.templateUrl,e.isFunction(l.$template)&&(l.$template=m.invoke(l.$template)),l.$template=u.get(l.$template,{cache:c}).then(function(e){return e.data})),a.all(l).then(function(t){if(f[r]!=i)return a.reject();if(h.chain[r]={name:i,params:o,locals:t,reload:function(){var e=$(r,h.name.split("."));p(r,e).then(function(e){void 0!=e.success&&d(r)})}},o.watcher){var u=function(){if(!e.isFunction(o.watcher)&&!e.isArray(o.watcher))throw new Error("Watcher is not a function in segment `"+i+"`");return m.invoke(o.watcher,{},{segment:h.chain[r]})},c=u();h.chain[r].clearWatcher=n.$watch(u,function(e){e!=c&&(c=e,h.chain[r].reload())})}return{success:r}},function(n){if(o.resolveFailed){var t={error:function(){return a.when(n)}};return v(r,i,e.extend({resolve:t},o.resolveFailed))}throw new Error("Resolving failed with a reason `"+n+"`, but no `resolveFailed` provided for segment `"+i+"`")})}function d(t){h.$routeParams=e.copy(s),h.name="";for(var r=0;r<h.chain.length;r++)h.chain[r]&&(h.name+=h.chain[r].name+".");h.name=h.name.substr(0,h.name.length-1),n.$broadcast("routeSegmentChange",{index:t,segment:h.chain[t]||null})}function $(e,n){if(!n)return null;if(e>=n.length)return null;for(var t,a=r,i=0;i<=e;i++)void 0!=a[o(t=n[i])]&&(a=a[o(t)]),i<e&&(a=a.children);return{name:t,params:a.params,children:a.children}}return n.$on("$routeChangeSuccess",function(e,n){var t=n.$route||n.$$route;if(t&&t.segment){for(var r=t.segment.split("."),i=[],o=-1,u=0;u<r.length;u++){var c=$(u,r);(f[u]!=c.name||i.length>0||g(c))&&(h.chain[u]&&h.chain[u].name==c.name&&0==i.length&&!g(c)?f[u]=c.name:(i.push({index:u,newSegment:c}),o=u))}var l=a.when();if(i.length>0)for(u=0;u<i.length;u++)!function(e){l=l.then(function(){return p(i[e].index,i[e].newSegment)}).then(function(n){if(void 0!=n.success){d(n.success);for(var t=i[e].index+1;t<h.chain.length;t++)h.chain[t]&&(h.chain[t]=null,p(t,null))}})}(u);l.then(function(){if(h.chain.length>r.length){var e=h.chain.length,n=h.chain.length-r.length;h.chain.splice(-n,n);for(var t=r.length;t<e;t++)p(t,null),o=h.chain.length-1}}).then(function(){var e=a.when();if(o==h.chain.length-1)for(var n=$(o,h.name.split("."));n;){var t=n.children,r=o+1;for(var i in n=null,t)!function(t,r,a){r[t].params.default&&(e=e.then(function(){return p(a,{name:r[t].name,params:r[t].params}).then(function(e){e.success&&d(e.success)})}),n=r[t],o=a)}(i,t,r)}return e})}}),h}]}]),n.filter("routeSegmentUrl",["$routeSegment",function(e){var n=function(n,t){return e.getSegmentUrl(n,t)};return n.$stateful=!0,n}]),n.filter("routeSegmentEqualsTo",["$routeSegment",function(e){var n=function(n){return e.name==n};return n.$stateful=!0,n}]),n.filter("routeSegmentStartsWith",["$routeSegment",function(e){var n=function(n){return e.startsWith(n)};return n.$stateful=!0,n}]),n.filter("routeSegmentContains",["$routeSegment",function(e){var n=function(n){return e.contains(n)};return n.$stateful=!0,n}]),n.filter("routeSegmentParam",["$routeSegment",function(e){var n=function(n){return e.$routeParams[n]};return n.$stateful=!0,n}])}(angular),function(e){e.module("view-segment",["route-segment"]).directive("appViewSegment",["$route","$compile","$controller","$routeParams","$routeSegment","$q","$injector","$timeout","$animate",function(e,n,t,r,a,i,o,u,c){return{restrict:"ECA",priority:400,transclude:"element",compile:function(e,n){return function(e,t,r,i,o){var l,s,m,h,f={},g=n.onload||"",p=parseInt(n.appViewSegment);function v(n){f=n;var r=e.$new(),a=o(r,function(e){n&&e.data("viewSegment",n),c.enter(e,null,s||t),function(){h&&(c.cancel(h),h=null),l&&(l.$destroy(),l=null),s&&((h=c.leave(s))&&h.then(function(){h=null}),s=null)}()});s=a,(l=r).$emit("$viewContentLoaded"),l.$eval(g)}a.chain[p]?m=u(function(){v(a.chain[p])},0):v(),e.$on("routeSegmentChange",function(e,n){m&&u.cancel(m),n.index==p&&f!=n.segment&&v(n.segment)})}}}}]),e.module("view-segment").directive("appViewSegment",["$route","$compile","$controller",function(n,t,r){return{restrict:"ECA",priority:-400,link:function(n,a){var i=a.data("viewSegment")||{},o=e.extend({},i.locals),u=o&&o.$template;u&&a.html(u);var c=t(a.contents());if(i.params&&i.params.controller){o.$scope=n;var l=r(i.params.controller,o);i.params.controllerAs&&(n[i.params.controllerAs]=l),a.data("$ngControllerController",l),a.children().data("$ngControllerController",l)}c(n)}}}])}(angular);