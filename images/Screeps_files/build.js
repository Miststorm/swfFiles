(mod=angular.module("app",["ngRoute","ngAnimate","ngMessages","ngMaterial","route-segment","view-segment","app.nw-manifest","app.socket","ui.ace","ui.modal","ui.bootstrap","app.local-storage","app.top","app.game","app.game.creep","app.game.spawn","app.game.source","app.game.energy","app.game.construction-site","app.game.constructed-wall","app.game.exit","app.game.extension","app.game.flag","app.game.room.walls","app.game.room.roads","app.game.room.display-options-block","app.game.room.rendered-svg-path","app.game.room.view-popup","ui.bootstrap.tabs","app.game.memory","app.game.console","app.game.script","luegg.directives","app.connection","app.game.room","app.game.room.dlg-creep","app.dialogs","app.constants","app.game.tutorial","app.static-maps","app.memory-storage","app.game.editor-panel","app.game.replay-list","app.api","app.config","app.login","app.register","app.auth","app.loader","app.game.lobby","ngAria","app.game.room.dlg-flag","app.game.room.spawn-properties","app.game.room.creep-properties","ui.drop","app.profile","app.profile.account","app.key-filter","app.game.keeper-lair","app.game.portal","app.game.lobby.survival","app.game.lobby.arena","app.game.room.dlg-arena-activation","ui.json-editor","app.profile.account.badge","app.badge","app.badge.paths","app.game.world-map","app.game.controller","app.game.dlg-world-activation","app.game.dlg-world-respawn","app.profile.early-preview-request","app.game.overview","app.game.overview.room","app.punchcard","app.game.lobby.world","app.ea","app.game.room.controller-properties","app.game.link","app.game.room.flag-properties","app.timeline-stats","app.profile.messages.respondent","app.profile.messages.index","app.game.storage","app.game.script.dlg-clone-branch","app.profile.cpu","app.game.tower","app.game.observer","app.game.disabled-object","app.game.power-bank","app.game.power-spawn","app.game.lobby.power","app.profile-stats","app.recaptcha","app.profile.account.subscription","app.game.mineral","app.game.extractor","app.game.lab","app.game.terminal","app.game.container","app.game.tutorial.section1","app.game.tutorial.section2","app.game.tutorial.section3","app.game.tutorial.section4","app.game.tutorial.section5","angularSpectrumColorpicker","app.game.market","app.game.nuke","app.game.nuker","app.dlg-version-updated","app.code-branches","app.nw-local-file-sync","app.game.rampart","app.game.room.rampart-properties","app.game.market.all-orders","app.game.market.my-orders","app.game.market.history","app.dlg-server-message","app.game.shards","app.game.room.dlg-display-options","app.routing-app2","app.profile.account.auth-tokens","app.profile.account.auth-tokens.noratelimit","app.profile.account.runtime","app.game.room.power-icon","app.game.room.power-creep-properties"])).config(["$locationProvider","$routeProvider","$routeSegmentProvider","$mdThemingProvider","$compileProvider",function(e,t,o,r,n){e.hashPrefix("!"),t.otherwise({redirectTo:"/g"}),r.theme("default").dark().primaryColor("indigo",{"hue-3":"A400"}).accentColor("teal",{default:"500"}).warnColor("orange"),r.setDefaultTheme("default"),n.imgSrcSanitizationWhitelist(/^\s*((https?|ftp|file|blob|chrome-extension|steam):|data:image\/)/),n.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|chrome-extension|steam):/)}]),mod.constant("uiAceConfig",{ace:{advanced:{enableTern:{defs:["ecma5","ecma6","screeps"],plugins:{doc_comment:{fullDocs:!0}},useWorker:!0,switchToDoc:function(e,t){},startedCb:function(){}},enableSnippets:!0,enableBasicAutocompletion:!0}}}),mod.constant("AppInstanceId",(new Date).getTime()),mod.constant("ResourceTypeNames",{token:"subscription token",energy:"energy",power:"power",H:"hydrogen",O:"oxygen",U:"utrium",L:"lemergium",K:"keanium",Z:"zynthium",X:"catalyst",OH:"hydroxide",ZK:"zynthium keanite",UL:"utrium lemergite",G:"ghodium",UH:"utrium hydride",UO:"utrium oxide",KH:"keanium hydride",KO:"keanium oxide",LH:"lemergium hydride",LO:"lemergium oxide",ZH:"zynthium hydride",ZO:"zynthium oxide",GH:"ghodium hydride",GO:"ghodium oxide",UH2O:"utrium acid",UHO2:"utrium alkalide",KH2O:"keanium acid",KHO2:"keanium alkalide",LH2O:"lemergium acid",LHO2:"lemergium alkalide",ZH2O:"zynthium acid",ZHO2:"zynthium alkalide",GH2O:"ghodium acid",GHO2:"ghodium alkalide",XUH2O:"catalyzed utrium acid",XUHO2:"catalyzed utrium alkalide",XKH2O:"catalyzed keanium acid",XKHO2:"catalyzed keanium alkalide",XLH2O:"catalyzed lemergium acid",XLHO2:"catalyzed lemergium alkalide",XZH2O:"catalyzed zynthium acid",XZHO2:"catalyzed zynthium alkalide",XGH2O:"catalyzed ghodium acid",XGHO2:"catalyzed ghodium alkalide",ops:"ops"}),mod.run(["$routeSegment","$rootScope","Socket","$http","MemoryStorage","LocalStorage","Connection","Auth","Loader","$mdAria","$interval","$document","$injector",function(e,t,o,r,n,a,i,s,c,u,l,p,m){if(t.$routeSegment=e,t._=_,t.isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,t.Me=function(){return s.Me},t.Loader=c,t.Math=Math,t.isOffServer=function(){return m.get("Api").options.official},t.isMultiShard=function(){return m.get("Api").options.serverData.shards.length>1},!1===a.get("firstVisit",!1,"")){var d=(new Date).getTime();a.put("firstVisit",d,"")}(l.bindToScope=function(e,t,o){var r=l(t,o);e.$on("$destroy",function(){return l.cancel(r)})},p.bindToScope=function(e,t,o){var r=function(t){return e.$apply(function(){return o(t)})};p.bind(t,r),e.$on("$destroy",function(){return p.unbind(t,r)})},window.nw)?(t.nw=!0,require("./greenworks").initAPI()):c.registerPre(m.get("Api").get("version").then(function(e){m.get("Api").options.serverData=e.serverData}))}]),mod.directive("appShowWhenSteamOverlay",["$animate","$timeout",function(e,t){return{link:function(o,r,n){var a,i=!1;function s(){i&&setTimeout(function(){r[0].getContext("2d").clearRect(0,0,1,1),window.requestAnimationFrame(s)},1e3/30)}function c(o){e[o?"removeClass":"addClass"](r,"ng-hide"),(i=o)&&(s(),a&&(t.cancel(a),a=null))}require("./greenworks").on("game-overlay-activated",function(e){return o.$apply(function(){e?c(!0):(a&&t.cancel(a),(a=t(2e3)).then(function(){i&&c(!1)}))})}),o.$on("$destroy",function(){return i=!1})}}}]),mod.directive("appCustomValidator",function(){return{require:"ngModel",link:function(e,t,o,r){var n=e.$eval(o.appCustomValidator);for(var a in n)n[a]().$$state&&(r.$asyncValidators[a]=n[a]);for(var a in n)n[a]().$$state||(r.$validators[a]=n[a])}}}),mod.directive("appController",function(){return{controller:"@",priority:-1e4}}),mod.directive("appAutofocus",function(){return{link:function(e,t,o){o.appAutofocus&&!e.$eval(o.appAutofocus)||setTimeout(function(){t.focus()},100)}}}),mod.directive("appSubmit",["$parse",function(e){return{controller:["$scope","$attrs",function(t,o){var r=this;this.loadingCnt=!1,this.recaptchaWidgetId=null,this.onSubmit=function(n){t.$apply(function(){r.loadingCnt=!1;var a=e(o.appSubmit)(t,{$recaptcha:n});a&&a.then&&(r.loadingCnt=!0,a.catch(function(){t.$broadcast("form fail")}).finally(function(){r.loadingCnt=!1}))})}}],link:function(e,t,o,r){t.submit(function(t){t.preventDefault(),null!==r.recaptchaWidgetId?(grecaptcha.reset(r.recaptchaWidgetId),e.$apply(function(){r.loadingCnt=!0,grecaptcha.execute(r.recaptchaWidgetId)})):r.onSubmit()})}}}]),mod.directive("appFormFailAnim",["$animate",function(e){return{link:function(t,o,r){t.$on("form fail",function(){e.addClass(o,r.appFormFailAnim).then(function(){return e.removeClass(o,r.appFormFailAnim)})})}}}]),mod.directive("appSubmitAnimated",function(){return{require:"^appSubmit",link:function(e,t,o,r){e.$watch(function(){return r.loadingCnt},function(e){t.toggleClass("striped",e),e?t.attr("disabled","disabled"):t.removeAttr("disabled")})}}}),mod.directive("appSubmitRecaptcha",["Recaptcha",function(e){return{require:"^appSubmit",link:function(t,o,r,n){e.disabled||t.$watch(function(){return e.loaded},function(e){e&&(n.recaptchaWidgetId=grecaptcha.render(o[0],{sitekey:"6Lc-Q0IUAAAAACrAWi56MDdxAjK98uiNO1klxDic",theme:"dark",size:"invisible",badge:r.appSubmitRecaptcha||"bottomright",callback:function(e){n.onSubmit(e)}}))})}}}]),mod.directive("appFocusOnEvent",function(){return{link:function(e,t,o){e.$on(o.appFocusOnEvent,function(){setTimeout(function(){t.focus(),t.find("input, textarea").focus()},100)})}}}),mod.directive("appCursorToEndOnEvent",function(){return{link:function(e,t,o){e.$on(o.appCursorToEndOnEvent,function(){t.get(0).setSelectionRange&&t.get(0).setSelectionRange(t.val().length,t.val().length)})}}}),mod.directive("appStopClickPropagation",function(){return function(e,t,o){t.click(function(t){if("~"==o.appStopClickPropagation.charAt(0)){var r=o.appStopClickPropagation.match(/^~(.*)$/);r[1]&&!e.$eval(r[1])||t.stopImmediatePropagation()}else(""==o.appStopClickPropagation||e.$eval(o.appStopClickPropagation))&&t.stopPropagation()})}}),mod.directive("appStopPropagation",function(){return function(e,t,o){t.bind(o.appStopPropagation,function(e){e.stopPropagation()})}}),mod.directive("appClickAnimated",["$parse",function(e){return{scope:!0,link:function(t,o,r){o.bind("click",function(n){o.addClass("striped"),o.attr("disabled","disabled"),t.$apply(function(){e(r.appClickAnimated)(t,{$event:n}).finally(function(){(o.removeClass("striped"),r.ngDisabled)?t.$eval(r.ngDisabled)?o.attr("disabled","disabled"):o.removeAttr("disabled"):o.removeAttr("disabled")})})})}}}]),mod.directive("appOnCtrlEnter",function(){return{link:function(e,t,o){t.find("textarea").keydown(function(t){((t.ctrlKey||t.shiftKey)&&13==t.keyCode||t.ctrlKey&&83==t.keyCode)&&(t.preventDefault(),e.$apply(function(){return e.$eval(o.appOnCtrlEnter)}))})}}}),mod.directive("appFacebookParse",["$timeout",function(e){return{link:function(t,o,r){e(function(){FB.XFBML.parse()},10)}}}]),mod.directive("appAutoScrollWatch",function(){return{priority:1e5,link:function(e,t,o){var r=0;e.$watch(o.appAutoScrollWatch,function(){null!==r&&setTimeout(function(){t[0].scrollTop=t[0].scrollHeight-t.height()-r,r&&(r=0)},0)}),t.scroll(function(){0!==r&&null!==r||(r=t[0].scrollTop==t[0].scrollHeight-t.height()?0:null)}),e.$on("save scroll",function(){r=t[0].scrollHeight-t.height()-t[0].scrollTop})}}}),mod.directive("appEnterSubmit",function(){return{link:function(e,t){t.keydown(function(e){13==e.keyCode&&e.ctrlKey&&($(t.get(0).form).submit(),e.preventDefault())})}}}),mod.directive("appClickSelectAll",function(){return{link:function(e,t,o){t.click(function(){return t[0].select()})}}}),mod.directive("appButtonCopyInput",function(){return{link:function(e,t,o){t.find("button").click(function(){t.find("input")[0].select(),document.execCommand("copy")})}}}),mod.directive("appNwExternalLink",function(){return{link:function(e,t,o){window.nw&&t.click(function(e){nw.Shell.openExternal(o.appNwExternalLink||t.attr("href")),e.preventDefault()})}}}),mod.filter("empty",function(){return function(e){if(_.isObject(e)){if(_.isArray(e))return 0==e.length;for(var t in e)if(!_.isFunction(e[t])&&null!==e[t]&&void 0!==e[t])return!1;return!0}return null===e||void 0===e}}),mod.filter("keys",function(){return function(e){return _.keys(e)}}),mod.filter("sort",function(){return function(e){return e.sort()}}),mod.filter("trust",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]),mod.filter("bust",function(){return function(e){return e+"?bust=1561537540072"}}),mod.filter("readableDate",["$locale",function(e){return function(e){var t=new Date,o=new Date(e),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0);if(o.getTime()>t.getTime()-6e4)return"Just now";if(o.getTime()>t.getTime()-36e5){var n=Math.round((t.getTime()-o.getTime())/1e3/60);return n+(1!=n?" minutes ago":" minute ago")}return o.getTime()>=r.getTime()?"Today at "+o.toLocaleTimeString():o.getTime()>new Date(t.getFullYear(),t.getMonth(),t.getDate()-1,0,0,0).getTime()?"Yesterday at "+o.toLocaleTimeString():o.getTime()>new Date(t.getFullYear(),t.getMonth(),t.getDate()-4,0,0,0).getTime()?Math.round((r.getTime()-new Date(o.getFullYear(),o.getMonth(),o.getDate(),0,0,0))/24/3600/1e3)+" days ago":o.toLocaleDateString()}}]),mod.factory("$mdAria",function(){return{expect:angular.noop,expectWithText:angular.noop}}),mod.filter("pad",function(){return function(e){return e<10?"0"+e:e}}),mod.filter("round",function(){return function(e){e=Math.round(0|e);var t=Math.floor(Math.log10?Math.log10(e):Math.log(e)/Math.LN10+1e-8),o=Math.floor(t/3),r=100;return t>3&&(t-3*o>0&&(r=10),t-3*o>1&&(r=1),(e=""+(e=Math.floor(e/Math.pow(10,3*o)*r)/r)).length<3&&!/\./.test(e)&&(e+=".0"),e+={0:"",1:"K",2:"M",3:"B"}[o]),""+e}}),mod.filter("marked",["$sce",function(e){var t=new marked.Renderer;t.link=function(e,t,o){if(this.options.sanitize){try{var r=decodeURIComponent(function(e){return e.replace(/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/g,function(e,t){return"colon"===(t=t.toLowerCase())?":":"#"===t.charAt(0)?"x"===t.charAt(1)?String.fromCharCode(parseInt(t.substring(2),16)):String.fromCharCode(+t.substring(1)):""})}(e)).replace(/[^\w:]/g,"").toLowerCase()}catch(e){return""}if(0===r.indexOf("javascript:")||0===r.indexOf("vbscript:")||0===r.indexOf("data:"))return""}var n='<a href="'+e+'"';return t&&(n+=' title="'+t+'"'),n+='onclick="if(window.nw) {nw.Shell.openExternal(this.href); return false;}">'+o+"</a>"};var o=_.extend({},marked.defaults,{breaks:!0,sanitize:!0,code:!0,renderer:t}),r=new marked.Lexer(o),n=new marked.Parser(o);return function(t){return t=n.parse(r.lex(t)),e.trustAsHtml(t)}}]),mod.filter("truncate",function(){return function(e,t){return e.length<=t?e:e.substring(0,t)+"..."}}),mod.filter("elapsedDays",function(){function e(e){return e<10?"0"+e:e}var t=function(t){var o=t-Date.now();return o<0?null:o>1728e5?Math.floor(o/24/3600/1e3)+" days":e(Math.floor(o/60/60/1e3))+":"+e(Math.floor(o/60/1e3)%60)+":"+e(Math.floor(o/1e3)%60)};return t.$stateful=!0,t}),mod.filter("capitalize",function(){return function(e){return e.charAt(0).toUpperCase()+e.slice(1)}}),mod.directive("appSpectrum",function(){return{link:function(e,t,o){$(t).spectrum({preferredFormat:"hex",showInput:!0}),$(t).on("change.spectrum",function(){return e.$apply()})}}}),mod.directive("appVisible",["$animate",function(e){return{restrict:"A",link:function(t,o,r){t.$watch(r.appVisible,function(t){e[t?"removeClass":"addClass"](o,"invisible")})}}}]),mod.directive("appAttr",function(){return{link:function(e,t,o){var r=o.appAttr.split("#");e.$watch(r[1],function(e){return t[0].setAttribute(r[0],e)})}}}),mod.directive("appFileInput",function(){return{require:"ngModel",link:function(e,t,o,r){t.on("change",function(e){var o=t[0].files;r.$setViewValue(o)}),e.$on("appFileDrop",function(e,t){r.$setViewValue(t)})}}}),mod.directive("appFileDrop",function(){return function(e,t,o){t.addClass("file-drop"),t.on("dragenter",function(e){e.stopPropagation(),e.preventDefault(),t.addClass("file-drop--active")}),t.on("dragover",function(e){e.stopPropagation(),e.preventDefault(),t.addClass("file-drop--active")}),t.on("dragexit dragleave",function(e){t.removeClass("file-drop--active")}),t.on("drop",function(o){o.stopPropagation(),o.preventDefault(),t.removeClass("file-drop--active"),o.originalEvent.dataTransfer&&e.$apply(function(){e.$broadcast("appFileDrop",o.originalEvent.dataTransfer.files)})})}}),mod.filter("routeSegmentUrlStateless",["$routeSegment",function(e){return function(t,o){return e.getSegmentUrl(t,o)}}]),angular.module("ngAria",[]),(mod=angular.module("app.badge.paths",[])).value("BadgePaths",{1:{calc:function(e){var t=0,o=0;e>0&&(t=30*e/100),e<0&&(o=30*-e/100),this.path1="M 50 "+(100-t)+" L "+o+" 50 H "+(100-o)+" Z",this.path2="M "+o+" 50 H "+(100-o)+" L 50 "+t+" Z"}},2:{calc:function(e){var t=0,o=0;e>0&&(t=30*e/100),e<0&&(o=30*-e/100),this.path1="M "+t+" "+o+" L 50 50 L "+(100-t)+" "+o+" V -1 H -1 Z",this.path2="M "+t+" "+(100-o)+" L 50 50 L "+(100-t)+" "+(100-o)+" V 101 H -1 Z"}},3:{calc:function(e){var t=Math.PI/4+Math.PI/4*(e+100)/200,o=-Math.PI/2,r=Math.PI/2+Math.PI/3,n=Math.PI/2-Math.PI/3;this.path1="M 50 50 L "+(50+100*Math.cos(o-t/2))+" "+(50+100*Math.sin(o-t/2))+" L "+(50+100*Math.cos(o+t/2))+" "+(50+100*Math.sin(o+t/2))+" Z",this.path2="M 50 50 L "+(50+100*Math.cos(r-t/2))+" "+(50+100*Math.sin(r-t/2))+" L "+(50+100*Math.cos(r+t/2))+" "+(50+100*Math.sin(r+t/2))+" Z\n                          M 50 50 L "+(50+100*Math.cos(n-t/2))+" "+(50+100*Math.sin(n-t/2))+" L "+(50+100*Math.cos(n+t/2))+" "+(50+100*Math.sin(n+t/2))},flip:"rotate180"},4:{calc:function(e){var t=50-30*(e+=100)/200,o=50+30*e/200;this.path1="M 0 "+o+" H 100 V 100 H 0 Z",this.path2=e>0?"M 0 "+t+" H 100 V "+o+" H 0 Z":""},flip:"rotate90"},5:{calc:function(e){var t=50-10*(e+=100)/200-10,o=50+10*e/200+10;this.path1="M "+t+" 0 H "+o+" V 100 H "+t+" Z",this.path2="M 0 "+t+" H 100 V "+o+" H 0 Z"},flip:"rotate45"},6:{calc:function(e){var t=5+8*(e+100)/200;this.path1="M "+(50-t)+" 0 H "+(50+t)+" V 100 H "+(50-t),this.path2="M "+(20-t)+" 0 H "+(20+t)+" V 100 H "+(20-t)+" Z\n                          M "+(80-t)+" 0 H "+(80+t)+" V 100 H "+(80-t)+" Z"},flip:"rotate90"},7:{calc:function(e){var t=20+10*e/100;this.path1="M 0 50 Q 25 30 50 50 T 100 50 V 100 H 0 Z",this.path2="M 0 "+(50-t)+" Q 25 "+(30-t)+" 50 "+(50-t)+" T 100 "+(50-t)+"\n                            V "+(50+t)+" Q 75 "+(70+t)+" 50 "+(50+t)+" T 0 "+(50+t)+" Z"},flip:"rotate90"},8:{calc:function(e){var t=20*e/100;this.path1="M 0 50 H 100 V 100 H 0 Z",this.path2="M 0 50 Q 50 "+t+" 100 50 Q 50 "+(100-t)+" 0 50 Z"},flip:"rotate90"},9:{calc:function(e){var t=0,o=50;e>0&&(t+=e/100*20),e<0&&(o+=e/100*30),this.path1="M 50 "+t+" L 100 "+(t+70)+" V 101 H 0 V "+(t+70)+" Z",this.path2="M 50 "+(t+o)+" L 100 "+(t+o+70)+" V 101 H 0 V "+(t+o+70)+" Z"},flip:"rotate180"},10:{calc:function(e){var t=30,o=7;e>0&&(t+=50*e/100),e<0&&(o-=20*e/100),this.path1="M "+(50+o+t)+" "+(50-t)+" A "+t+" "+t+" 0 0 0 "+(50+o+t)+" "+(50+t)+" H 101 V "+(50-t)+" Z",this.path2="M "+(50-o-t)+" "+(50-t)+" A "+t+" "+t+" 0 0 1 "+(50-o-t)+" "+(50+t)+" H -1 V "+(50-t)+" Z"},flip:"rotate90"},11:{calc:function(e){var t=30,o=30,r=50-50*Math.cos(Math.PI/4),n=50-50*Math.sin(Math.PI/4);e>0&&(t+=25*e/100,o+=25*e/100),e<0&&(o-=50*e/100),this.path1="M "+r+" "+n+" Q "+t+" 50 "+r+" "+(100-n)+" H 0 V "+n+" Z\n                          M "+(100-r)+" "+n+" Q "+(100-t)+" 50 "+(100-r)+" "+(100-n)+" H 100 V "+n+" Z",this.path2="M "+r+" "+n+" Q 50 "+o+" "+(100-r)+" "+n+" V 0 H "+r+" Z\n                          M "+r+" "+(100-n)+" Q 50 "+(100-o)+" "+(100-r)+" "+(100-n)+" V 100 H "+r+" Z"},flip:"rotate90"},12:{calc:function(e){var t=30,o=35;e>0&&(t+=30*e/100),e<0&&(o+=15*e/100),this.path1="M 0 "+t+" H 100 V 100 H 0 Z",this.path2="M 0 "+t+" H "+o+" V 100 H 0 Z\n                          M 100 "+t+" H "+(100-o)+" V 100 H 100 Z"},flip:"rotate180"},13:{calc:function(e){var t=30,o=0;e>0&&(t+=50*e/100),e<0&&(o-=20*e/100),this.path1="M 0 0 H 50 V 100 H 0 Z",this.path2="M "+(50-t)+" "+(50-o-t)+" A "+t+" "+t+" 0 0 0 "+(50+t)+" "+(50-t-o)+" V 0 H "+(50-t)+" Z"},flip:"rotate180"},14:{calc:function(e){var t=Math.PI/4;t+=e*Math.PI/4/100,this.path1="M 50 0 Q 50 50 "+(50+50*Math.cos(t))+" "+(50+50*Math.sin(t))+" H 100 V 0 H 50 Z",this.path2="M 50 0 Q 50 50 "+(50-50*Math.cos(t))+" "+(50+50*Math.sin(t))+" H 0 V 0 H 50 Z"},flip:"rotate180"},15:{calc:function(e){var t=13+6*e/100;this.path1="M "+(-30-t)+" 110 A "+(80+t)+" "+(80+t)+" 0 0 1 "+(130+t)+" 110\n                                   H "+(130-t)+" A "+(80-t)+" "+(80-t)+" 0 1 0 "+(-30+t)+" 110",this.path2="M "+(5-t)+" 110 A "+(45+t)+" "+(45+t)+" 0 0 1 "+(95+t)+" 110\n                                   H "+(95-t)+" A "+(45-t)+" "+(45-t)+" 0 1 0 "+(5+t)+" 110"},flip:"rotate180"},16:{calc:function(e){var t=30*Math.PI/180,o=25;e>0&&(t+=30*Math.PI/180*e/100),e<0&&(o+=25*e/100),this.path1="";for(var r=0;r<3;r++){var n=r*Math.PI*2/3+t/2-Math.PI/2,a=r*Math.PI*2/3-t/2-Math.PI/2;this.path1+="M "+(50+100*Math.cos(n))+" "+(50+100*Math.sin(n))+"\n                               L "+(50+100*Math.cos(a))+" "+(50+100*Math.sin(a))+"\n                               L "+(50+o*Math.cos(a))+" "+(50+o*Math.sin(a))+"\n                               A "+o+" "+o+" 0 0 1 "+(50+o*Math.cos(n))+" "+(50+o*Math.sin(n))+" Z"}this.path2="";for(r=0;r<3;r++){n=r*Math.PI*2/3+t/2+Math.PI/2,a=r*Math.PI*2/3-t/2+Math.PI/2;this.path2+="M "+(50+100*Math.cos(n))+" "+(50+100*Math.sin(n))+"\n                               L "+(50+100*Math.cos(a))+" "+(50+100*Math.sin(a))+"\n                               L "+(50+o*Math.cos(a))+" "+(50+o*Math.sin(a))+"\n                               A "+o+" "+o+" 0 0 1 "+(50+o*Math.cos(n))+" "+(50+o*Math.sin(n))+" Z"}}},17:{calc:function(e){var t=35,o=45;e>0&&(t+=20*e/100),e<0&&(o-=30*e/100),this.path1="M 50 45 L "+(50-t)+" "+(o+45)+" H "+(50+t)+" Z",this.path2="M 50 0 L "+(50-t)+" "+o+" H "+(50+t)+" Z"}},18:{calc:function(e){var t=90*Math.PI/180,o=10;e>0&&(t-=60/180*Math.PI*e/100),e<0&&(o-=15*e/100),this.path1="",this.path2="";for(var r=0;r<3;r++){var n=2*Math.PI/3*r+t/2-Math.PI/2,a=2*Math.PI/3*r-t/2-Math.PI/2,i="M "+(50+100*Math.cos(n))+" "+(50+100*Math.sin(n))+"\n                            L "+(50+100*Math.cos(a))+" "+(50+100*Math.sin(a))+"\n                            L "+(50+o*Math.cos((n+a)/2))+" "+(50+o*Math.sin((n+a)/2))+" Z";r?this.path2+=i:this.path1+=i}},flip:"rotate180"},19:{calc:function(e){var t=20,o=60;o+=20*e/100,t+=20*e/100,this.path1="M 50 -10 L "+(50-o)+" 100 H "+(50+o)+" Z",this.path2="",t>0&&(this.path2="M 50 0 L "+(50-t)+" 100 H "+(50+t)+" Z")},flip:"rotate180"},20:{calc:function(e){var t=10,o=20;e>0&&(t+=20*e/100),e<0&&(o+=40*e/100),this.path1="M 0 "+(50-o)+" H "+(50-t)+" V 100 H 0 Z",this.path2="M "+(50+t)+" 0 V "+(50+o)+" H 100 V 0 Z"},flip:"rotate90"},21:{calc:function(e){var t=40,o=50;e>0&&(t-=20*e/100),e<0&&(o+=20*e/100),this.path1="M 50 "+o+" Q "+(50+t)+" 0 50 0 T 50 "+o+" Z\n                          M 50 "+(100-o)+" Q "+(50+t)+" 100 50 100 T 50 "+(100-o)+" Z",this.path2="M "+o+" 50 Q 0 "+(50+t)+" 0 50 T "+o+" 50 Z\n                          M "+(100-o)+" 50 Q 100 "+(50+t)+" 100 50 T "+(100-o)+" 50 Z"},flip:"rotate45"},22:{calc:function(e){var t=20;t+=10*e/100,this.path1="M "+(50-t)+" "+(50-t)+" H "+(50+t)+" V "+(50+t)+" H "+(50-t)+" Z",this.path2="";for(var o=-4;o<4;o++)for(var r=-4;r<4;r++){var n=(o+r)%2;this.path2+="M "+(50-t-2*t*o)+" "+(50-t-2*t*(r+n))+" h "+2*-t+" v "+2*t+" h "+2*t+" Z"}},flip:"rotate45"},23:{calc:function(e){var t=17,o=25;e>0&&(t+=35*e/100),e<0&&(o-=23*e/100),this.path1="";for(var r=-4;r<=4;r++)this.path1+="M "+(50-t*r*2)+" "+(50-o)+" l "+-t+" "+-o+" l "+-t+" "+o+" l "+t+" "+o+" Z";this.path2="";for(r=-4;r<=4;r++)this.path2+="M "+(50-t*r*2)+" "+(50+o)+" l "+-t+" "+-o+" l "+-t+" "+o+" l "+t+" "+o+" Z"},flip:"rotate90"},24:{calc:function(e){var t=50,o=45;e>0&&(t+=60*e/100),e<0&&(o+=30*e/100),this.path1="M 0 "+o+" L 50 70 L 100 "+o+" V 100 H 0 Z",this.path2="M 50 0 L "+(50+t)+" 100 H 100 V "+o+" L 50 70 L 0 "+o+" V 100 H "+(50-t)+" Z"},flip:"rotate180"}});var mod=angular.module("app.badge",[]);function dataUrlToBlob(e,t,o){if("string"!=typeof e)throw new Error("Invalid argument: dataURI must be a string");e=e.split(","),t=t||e[0].split(":")[1].split(";")[0];for(var r=atob(e[1]),n=r.length,a=new ArrayBuffer(n),i=new Uint8Array(a),s=0;s<n;s++)i[s]=r.charCodeAt(s);o(new Blob([i],{type:t}))}function hsl2rgb(e,t,o){var r,n,a,i=(1-Math.abs(2*o-1))*t,s=e/60,c=i*(1-Math.abs(s%2-1));void 0===e||isNaN(e)||null===e?r=n=a=0:s>=0&&s<1?(r=i,n=c,a=0):s>=1&&s<2?(r=c,n=i,a=0):s>=2&&s<3?(r=0,n=i,a=c):s>=3&&s<4?(r=0,n=c,a=i):s>=4&&s<5?(r=c,n=0,a=i):s>=5&&s<6&&(r=i,n=0,a=c);var u,l,p,m=o-i/2;function d(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t}return u=255*(r+m),l=255*(n+m),p=255*(a+m),u=Math.round(u),l=Math.round(l),p=Math.round(p),d(u)+d(l)+d(p)}function badgeDirective(e){return ngInject(["BadgeGenerator",function(t){return{link:function(o,r,n){var a=0,i=function(){r.attr(e)||r.attr(e,t.emptyDataUrl);var i=(new Date).getTime(),s=o.$eval(n[n.$normalize("app:badge-"+e)]),c=r.width(),u=r.height();if(r[0].getBoundingClientRect){var l=r[0].getBoundingClientRect();c=Math.round(l.width),u=Math.round(l.height),c<20&&(c=20,u=20)}return t.getImageData(s,c,u).then(function(t){i>a&&(r.attr(e,t),a=i)})},s=o.$eval(n[n.$normalize("app:badge-"+e)]);if("autoWatch"in n&&(s&&s._watching||"src"==e))o.$watch(_.throttle(i,"src"==e?100:1e3));else i();"watchChange"in n&&o.$watch(function(){return o.$eval(n[n.$normalize("app:badge-"+e)])},function(o){r.attr(e,t.emptyDataUrl),i()}),o.$on("resize",i)}}}])}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,o){dataUrlToBlob(this.toDataURL(t,o),t,e)}}),mod.factory("BadgeGenerator",["$cacheFactory","$rootScope","BadgePaths","$q",function(e,t,o,r){var n=e("badges",{capacity:1e3}),a={},i=window.URL||window.webkitURL||window,s=n.remove;function c(e,t,o){return"key_"+e.type+"_"+(e.flip?"1":"0")+"_"+e.color1+"_"+e.color2+"_"+e.color3+"_"+(e.param||0)+"_"+t+"_"+o}n.remove=function(e){i.revokeObjectURL(a[e]),s.call(this,e)};var u=[],l=0;u.push({index:l++,rgb:"#"+hsl2rgb(0,0,.8)});for(var p=0;p<19;p++)u.push({index:l++,rgb:"#"+hsl2rgb(360*p/19,.6,.8)});u.push({index:l++,rgb:"#"+hsl2rgb(0,0,.5)});for(p=0;p<19;p++)u.push({index:l++,rgb:"#"+hsl2rgb(360*p/19,.7,.5)});u.push({index:l++,rgb:"#"+hsl2rgb(0,0,.3)});for(p=0;p<19;p++)u.push({index:l++,rgb:"#"+hsl2rgb(360*p/19,.4,.3)});u.push({index:l++,rgb:"#"+hsl2rgb(0,0,.1)});for(p=0;p<19;p++)u.push({index:l++,rgb:"#"+hsl2rgb(360*p/19,.5,.1)});var m={getImageData:function(e,a,s){if(!e)return r.when(m.emptyDataUrl);var l=c(e,a,s),p=n.get(l);return p||(p=function(e,n,a){return r(function(r,s){if(e){var c=document.createElement("canvas"),l=_.isString(e.color1)?e.color1:u[e.color1].rgb,p=_.isString(e.color2)?e.color2:u[e.color2].rgb,d=_.isString(e.color3)?e.color3:u[e.color3].rgb;n=Math.round(n),a=Math.round(a),e.param>100&&(e.param=100),e.param<-100&&(e.param=-100),c.width=n,c.height=a,_.isNumber(e.type)&&o[e.type].calc(e.param);var h=0;e.flip&&_.isNumber(e.type)&&("rotate180"==o[e.type].flip&&(h=180),"rotate90"==o[e.type].flip&&(h=90),"rotate45"==o[e.type].flip&&(h=45));var f,g,v='<svg xmlns="http://www.w3.org/2000/svg" width="'+n+'" height="'+a+'" viewBox="0 0 100 100" shape-rendering="geometricPrecision">\n                            <defs>\n                                <clipPath id="clip">\n                                    <circle cx="50" cy="50" r="52" />\n                                    \x3c!--<rect x="0" y="0" width="100" height="100"/>--\x3e\n                                </clipPath>\n                            </defs>\n                            <g transform="rotate('+h+' 50 50)">\n                            <rect x="0" y="0" width="100" height="100" fill="'+l+'" clip-path="url(#clip)"/>';_.isNumber(e.type)?(f=o[e.type].path1,g=o[e.type].path2):(f=e.type.path1,g=e.type.path2),v+='<path d="'+f+'" fill="'+p+'" clip-path="url(#clip)"/>',g&&(v+='<path d="'+g+'" fill="'+d+'" clip-path="url(#clip)"/>'),v+="</g></svg>";var y=c.getContext("2d"),b=new Image,w=new Blob([v],{type:"image/svg+xml"}),S=i.createObjectURL(w);b.onload=function(){t.$applyAsync(function(){b.width=n,b.height=a,y.clearRect(0,0,n,a),y.drawImage(b,0,0),b.src="",i.revokeObjectURL(S),c.toBlob(function(e){c=null,b=null,w=null,y=null,r(i.createObjectURL(e))})})},b.src=S}else r(m.emptyDataUrl)})}(e,a,s),n.put(l,p)),p},getImageDataFromCache:function(e,t,o){var r=c(e,t,o);return n.get(r)},colors:u};return dataUrlToBlob("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2NkAAIAAAoAAggA9GkAAAAASUVORK5CYII=","image/png",function(e){m.emptyDataUrl=i.createObjectURL(e)}),m}]),mod.directive("appBadgeSrc",badgeDirective("src")),mod.directive("appBadgeXlinkHref",badgeDirective("xlink:href")),(mod=angular.module("app.dialogs",["ui.modal"])).factory("Dialogs",["$modal","$injector","$q",function(e,t,o){var r={ask:function(t,r,n){if(_.isObject(t))var a=t,i=(t=a.title,r=a.message,n=a.callback,a.buttonLabel),s=a.buttonClass,c=a.buttonCancelLabel,u=a.buttonOptionalLabel;return e.open({templateUrl:"components/common/dialogs/dlg-ask.html?bust=1561537540072",controller:["$scope","$modalInstance",function(e,a){e.title=t,e.message=r,e.buttonLabel=i||"OK",e.buttonClass=s||"md-primary",e.buttonCancelLabel=c||"Cancel",e.buttonOptionalLabel=u,e.cancel=function(e){a.dismiss(e)},e.ok=function(e){return n?n().then(function(){a.close(e)}):(a.close(e),o.when())}}]})},alert:function(t,o){return e.open({templateUrl:"components/common/dialogs/dlg-alert.html?bust=1561537540072",controller:["$scope","$modalInstance",function(e,r){e.title=t,e.message=o,e.cancel=function(e){r.dismiss(e)}}]}).result},askForName:function(o,r){return t.get("Connection").genUniqueNameForType(o,r).then(function(n){return e.open({templateUrl:"components/common/dialogs/dlg-name.html?bust=1561537540072",controller:["$scope","$modalInstance","data",function(e,n,a){var i=this;this.name=a.name,this.submit=function(){n.close(i.name)},this.nameValidators={unique:function(e){return t.get("Connection").checkUniqueNameForType(e,o,r)}}}],controllerAs:"DlgName",resolve:{data:function(){return new Object({name:n})}}}).result})},askForSelect:function(t){return e.open({templateUrl:"components/common/dialogs/dlg-select.html?bust=1561537540072",controller:["$scope","$modalInstance",function(e,r){var n=this;this.title=t.title||"Select",this.label=t.label,this.value=t.value,this.options=t.options,this.note=t.note,this.submit=function(){return t.callback?t.callback(n.value).then(function(){r.close(n.value)}):(r.close(n.value),o.when())}}],controllerAs:"DlgSelect",windowClass:"dlg-select-window"}).result}};return r.Ctrl=ngInject(["$scope","$modalInstance",function(e,t){e.cancel=function(){t.dismiss()},e.ok=function(e){t.close(e)}}]),r}]),(mod=angular.module("app.dlg-server-message",[])).component("appDlgServerMessage",{templateUrl:"components/common/dlg-server-message/dlg-server-message.html?bust=1561537540072",controller:ngInject(["$scope","Socket",function(e,t){var o=this;this.message=null,this.onClose=function(){o.message=null},t.bindEventToScope(e,"server-message",function(e){o.message=e})}])}),(mod=angular.module("app.dlg-version-updated",[])).component("appDlgVersionUpdated",{templateUrl:"components/common/dlg-version-updated/dlg-version-updated.html?bust=1561537540072",controller:ngInject(["Socket","NwManifest",function(e,t){var o=this;this.closed=!1,this.isNw=function(){return!!window.nw},this.isVisible=function(){return!o.closed&&(!window.nw||e.newPackageDownloaded)&&t.packageVersion<e.packageVersion},this.onReload=function(){window.location.reload(!0)},this.onClose=function(){o.closed=!0}}])}),(mod=angular.module("app.loader",[]).factory("Loader",["$q","$interval",function(e,t){var o={},r=[];return o.loadingCnt=0,o.factory=function(t){var n,a={},i={};return a.load=function(){a.status="loading",o.loadingCnt++;var s=arguments;return(n=e.all(r).then(function(){var o=t.apply(a,s);return o.then?o:e.all(o)}).then(function(e){if(!angular.isObject(e)||angular.isArray(e))throw new Error("loadCallback resolves into non-object");return angular.extend(i,e),i})).finally(function(){o.loadingCnt--,a.status="ready"}),n},a.getPromise=function(){return n||a.load()},a.reset=function(){n=null},a.status="await",a},o.registerPre=function(e){r.push(e)},o.slowDownArray=function(e,o,r,n,a){return function(i){var s=i[e];return a=a||1,s.length&&(i[e]=s.splice(0,o),s.length&&setTimeout(function(){t(function(){for(var t=s.splice(0,a),o=0;o<t.length;o++)i[e].push(t[o])},n,Math.ceil(s.length/a))},r)),i}},o.loading=function(e){return o.loadingCnt++,e.finally(function(){o.loadingCnt--})},o}])).directive("appLoading",["Loader","$window",function(e,t){return{controller:["$scope",function(t){t.Loader=e}],link:function(e,o){t.addEventListener("scroll",function(e){o.toggleClass("fixed",$(t).scrollTop()>$("#head").offset().top)})}}}]),(mod=angular.module("app.profile-stats",[])).directive("appProfileStats",function(){return{templateUrl:"components/common/profile-stats/profile-stats.html?bust=1561537540072",controller:"ProfileStats as ProfileStats",scope:!0,bindToController:{stats:"=",normalize:"="}}}),mod.controller("ProfileStats",["$scope",function(e){}]),(mod=angular.module("app.punchcard",[])).directive("appPunchCard",function(){return{templateUrl:"components/common/punchcard/punchcard.html?bust=1561537540072",controllerAs:"PunchCard",bindToController:!0,scope:{data:"=",label:"=",max:"=",interval:"="},controller:["$scope",function(e){var t=this;this.getRadius=function(e){return Math.sqrt(Math.min(e,t.max)/t.max*7853/Math.PI)},this.getDate=function(e){return new Date(60*e*1e3*t.interval)}}]}}),(mod=angular.module("app.recaptcha",[])).factory("Recaptcha",function(){return{loaded:!1,disabled:!0}}),mod.directive("appRecaptcha",["Recaptcha","$parse",function(e,t){return{link:function(o,r,n){o.$watch(function(){return e.loaded},function(e){e&&grecaptcha.render(r[0],{sitekey:"6LcjCBMTAAAAAEu0ytR0uydHQtTmLJ9bNQYcPFuj",theme:"dark",callback:function(e){o.$apply(function(){t(n.appRecaptcha).assign(o,e)})}})})}}}]),angular.module("ui.bootstrap.tabs",[]).controller("TabsetController",["$scope",function(e){var t=this,o=t.tabs=e.tabs=[];t.select=function(t){angular.forEach(o,function(e){e.active&&e!==t&&(e.active=!1,e.onDeselect())}),t.active=!0,t.onSelect(),e.selectedName=t.name},t.selectByName=function(e){angular.forEach(o,function(o){o.name!=e||o.active||t.select(o)})},t.addTab=function(r){o.push(r),1===o.length?e.selectedName||(r.active=!0):r.active&&t.select(r)},t.removeTab=function(e){var r=o.indexOf(e);if(e.active&&o.length>1){var n=r==o.length-1?r-1:r+1;t.select(o[n])}o.splice(r,1)}}]).directive("tabset",["$timeout",function(e){return{restrict:"EA",transclude:!0,replace:!0,scope:{type:"@",selectedName:"="},controller:"TabsetController",templateUrl:"components/common/ui/bootstrap/tabs/tabset.html?bust=1561537540072",link:function(t,o,r,n){t.vertical=!!angular.isDefined(r.vertical)&&t.$parent.$eval(r.vertical),t.justified=!!angular.isDefined(r.justified)&&t.$parent.$eval(r.justified),t.$watch("selectedName",function(t,o){t&&e(function(){return n.selectByName(t)},0)})}}}]).directive("tab",["$parse","$document",function(e,t){return{require:"^tabset",restrict:"EA",replace:!0,templateUrl:"components/common/ui/bootstrap/tabs/tab.html?bust=1561537540072",transclude:!0,scope:{active:"=?",heading:"@",name:"@",onSelect:"&select",onDeselect:"&deselect"},controller:function(){},compile:function(o,r,n){return function(o,r,a,i){o.$watch("active",function(e){e&&i.select(o)}),o.disabled=!1,a.disabled&&o.$parent.$watch(e(a.disabled),function(e){o.disabled=!!e}),o.select=function(){o.disabled||(o.active=!0)},i.addTab(o),o.$on("$destroy",function(){i.removeTab(o)}),o.$transcludeFn=n,a.hotkey&&$(t).keydown(function(e){e.keyCode==parseInt(a.hotkey)&&e.altKey&&o.$apply(function(){return o.select()})})}}}}]).directive("tabHeadingTransclude",[function(){return{restrict:"A",require:"^tab",link:function(e,t,o,r){e.$watch("headingElement",function(e){e&&(t.html(""),t.append(e))})}}}]).directive("tabContentTransclude",function(){return{restrict:"A",require:"^tabset",link:function(e,t,o){var r=e.$eval(o.tabContentTransclude);r.$transcludeFn(r.$parent,function(e){angular.forEach(e,function(e){!function(e){return e.tagName&&(e.hasAttribute("tab-heading")||e.hasAttribute("data-tab-heading")||"tab-heading"===e.tagName.toLowerCase()||"data-tab-heading"===e.tagName.toLowerCase())}(e)?t.append(e):r.headingElement=e})})}}}),(mod=angular.module("ui.drop.select",[])).directive("uiDropSelect",["$sce","$timeout",function(e,t){return{restrict:"EA",templateUrl:"components/common/ui/drop/select.html?bust=1561537540072",scope:{styleType:"@styleType",labelPattern:"@labelPattern",optionsExp:"&options",placeholder:"@placeholder",disabled:"=",dropClass:"@",btnClass:"@"},require:"ngModel",link:function(t,o,r,n){t._=_,t.$watch(t.optionsExp,function(e){t.options=e},!0),t.onSelect=function(e){t.model==e||t.disabled||(t.model=e,n.$setViewValue(t.model))},t.getLabel=function(){if(void 0===t.model||null==t.model)return e.trustAsHtml(t.placeholder);var o=_.find(_.pluck(t.options,t.model));return t.labelPattern?e.trustAsHtml(t.labelPattern.replace("{}",o)):e.trustAsHtml(o)},n.$render=function(){t.model=n.$viewValue}}}}]),mod.filter("uiDropSelectOptionsFilter",function(){return function(e,t,o){var r=[];return t&&o?_.isArray(e)?(e.forEach(function(e){return r.push(_defineProperty({},e[t],e[o]))}),r):null:t&&!o?_.isObject(e)?(angular.forEach(e,function(e,o){_.isObject(e)&&e[t]&&r.push(_defineProperty({},o,e[t]))}),r):null:t||o?null:_.isObject(e)?(angular.forEach(e,function(e,t){return r.push(_defineProperty({},t,e))}),r.sort(function(e,t){var o=_.findKey(e),r=_.findKey(t);return e[o]>t[r]?1:e[o]<t[r]?-1:0}),r):null}}),function(){var e=angular.module("ui.drop",["ui.drop.select"]);function t(e){return ngInject(["$timeout",function(t){return function(o,r,n,a){o.ctrl=a;var i=r[0].className;"E"==e&&(r=r.children()),r.addClass(i).attr("tabindex","-1"),o.$watch(function(){return a.isOpened&&(!n.uiAutoclose||o.$eval(n.uiAutoclose))},function(e){n.onOpen&&o.$eval(n.onOpen,{$val:e}),e?(r.on("blur.dropdown",function(e){t(function(){a.isOpened=!1},150)}),r.focus()):r.off("blur.dropdown")})}}])}e.controller("ui:drop",["$scope",function(e){this.isOpened=!1}]),e.directive("uiDropGroup",["$injector",function(e){return{restrict:"E",controller:"ui:drop",templateUrl:"components/common/ui/drop/group.html?bust=1561537540072",transclude:!0,scope:!0,link:e.invoke(t("E"))}}]),e.directive("uiDropGroup",["$injector",function(e){return{restrict:"A",controller:"ui:drop",scope:!0,link:e.invoke(t("A"))}}]);var o=ngInject(["$animate",function(e){return function(t,o,r,n){t.btnClass=r.btnClass,o.click(function(){t.$apply(function(){n.isOpened=!n.isOpened})}),t.$watch(function(){return n.isOpened},function(t){e[t?"addClass":"removeClass"](o,"active")})}}]);e.directive("uiDropBtn",["$injector",function(e){return{restrict:"E",require:"^uiDropGroup",templateUrl:function(e,t){return"link"==t.styleType?"components/common/ui/drop/btn-link.html":"md-button"==t.styleType?"components/common/ui/drop/md-btn.html":"components/common/ui/drop/btn.html?bust=1561537540072"},replace:!0,transclude:!0,link:e.invoke(o)}}]),e.directive("uiDropBtn",["$injector",function(e){return{restrict:"A",require:"^uiDropGroup",link:e.invoke(o)}}]);var r=ngInject(["$animate",function(e){return function(t,o,r,n){t.$watch(function(){return n.isOpened},function(t){e[t?"removeClass":"addClass"](o,"ng-hide")}),t.$on("uiDrop.hide",function(){n.isOpened=!1}),o.find("a, button").mousedown(function(e){e.preventDefault()})}}]);e.directive("uiDrop",["$injector",function(e){return{restrict:"E",require:"^uiDropGroup",templateUrl:"components/common/ui/drop/drop.html?bust=1561537540072",replace:!0,transclude:!0,link:e.invoke(r)}}]),e.directive("uiDrop",["$injector",function(e){return{restrict:"A",require:"^uiDropGroup",link:e.invoke(r)}}]),e.directive("uiDropItem",function(){return{restrict:"EA",require:"^uiDropGroup",templateUrl:"components/common/ui/drop/item.html?bust=1561537540072",replace:!0,transclude:!0,link:function(e,t,o,r){t.click(function(){e.$apply(function(){r.isOpened=!1})})}}}),e.directive("uiDropDivider",function(){return{restrict:"EA",require:"^uiDropGroup",templateUrl:"components/common/ui/drop/divider.html?bust=1561537540072",replace:!0}}),e.directive("uiDropClose",["$timeout",function(e){return{restrict:"EA",require:"^uiDropGroup",link:function(t,o,r,n){o.click(function(){e(function(){n.isOpened=!1,t.$apply()},0)})}}}]),e.directive("uiDropHeader",function(){return{restrict:"EA",require:"^uiDropGroup",templateUrl:"components/common/ui/drop/header.html?bust=1561537540072",replace:!0,transclude:!0}})}(),(mod=angular.module("ui.json-editor",[])).directive("appJsonEditor",["$parse",function(e){return{link:function(t,o,r){var n=new JSONEditor(o[0],t.$eval(r.appJsonEditor),t.$eval(r.editorJson));e(r.editorInterface).assign(t,{set:function(e){n.set(e),n.collapseAll()},get:function(){return n.get()}}),n.collapseAll()}}}]),angular.module("ui.modal",[]).factory("$$stackedMap",function(){return{createNew:function(){var e=[];return{add:function(t,o){e.push({key:t,value:o})},get:function(t){for(var o=0;o<e.length;o++)if(t==e[o].key)return e[o]},keys:function(){for(var t=[],o=0;o<e.length;o++)t.push(e[o].key);return t},top:function(){return e[e.length-1]},remove:function(t){for(var o=-1,r=0;r<e.length;r++)if(t==e[r].key){o=r;break}return e.splice(o,1)[0]},removeTop:function(){return e.splice(e.length-1,1)[0]},length:function(){return e.length}}}}}).directive("modalBackdrop",["$modalStack","$timeout",function(e,t){return{restrict:"EA",replace:!0,templateUrl:"components/common/ui/modal/backdrop.html?bust=1561537540072",transclude:!0,link:function(o,r,n){t(function(){o.animate=!0}),o.close=function(t){var o=e.getTop();o&&o.value.backdrop&&"static"!=o.value.backdrop&&(t.preventDefault(),t.stopPropagation(),e.dismiss(o.key,"backdrop click"))}}}}]).directive("modalWindow",["$timeout","$modalStack","$controller",function(e,t,o){return{restrict:"EA",scope:{index:"@"},replace:!0,transclude:!0,templateUrl:"components/common/ui/modal/window.html?bust=1561537540072",link:function(o,r,n){o.windowClass=n.windowClass||"",e(function(){o.animate=!0}),o.close=function(e){var o=t.getTop();o&&o.value.backdrop&&"static"!=o.value.backdrop&&(e.preventDefault(),e.stopPropagation(),t.dismiss(o.key,"backdrop click"))}}}}]).directive("modalWindowContent",["$controller",function(e){return{link:function(t,o,r,n,a){a(function(t){var r=o.inheritedData("modal-controller"),n=o.inheritedData("modal-controller-locals"),a=o.inheritedData("modal-controller-as");if(o.empty(),o.append(t),r){n.$scope=t.scope();var i=e(r,n);a&&(n.$scope[a]=i)}})}}}]).factory("$modalStack",["$document","$compile","$rootScope","$$stackedMap","$controller",function(e,t,o,r,n){var a,i,s=o.$new(!0),c=e.find("body").eq(0),u=r.createNew(),l={};function p(){for(var e=-1,t=u.keys(),o=0;o<t.length;o++)u.get(t[o]).value.backdrop&&(e=o);return e}function m(e){var t=u.get(e).value;u.remove(e),t.modalDomEl.remove(),i&&-1==p()&&(i.remove(),i=void 0),t.modalScope.$destroy()}return o.$watch(p,function(e){s.index=e}),e.bind("keydown",function(e){var t;27===e.which&&(t=u.top())&&t.value.keyboard&&o.$apply(function(){l.dismiss(t.key)})}),l.open=function(e,o){u.add(e,{deferred:o.deferred,modalScope:o.scope,backdrop:o.backdrop,keyboard:o.keyboard}),$(c).addClass("modal-open");var r=angular.element("<div modal-window></div>");r.attr("window-class",o.windowClass),r.attr("index",u.length()-1),r.data("modal-controller",o.controller),r.data("modal-controller-locals",o.ctrlLocals),r.data("modal-controller-as",o.controllerAs),r.html(o.content),r.show();var n=t(r)(o.scope);u.top().value.modalDomEl=n,c.append(n),o.autofocus&&setTimeout(function(){r.attr("tabindex","-1"),r.focus()},200),p()>=0&&!i&&(a=angular.element("<div modal-backdrop></div>"),i=t(a)(s),c.append(i))},l.close=function(e,t){$(c).removeClass("modal-open");var o=u.get(e);o&&o.value&&(o.value.deferred.resolve(t),m(e))},l.dismiss=function(e,t){$(c).removeClass("modal-open");var o=u.get(e);o&&o.value&&(o.value.deferred.reject(t),m(e))},l.getTop=function(){return u.top()},l}]).provider("$modal",function(){var e={options:{backdrop:!0,keyboard:!0,autofocus:!0},$get:["$injector","$rootScope","$q","$http","$templateCache","$controller","$modalStack","$animate","$timeout",function(t,o,r,n,a,i,s,c,u){var l={};return l.open=function(i){c.enabled(!1);var l=r.defer(),p=r.defer(),m={result:l.promise,opened:p.promise,close:function(e){s.close(m,e)},dismiss:function(e){s.dismiss(m,e)}};if((i=angular.extend({},e.options,i)).resolve=i.resolve||{},!i.template&&!i.templateUrl)throw new Error("One of template or templateUrl options is required.");var d=r.all([function(e){return e.template?r.when(e.template):n.get(e.templateUrl,{cache:a}).then(function(e){return e.data})}(i)].concat(function(e){var o=[];return angular.forEach(e,function(e,n){(angular.isFunction(e)||angular.isArray(e))&&o.push(r.when(t.invoke(e)))}),o}(i.resolve)));return d.then(function(e){var t=(i.scope||o).$new();t.$close=m.close,t.$dismiss=m.dismiss;var r={},n=1;i.controller&&(r.$scope=t,r.$modalInstance=m,angular.forEach(i.resolve,function(t,o){r[o]=e[n++]})),s.open(m,{scope:t,deferred:l,content:e[0],backdrop:i.backdrop,keyboard:i.keyboard,windowClass:i.windowClass,autofocus:i.autofocus,controller:i.controller,controllerAs:i.controllerAs,ctrlLocals:r}),u(function(){c.enabled(!0)},350)},function(e){l.reject(e)}),d.then(function(){p.resolve(!0)},function(){p.reject(!1)}),m},l}]};return e}),angular.module("luegg.directives",[]).directive("scrollGlue",["$parse","$timeout",function(e,t){return{priority:1,restrict:"A",link:function(o,r,n){var a=r[0],i=function(t,o){if(""!==t){var r=e(t);return void 0!==r.assign?function(e,t,o){return{getValue:function(){return e(o)},setValue:function(r){r!==e(o)&&o.$apply(function(){t(o,r)})}}}(r,r.assign,o):function(e,t){return{getValue:function(){return e(t)},setValue:function(){}}}(r,o)}return function(e){var t=e;return{getValue:function(){return t},setValue:function(e){t=e}}}(!0)}(n.scrollGlue,o);o.$watchCollection(n.scrollIf,function(e){t(function(){i.getValue()&&function(){a.scrollTop=a.scrollHeight}()},10)}),r.bind("scroll",function(){o.$apply(function(){i.setValue(function(){return a.scrollTop+a.clientHeight+1>=a.scrollHeight}())})})}}}]),(mod=angular.module("app.ea",[])).config(["$routeSegmentProvider",function(e){e.when("/ea","top.ea").within("top").segment("ea",{templateUrl:"components/ea/ea.html?bust=1561537540072",controller:"Top.Ea as Ea",resolve:{data:ngInject(["Api",function(e){return e.get("ea/list").then(function(e){return e.list})}])}})}]),mod.controller("Top.Ea",["$scope","Api","data",function(e,t,o){var r=this;this.data=o,this.hideSent=!1,this.send=function(){var e=_.pluck(_.filter(r.data,{checked:!0}),"email");t.post("ea/send",{emails:e}).then(function(e){return alert(JSON.stringify(e))})},this.filter=function(e){return!e.sent||!r.hideSent}}]),(mod=angular.module("app.game.dlg-world-activation",[])).controller("DlgWorldActivation",["$scope","MemoryStorage","$modalInstance","Api","$routeSegment","$location","$timeout","WorldActivator",function(e,t,o,r,n,a,i,s){var c=this;this.code="",this.error="",this.submit=function(){r.post("user/early-preview",{code:c.code}).then(function(e){mixpanel.track("Early Preview activated"),o.close(),s.showWelcomeDialog()}).catch(function(e){c.error="invalid code"==e?"Activation code is invalid":"Unknown error"})},this.requestForm=function(){o.dismiss(),i(function(){return a.url(n.getSegmentUrl("top.early-preview-request"))},10)}}]),mod.factory("WorldActivator",["DlgWelcomeService","Api","$routeSegment","$routeParams","$modal","Dialogs","$rootScope","Socket","$q",function(e,t,o,r,n,a,i,s,c){var u="1"==localStorage.getItem("debug")?1:14393988e5,l={launchTime:u,welcomeDialogDisplayed:!1};return i.$watch(function(){return s.timeCorrection},function(e,t){l.launchTime=u+s.timeCorrection}),l.run=function(){return t.options.official?t.get("user/world-status").then(function(e){"empty"==e.status&&l.showWelcomeDialog()}):(l.showWelcomeDialog(),c.when())},l.showWelcomeDialog=function(){if(!l.welcomeDialogDisplayed)if(l.welcomeDialogDisplayed=!0,t.options.official)e.open();else if(t.options.serverData.welcomeText){var o=$.parseHTML("<div>"+t.options.serverData.welcomeText+"</div>");$(o).find("a").attr("onclick","if(window.nw) {nw.Shell.openExternal(this.href); return false;}"),n.open({template:'<section class=dlg-world-welcome><div class="modal-body">'+$(o).html()+'</div>\n                            <div class="modal-footer"><md-button class="md-raised md-primary" type="button" ng-click="$dismiss()">OK</div></div>\n                            </section>',controller:a.Ctrl})}},l}]),(mod=angular.module("app.game.dlg-world-respawn",[])).factory("WorldRespawnChecker",["Api","$routeSegment","$routeParams","$modal","Dialogs","$interval","Auth","WorldActivator","$location","$q","LocalStorage","$rootScope",function(e,t,o,r,n,a,i,s,c,u,l,p){var m={dialogDisplayed:!1},d=function(){if(!m.dialogDisplayed&&i.Me)return e.get("user/world-status").then(function(t){if("lost"==t.status)m.dialogDisplayed=!0,n.ask({title:"",message:'<h4>Oops!</h4>\n                        <p>It seems that you have lost all your spawns. But cheer up! Losing is fun in Screeps! Your scripts are always with you, your Global Control Level is well and alive, and you can start from scratch and quickly regain your former glory.</p>\n                        <p>Click on the Respawn button below, and all your buildings and creeps will become unowned so that you can reset your spawn in any vacant room on the map. And don\'t forget to <a href="http://docs.screeps.com/defense.html" app-nw-external-link>build defenses</a> this time!</p>\n                        <p>Learn more about birth and death in <a href="http://docs.screeps.com/respawn.html" app-nw-external-link>this article</a>.</p>',buttonLabel:"Respawn"}).result.then(function(){return h()});else{var o=l.get("lastGcl",1);i.Me.getGcl()>parseInt(o)&&(n.alert("",{html:e.options.official?"<p>Global Control Level has been increased!<br>\n                             Your CPU Limit is now <strong>"+i.Me.getCpu()+" CPU</strong>, and you can control <strong>"+i.Me.getGcl()+' rooms</strong>.<br>\n                             <a target="_blank" href="http://docs.screeps.com/control.html" app-nw-external-link>Learn more</a></p>':"<p>Global Control Level has been increased!<br>\n                             You can control <strong>"+i.Me.getGcl()+' rooms</strong> now.<br>\n                             <a target="_blank" href="http://docs.screeps.com/control.html" app-nw-external-link>Learn more</a></p>'}),l.put("lastGcl",i.Me.getGcl()))}})},h=function(o){var r=u.when();return o&&(r=n.ask({title:"",message:'<p>All your buildings and creeps will become unowned so that you can reset your spawn in any vacant room on the map. <a href="http://docs.screeps.com/respawn.html" app-nw-external-link>Learn more</a></p><p><b>Note:</b> you will NOT be able to spawn again in the same room within 3 days since the initial spawn placement!</p>',buttonLabel:"Respawn",buttonClass:"md-warn md-hue-2"}).result),r.then(function(){return e.post("user/respawn")}).then(function(){return i.check()}).then(function(){s.welcomeDialogDisplayed=!1,m.dialogDisplayed=!1,"top.game-world-map"!=t.name&&c.url(t.getSegmentUrl("top.game-world-map")),p.$broadcast("respawned")})};return m.bind=function(e){var t=a(d,6e4);e.$on("$destroy",function(){return a.cancel(t)}),d()},m.check=function(){return d()},m.respawn=function(){return h(!0)},m}]),(mod=angular.module("app.game.console",[])).controller("Top.Game.Console",["$scope","Console","Tutorial","Connection","$timeout","uiAceConfig",function(e,t,o,r,n,a){var i,s=this,c=null,u=[];this.command="";var l=!1;this.aceOptions=_.merge({mode:"javascript",theme:"tomorrow_night",useWrapMode:!1,showGutter:!1,advanced:{highlightActiveLine:!1},rendererOptions:{maxLines:1},onLoad:function(e){var t=new(0,ace.require("ace/keyboard/hash_handler").HashHandler);t.addCommand({name:"nav_down.",bindKey:{win:"Down",mac:"Down"},exec:function(e){return s.keydown({keyCode:40}),!1},readOnly:!0}),t.addCommand({name:"nav_up.",bindKey:{win:"Up",mac:"Up"},exec:function(e){return s.keydown({keyCode:38}),!1},readOnly:!0}),t.addCommand({name:"nav_enter.",bindKey:{win:"Enter",mac:"Enter"},exec:function(e){return s.keydown({keyCode:13,editor:e}),!1},readOnly:!0}),e.keyBinding.addKeyboardHandler(t)},onChange:function(e){i=e[1].getValue(),/.+\n.+/.test(i)&&e[1].setValue(i.replace(/\r?\n/g," ")),l&&(e[1].navigateLineEnd(),l=!1)}},a.ace),this.getMessages=function(){return t.messages[e.Game.player]},this.sendCommand=function(){(i=i.replace(/\n/,""))&&(o.trigger("sendConsole",{command:i}),t.sendCommand(i,e.Game.player),u.push(i),s.command="",c=null)},this.keydown=function(t){if(13==t.keyCode&&(s.sendCommand(),t.editor.setValue("")),38==t.keyCode){if(!(o=_.cloneDeep(u)).length)return;c<-o.length&&(c=-o.length),null===c&&(c=-1),s.command=o.splice(c,1)[0],l=!0,c--}if(40==t.keyCode){var o;if(!(o=_.cloneDeep(u)).length)return;if(null===c)return;if(++c>=0)return c=null,void(s.command="");s.command=o.splice(c,1)[0],l=!0}40!=t.keyCode&&38!=t.keyCode||n(function(){return e.$broadcast("consoleHistorySwitched")},10)},this.clear=function(){for(var e in t.messages)t.messages[e]=[]},this.isEnabled=function(){return t.enabled},this.toggleEnabled=function(){return t.enabled=!t.enabled}}]),mod.factory("Console",["$rootScope","Connection","AppInstanceId","LocalStorage","$routeParams","Auth",function(e,t,o,r,n,a){var i={messages:{0:[],1:[],2:[],3:[]},enabled:!0};e.$watch(function(){return a.Me&&a.Me._id},function(e){e&&(i.messages[e]=[])});var s=100,c=[!1,!1,!1];function u(e){if(i.messages[e.userId]||(i.messages[e.userId]=[]),i.enabled){if(e.error)i.messages[e.userId].push({date:new Date,shard:e.shard,text:e.error.replace(/\n/g,"<br>"),error:!0});else{var t=_.map(e.messages.log,function(t){return new Object({date:new Date,shard:e.shard,text:t.replace(/\n/g,"<br>")})}),o=_.map(e.messages.results,function(t){return new Object({date:new Date,shard:e.shard,text:t.replace(/\n/g,"<br>"),in:!0})});i.messages[e.userId]=i.messages[e.userId].concat(t,o)}i.messages[e.userId].length>s&&(i.messages[e.userId]=i.messages[e.userId].slice(-s)),c[e.userId]=!!e.error}}t.onConsoleUpdate(function(e){u(e),l(e)}),i.sendCommand=function(e,o){n.app_instance_id?i.checkAppInstanceId()&&(i.messages[o].push({text:e,out:!0}),r.put("console.send",{text:e,userId:o})):(i.messages[o].push({text:e,out:!0}),t.sendConsoleCommand(e,o),l())},i.hasError=function(e){return i.enabled&&c[e]},i.checkAppInstanceId=function(){var e=r.get("editor-popup",{}).appInstanceId;return e&&(e==n.app_instance_id||e==o)};var l=function(e){i.checkAppInstanceId()&&r.put("console.newData",e)},p=function(e){e&&i.checkAppInstanceId()&&u(e)};return e.$watch(function(){return n.app_instance_id},function(e){e&&p(r.get("console.newData"))}),r.onChange(e,"console.newData",p),r.onChange(e,"console.error",function(e){i.checkAppInstanceId()&&(c=e)}),r.onChange(e,"console.send",function(e){e&&i.checkAppInstanceId()&&(i.sendCommand(e.text,e.userId),r.put("console.send",null))}),i}]),(mod=angular.module("app.game.editor-panel",[])).config(["$locationProvider","SocketProvider","$routeProvider","$routeSegmentProvider",function(e,t,o,r){r.when("/editor-popup/:app_instance_id","editor-popup").segment("editor-popup",{templateUrl:"components/game/editor-panel/editor-panel.html?bust=1561537540072",resolve:{auth:ngInject(["Auth","$injector","LocalStorage","Api","$q","$routeParams",function(e,t,o,r,n,a){var i={};return a.urlData&&(i=JSON.parse(atob(a.urlData)),o.prefix=i.localStoragePrefix,_.extend(r.options,i.apiOptions),e.useNativeAuth=i.authUseNativeAuth),e.check().catch(angular.noop).then(function(e){return window.nw&&t.get("NwLocalFileSync").init(),e})}])}})}]),mod.controller("EditorPanel",["$rootScope","$routeParams","$scope","Tutorial","Console","AppInstanceId","LocalStorage","Connection","NwLocalFileSync","Api",function(e,t,o,r,n,a,i,s,c,u){var l=this;if(t.app_instance_id){o.Game={popped:!0,simulationMode:!!+t.sim};var p=function(e){var r=e;l.popupEnabled=r&&r.appInstanceId==t.app_instance_id,l.popupEnabled&&(o.Game.player=r.player)};p(i.get("editor-popup")),i.onChange(o,"editor-popup",p),s.setRunningLocal(!0)}this.activeTab=void 0,this.consoleClick=function(){r.trigger("consoleClick"),o.$broadcast("consoleTabSelect")},this.memoryClick=function(){o.$broadcast("memory update"),o.$broadcast("memoryTabSelect")},this.scriptClick=function(){r.trigger("scriptClick"),o.$broadcast("scriptTabSelect")},this.hasConsoleError=function(){return n.hasError(o.Game.player)},this.isPopupSynced=function(){return!n.checkAppInstanceId()},o.$on("addMemoryWatch",function(){l.activeTab="memory"})}]),mod.directive("appResizePanel",["LocalStorage","$timeout","$document",function(e,t,o){return{controller:["$element","$scope",function(r,n){var a=this,i=!1;this.setHeight=function(t,o){t<80&&(t=80),$(r).find(".editor-panel").height(t),$(r).find("section.room").css("bottom",t+"px"),o||n.$broadcast("resize",{sameSize:!0}),e.put("game.editor.height",t)},this.getHeight=function(){return $(r).find(".editor-panel").height()},this.toggle=function(t){i=_.isUndefined(t)?!i:t,e.put("game.editor.hidden",i),i?($(r).find(".editor-panel").height(31),$(r).find("section.room").css("bottom","31px"),n.$broadcast("resize",{sameSize:!0})):a.setHeight(e.get("game.editor.height",250))},this.isHidden=function(){return i};!function o(){$(r).find(".editor-panel").length&&$(r).find("section.room").length?((i=e.get("game.editor.hidden",!0))?a.toggle(!0):a.setHeight(e.get("game.editor.height",250),!0),n.$broadcast("resize",{sameSize:!0})):t(o,10)}(),$(o).keydown(function(e){13==e.keyCode&&e.altKey&&n.$apply(function(){a.toggle()})})}]}}]),mod.directive("appResizePanelHandle",["$document",function(e){return{require:"^?appResizePanel",link:function(t,o,r,n){var a,i=!1;$(o).mousedown(function(e){return t.$apply(function(){i=e.clientY,a=n.getHeight()}),!1}),$(e).on("mouseup mousemove",function(e){return!1===i||(e.clientY<150||(t.$apply(function(){n.setHeight(i-e.clientY+a),n.toggle(!1)}),!1))}),$(e).mouseup(function(){t.$apply(function(){return i=!1})})}}}]),mod.directive("appResizePanelToggle",function(){return{require:"^?appResizePanel",link:function(e,t,o,r){$(t).click(function(){e.$apply(function(){r.toggle()})}),e.$watch(function(){return r.isHidden()},function(e){o[e?"$addClass":"$removeClass"]("minimized")})}}}),mod.directive("appResizePanelOpen",function(){return{require:"^?appResizePanel",link:function(e,t,o,r){$(t).click(function(){e.$apply(function(){r&&r.isHidden()&&r.toggle(!1)})})}}}),mod.directive("appPopupPanel",["AppInstanceId","LocalStorage","$window","Api","Auth",function(e,t,o,r,n){return{require:"^?appResizePanel",link:function(a,i,s,c){i.click(function(){a.$apply(function(){t.put("editor-popup",{player:a.Game.player,appInstanceId:e});var i=btoa(JSON.stringify({localStoragePrefix:t.prefix,apiOptions:_.pick(r.options,["apiUrl","host","official","password","port"]),authUseNativeAuth:n.useNativeAuth}));i=encodeURIComponent(i);var s=window.location.href.replace(window.location.hash,"")+"#!/editor-popup/"+e+"?sim="+ +!!a.Game.simulationMode+"&urlData="+i,u=$(window).width()-100,l=$(window).height()/2,p="screeps-editor-popup",m=0,d=0;p||(p="MyWindow"),u||(u=600),l||(l=600),void 0!==window.screenLeft?(m=window.screenLeft,d=window.screenTop):void 0!==window.screenX&&(m=window.screenX,d=window.screenY);var h={toolbar:"no",location:"no",directories:"no",left:m+($(window).width()-u)/2,top:d+($(window).height()-l),status:"no",menubar:"no",scrollbars:"yes",resizable:"no",width:u,height:l},f=[];for(var g in h)f.push(g+"="+h[g]);var v=f.join(",");o.open(s,p,v).focus(),c.toggle(!0)})})}}}]),(mod=angular.module("app.game.memory",[])).controller("Top.Game.Memory",["MemoryStorage","LocalStorage","$scope","$routeParams","AppInstanceId","Connection","Auth",function(e,t,o,r,n,a,i){var s=this;this.active="main",this.switchTo=function(e){s.active=e}}]),mod.controller("Top.Game.Memory.Main",["MemoryStorage","LocalStorage","$scope","$routeParams","AppInstanceId","Connection","Auth",function(e,t,o,r,n,a,i){var s=this;this.newWatchPath="",this.watches=t.get("memory.watches",[]),this.watches.length&&!this.watches[0].path||this.watches.unshift({path:""}),this.addWatch=function(e){e&&(s.watches.push({path:e}),s.watches=_.uniq(s.watches,"path"),t.put("memory.watches",s.watches))},this.removeWatch=function(e){_.remove(s.watches,{path:e}),t.put("memory.watches",s.watches)},this.submitNewWatch=function(){s.addWatch(s.newWatchPath),s.newWatchPath=""},this.orderBy=function(e){return e.path==s.selectedObjectWatch?-1:e.path},o.$on("roomObjectSelected",function(e,t){s.selectedObjectWatch&&s.removeWatch(s.selectedObjectWatch),s.selectedObjectWatch=null,t&&("flag"==t.type||i.Me&&t.user==i.Me._id||0==t.user&&(!i.Me||i.Me==o.Game.player))&&("spawn"==t.type&&(s.selectedObjectWatch="spawns."+t.name),"creep"==t.type&&(s.selectedObjectWatch="creeps."+t.name),"powerCreep"==t.type&&(s.selectedObjectWatch="powerCreeps."+t.name),"flag"==t.type&&(s.selectedObjectWatch="flags."+t.name)),s.selectedObjectWatch&&s.addWatch(s.selectedObjectWatch)}),t.onChange(o,"memory.watches",function(e){s.watches=e})}]),mod.controller("Top.Game.Memory.Main.MemoryWatch",["$scope","Connection","$timeout","$q","LocalStorage","$routeParams","AppInstanceId","Dialogs",function(e,t,o,r,n,a,i,s){var c=this;function u(){return a.app_instance_id?n.sendMessage(e,"memory.getMemoryByPath:"+e.watch.path,{}):t.getMemoryByPath(e.Game.player,e.watch.path)}function l(o){return a.app_instance_id?n.sendMessage(e,"memory.setMemoryByPath:"+e.watch.path,o):t.setMemoryByPath(e.Game.player,e.watch.path,o)}this.editing=null,this.editor={},this.loading=!1,this.getMemory=function(){if("Incorrect memory path"!=c.value)return c.loading=!0,u().then(function(e){e||(e=""+e)||(e="undefined"),c.editingSize=JSON.stringify(e).length/1024,o(function(){return c.editing=e},10)}).finally(function(){return c.loading=!1})},this.reload=function(){return u().then(function(e){c.editor.set(e)})},this.save=function(){var t=c.editor.get(),o=r.when();return e.watch.path||(o=s.ask({message:"You are going to rewrite the entire Memory tree. Doing so is not recommended and could result in replacing some of your variables that are already changed with an obsolete state. It is better to create a watch for a specific sub-tree and commit it instead.<br><br>Do you really want to proceed?"}).result),o.then(function(){return l(t)}).then(function(){c.value=""+t,c.editing=null,c.removeFirstTry=!1})},this.remove=function(){return c.removeFirstTry?l(void 0).then(function(){e.Memory.removeWatch(e.watch.path)}):(c.removeFirstTry=!0,r.when())},this.cancel=function(){c.editing=null,c.removeFirstTry=!1},this.getLastPathPart=function(){return e.watch.path?e.watch.path.split(/\./).pop():"Memory"},a.app_instance_id?e.watch.path&&n.onChange(e,"memory.sendWatch:"+e.watch.path,function(e){e&&n.checkAppInstanceId()&&(c.value=e)}):(e.watch.path&&t.onMemoryUpdate(e,e.Game.player,e.watch.path,function(t){c.value=t,n.checkAppInstanceId()&&(n.put("memory.sendWatch:"+e.watch.path,t),o(function(){return n.remove("memory.sendWatch:"+e.watch.path)},100))}),n.listenMessage(e,"memory.getMemoryByPath:"+e.watch.path,u),n.listenMessage(e,"memory.setMemoryByPath:"+e.watch.path,l)),e.$on("addMemoryWatch",function(t,o){e.watch.path==o&&c.getMemory()})}]),mod.controller("Top.Game.Memory.Segments",["$scope","Connection","$timeout","$q","LocalStorage","$routeParams","AppInstanceId","Dialogs",function(e,t,o,r,n,a,i,s){var c=this;this.segmentsList=_.range(0,100),this.activeSegment=null,this.activeSegmentContent=null,this.dirty=!1,this.onChange=function(){if(c.dirty=!1,null!==c.activeSegment){c.loading=!0;var o=c.activeSegment;(a.app_instance_id?n.sendMessage(e,"memory.getSegment",c.activeSegment):t.getMemorySegment(e.Game.player,c.activeSegment)).then(function(e){c.activeSegment==o&&(c.activeSegmentContent=e)}).finally(function(){return c.loading=!1})}},this.save=function(){return(a.app_instance_id?n.sendMessage(e,"memory.setSegment",{segment:c.activeSegment,data:c.activeSegmentContent}):t.setMemorySegment(e.Game.player,c.activeSegment,c.activeSegmentContent)).then(function(){return c.dirty=!1}).catch(function(e){"length limit exceeded"&&s.alert("","Data length has exceeded 100 KB limit.")})},a.app_instance_id||(n.listenMessage(e,"memory.getSegment",function(o){return t.getMemorySegment(e.Game.player,o)}),n.listenMessage(e,"memory.setSegment",function(o){return t.setMemorySegment(e.Game.player,o.segment,o.data)}))}]),(mod=angular.module("app.game.script.dlg-clone-branch",[])).controller("DlgCloneBranch",["$scope","Api","data","$modalInstance","CodeBranches","NwLocalFileSync",function(e,t,o,r,n,a){var i=this;this.newName="",this.error="",this.branchesList=[],n.loadBranches().then(function(e){return i.branchesList=e}),this.onChange=function(){i.error=_.any(i.branchesList,{branch:i.newName})?"A branch with this name already exists and will be overwritten!":""},this.submit=function(){n.cloneBranch(o.branch,i.newName).then(function(e){a.cloneBranch(o.branch,i.newName,e),r.close(i.newName)}).catch(function(e){i.error="Unknown error"})}}]);var _slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var o=[],r=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(o.push(i.value),!t||o.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}return o}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();(mod=angular.module("app.game.script",[])).controller("Top.Game.Script",["$scope","MemoryStorage","LocalStorage","$q","Tutorial","Api","Auth","Socket","Loader","$routeParams","Dialogs","$modal","CodeBranches","NwLocalFileSync",function(e,t,o,r,n,a,i,s,c,u,l,p,m,d){var h=this;this.activeModule="main",this.dirty=!1,this.branch=null,this.binaryFile=null,this.activeName=e.Game.simulationMode?"activeSim":"activeWorld";this.reset=function(){var o=t.get("users.code."+h.activeName),r=_.find(o,function(t){return t._id==e.Game.player});r&&(h.modules=_.cloneDeep(r.modules),h.dirty=!1,h.modules[h.activeModule]||(h.activeModule="main"))},o.onChange(e,"users.code."+this.activeName,function(e){t.put("users.code."+h.activeName,e),h.reset()}),o.onChange(e,"users.code.submit",function(e){e&&(c.loading(m.submitCode(e.branch,e.modules).then(function(t){return d.writeBranch(e.branch,e.modules,t)})),o.remove("users.code.submit"))}),o.onChange(e,"branches."+this.activeName,function(e){m.setActiveBranch(h.activeName,e)}),this.submit=function(){var r=t.get("users.code."+h.activeName),a=_.cloneDeep(h.modules),s=_.find(r,function(t){return t._id==e.Game.player});s||(s={_id:e.Game.player},r.push(s)),s.modules=a,s.timestamp=Date.now(),t.put("users.code."+h.activeName,r),o.put("users.code."+h.activeName,r),n.trigger("submitScript",{modules:a}),u.app_instance_id||i.Me&&e.Game.player!=i.Me._id?o.put("users.code.submit",{branch:h.branch,modules:a}):c.loading(m.submitCode(h.branch,a).then(function(e){return d.writeBranch(h.branch,a,e)})),h.dirty=!1},this.filterNotMain=function(e){return(_.isString(h.modules[e])||_.isObject(h.modules[e])&&void 0!==h.modules[e].binary)&&"main"!=e},this.removeModule=function(e){delete h.modules[e],h.modules[e]=null,h.activeModule==e&&(h.activeModule="main"),h.dirty=!0},this.switchToBranches=function(){f().then(function(){return h.branchesMode=!0})},this.switchToModules=function(){h.branchesMode=!1},this.cloneBranch=function(e){if(!(h.branchesList.length>=30))return p.open({templateUrl:"components/game/editor-panel/script/dlg-clone-branch/dlg-clone-branch.html?bust=1561537540072",controller:"DlgCloneBranch as DlgCloneBranch",resolve:{data:function(){return new Object({branch:e})}}}).result.then(f);l.alert("","You cannot create more than 30 branches. Please remove some existing branches to clone this branch.")},this.deleteBranch=function(e){return l.ask({message:"This action cannot be undone! Are you sure?",buttonClass:"md-warn md-hue-2",buttonLabel:"Delete"}).result.then(function(){return m.deleteBranch(e)}).then(function(t){return d.deleteBranch(e,t),f()})},this.selectBranch=function(e){var t=r.when();h.dirty&&(t=l.ask("","You have unsaved changes in your current branch! It will be lost if you switch to another branch. Proceed?").result),t.then(function(){return m.setActiveBranch(h.activeName,e)}).then(function(){return h.switchToModules()})},this.openLocalFolder=function(){l.alert("",{html:"Navigate to this folder in order to edit scripts in your own IDE:<br><pre>"+(d.dataPath+d.sep+h.branch)+"</pre>"}),nw.Shell.showItemInFolder(d.dataPath+d.sep+h.branch+d.sep+h.activeModule+".js")},this.onBinaryFileChange=function(){var e=h.activeModule,t=new FileReader;t.onload=function(o){if(t.readyState===FileReader.DONE){var r=t.result.split(","),n=_slicedToArray(r,2)[1];h.modules[e]={binary:n},h.dirty=!0}},t.readAsDataURL(h.binaryFile[0])};var f=function(){return c.loading(m.loadBranches().then(function(e){return h.branchesList=e}))},g=function(t){return c.loading(m.loadModulesByActiveName(h.activeName).then(function(o){(0==e.Game.player||i.Me&&e.Game.player==i.Me._id)&&(h.branch=o.branch,v(o.modules,t))}))},v=function(r,n){var a=o.get("users.code."+h.activeName,[]),i=_.find(a,{_id:e.Game.player});i||(i={_id:e.Game.player},a.push(i)),i.modules=r,n&&(i.timestamp=Date.now()),o.put("users.code."+h.activeName,a),"activeSim"!=h.activeName||_.any(a,{_id:"1"})||a.push({_id:"1",modules:{main:""}}),t.put("users.code."+h.activeName,a),h.reset()};i.Me||(m.userId=e.Game.player,m.init(this.activeName)),e.$watch(function(){return e.Game.player},function(){i.Me||(m.userId=e.Game.player),h.reset()}),g(),m.registerActiveBranchCallback(e,this.activeName,function(){g(!0)}),m.registerCodeCallback(e,function(e){e.branch==h.branch&&v(e.modules,!0)})}]),mod.controller("Top.Game.Script.AddModuleForm",["$scope",function(e){var t=this;this.newModuleName="",this.moduleNameValidator={notMain:function(e){return!/^main$/i.test(e)},unique:function(t){return _.isObject(e.Script.modules)&&(_.isUndefined(e.Script.modules[t])||null===e.Script.modules[t])},slash:function(e){return!/[\\/]/.test(e)}},this.addNewModule=function(o){t.newModuleName&&e.addForm.$valid&&(e.Script.modules[t.newModuleName]=o?{binary:""}:"/*\n * Module code goes here. Use 'module.exports' to export things:\n * module.exports.thing = 'a thing';\n *\n * You can import it from another modules like this:\n * var mod = require('"+t.newModuleName+"');\n * mod.thing == 'a thing'; // true\n */\n\nmodule.exports = {\n\n};",e.Script.activeModule=t.newModuleName,t.newModuleName="",e.Script.dirty=!0)}}]);_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var o=[],r=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(o.push(i.value),!t||o.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}return o}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();(mod=angular.module("app.game",[])).config(["$routeSegmentProvider","$routeProvider",function(e,t){e.when("/sim/survival","top.sim-survival").within("top").segment("sim-survival",{templateUrl:"components/game/game.html?bust=1561537540072",controller:"Top.SimGame as Game"}),e.when("/sim/tutorial/:section","top.sim-tutorial").within("top").segment("sim-tutorial",{templateUrl:"components/game/game.html?bust=1561537540072",controller:"Top.SimGame as Game",dependencies:["section"]}),e.when("/sim/custom","top.sim-custom").within("top").segment("sim-custom",{templateUrl:"components/game/game.html?bust=1561537540072",controller:"Top.SimGame as Game"}),e.when("/history/:shard/:room","top.game-room-history").within("top").segment("game-room-history",{templateUrl:"components/game/game.html?bust=1561537540072",controller:"Top.SimGame as Game"}),e.when("/room/:room","top.game-room-no-shard").within("top").segment("game-room-no-shard",{resolve:{data:ngInject(["$q","$location","$routeParams","$routeSegment",function(e,t,o,r){return t.url(r.getSegmentUrl("top.game-room",{room:o.room,shard:"shard0"})),e.defer().promise}])}}),e.when("/room/:shard/:room","top.game-room").within("top").segment("game-room",{templateUrl:"components/game/game.html?bust=1561537540072",controller:"Top.RoomGame as Game",resolve:{data:ngInject(["RoomGameLoader",function(e){return e.load()}])}})}]),mod.controller("Top.SimGame",["$scope","Console","Connection","MemoryStorage","Tutorial","Constants","StaticMaps","$q","$http","LocalStorage","$location","Api","AppInstanceId","$routeSegment","$document","Loader","Auth","$routeParams","$timeout","CodeBranches","TutorialCode","NwLocalFileSync",function(e,t,o,r,n,a,i,s,c,u,l,p,m,d,h,f,g,v,y,b,w,S){var M=this;this.player="0",g.Me&&(this.player=g.Me._id),this.playing=!1,this.speed=100,this.survivalScore=null,this.historyChunkSize=p.options.serverData.historyChunkSize,o.setRunningLocal(!0),o.setTickPeriod(1e5/this.speed),this.play=function(){o.run(),M.playing=!0,M.playDisabled=!1},this.pause=function(){o.terminate(),M.playing=!1},this.maxSpeed="top.game-room-history"==d.name?2e3:500,this.incSpeed=function(){M.speed+=M.speed<100?50:M.speed<600?100:M.speed<1e3?200:500,M.speed>M.maxSpeed&&(M.speed=M.maxSpeed),o.setTickPeriod(1e5/M.speed),M.playing&&(o.terminate(),o.run())},this.decSpeed=function(){M.speed-=M.speed>1e3?500:M.speed>600?200:M.speed>100?100:50,M.speed<50&&(M.speed=50),o.setTickPeriod(1e5/M.speed),M.playing&&(o.terminate(),o.run())},this.setSimulationMode=function(t){M.simulationMode=t;var a=[{_id:"0",username:"Player 1"},{_id:"1",username:"Player 2"},{_id:"2",username:"Invader"},{_id:"3",username:"Source Keeper"}],s=[{_id:"0",memory:JSON.stringify({creeps:{},spawns:{},rooms:{},flags:{}})},{_id:"1",memory:JSON.stringify({creeps:{},spawns:{},rooms:{},flags:{}})},{_id:"2",memory:JSON.stringify({creeps:{},spawns:{},rooms:{},flags:{}})},{_id:"3",memory:JSON.stringify({creeps:{},spawns:{},rooms:{},flags:{}})}],c=[{_id:"0",segments:{}},{_id:"1",segments:{}},{_id:"2",segments:{}},{_id:"3",segments:{}}];if(g.Me&&(a[0]._id=g.Me._id,a[0].username=g.Me.username,s[0]._id=g.Me._id,c[0]._id=g.Me._id),r.put("users",a),r.put("users.memory",s),r.put("users.memory.segments",c),"tutorial"==t){b.userId=M.player;var u="tutorial-"+d.$routeParams.section,l=w["section"+d.$routeParams.section];b.cloneBranch(void 0,u,l).then(function(e){return S.writeBranch(u,l,e)}).then(function(){return b.setActiveBranch("activeSim",u)}).then(function(){return i.get("tutorial/"+d.$routeParams.section)}).then(function(t){var a=t.objects;_.find(a,{type:"controller"}).user=e.Game.player,_.find(a,{type:"spawn"}).user=e.Game.player,_.filter(a,{type:"creep"}).forEach(function(t){return t.user=/invader/.test(t.name)?"2":e.Game.player}),_.filter(a,{type:"constructionSite"}).forEach(function(t){return t.user=e.Game.player}),_.filter(a,{type:"extension"}).forEach(function(t){return t.user=e.Game.player}),n.start(),r.put("rooms.objects",a),r.put("rooms.flags",[]),r.put("rooms.terrain",t.terrain),r.put("gametime",0),r.put("gameinfo",{}),o.initReplay(null),M.play(),e.$on("$destroy",function(){return n.resetStep()})})}else if("survival"==t){e.Game.survivalMap=null,i.get("survival").then(function(t){e.Game.survivalMap="survival",e.Game.playDisabled=!0,e.Game.readOnly=!1,r.put("rooms.objects",t.objects),r.put("rooms.flags",[]),r.put("rooms.terrain",t.terrain),r.put("gametime",0),r.put("gameinfo",{mode:"survival",status:"active",user:e.Game.player,score:0,timeToWave:200,wave:1,survivalEnabled:!0,invaders:{bodies:[]}}),r.put("replay",{current:[],log:{}}),o.initReplay(null),n.trigger("survivalModeStarted")})}else"custom"==t&&(r.put("rooms.terrain",[]),i.get("custom").then(function(t){_.find(t.objects,{type:"controller"}).user=e.Game.player,r.put("rooms.objects",t.objects),r.put("rooms.flags",[]),r.put("rooms.terrain",t.terrain),r.put("gametime",0),r.put("gameinfo",{}),o.initReplay(null),M.play(),n.trigger("customModeStarted")}))},this.clearGame=function(){M.survivalScore=null,M.simulationMode=null,M.survivalMap=null,M.replayLoaded=null,l.url("/")},this.playSurvivalAgain=function(){M.survivalMap&&(M.survivalScore=null,M.setSimulationMode("survival"))},this.saveSurvivalScore=function(e){if(M.survivalScore=e,M.pause(),M.speed=100,o.setTickPeriod(1e5/M.speed),d.$routeParams.replay)M.survivalReplayUploaded={_id:d.$routeParams.replay,secret:l.search().s};else{M.survivalReplayUploaded=!1;var t=r.get("replay");p.post("replays/add",{map:M.survivalMap,score:e,v:"1561537540072",log:pako.gzip(JSON.stringify(t.log),{level:9,to:"string"})}).then(function(e){return M.survivalReplayUploaded=e}).catch(function(){return M.survivalReplayUploaded="error"})}},this.goToIndex=function(){l.url("/sim")},this.loadReplay=function(){"top.game-room-history"==d.name&&p.get("game/time",{shard:v.shard}).then(function(t){M.historyMaxGameTime=Math.floor((t.time-50)/p.options.serverData.historyChunkSize)*p.options.serverData.historyChunkSize-1,M.historyMinGameTime=Math.floor((t.time-15e4)/p.options.serverData.historyChunkSize)*p.options.serverData.historyChunkSize,M.survivalScore=null,M.replayLoaded=!0,M.readOnly=!0,M.simulationMode="history",M.speed=500,o.setTickPeriod(1e5/M.speed),o.initReplay({},e)})},this.exitHistory=function(){l.url(d.getSegmentUrl("top.game-room"))},this.rewindHistory=function(e){l.replace(),l.search("t",parseInt(v.t)+e)},this.historyTickValue=0;var $=_.debounce(function(){l.replace(),l.search("t",M.historyTickValue*p.options.serverData.historyChunkSize)},200);this.historyTickChange=function(){M.pause(),$()},e.$watch(function(){return v.t},function(e){return M.historyTickValue=Math.floor(parseInt(e)/p.options.serverData.historyChunkSize)}),e.$on("gameSimulationReset",function(){return M.simulationReset()}),e.$on("$destroy",function(){r.remove("rooms.objects"),r.remove("rooms.flags"),r.remove("rooms.terrain")}),e.$watch(function(){return M.player},function(e){u.get("editor-popup",{}).appInstanceId==m&&u.put("editor-popup",{player:M.player,appInstanceId:m})}),y(500).then(function(){"top.game-room-history"==d.name&&M.loadReplay(),"top.sim-survival"==d.name&&(M.setSimulationMode("survival"),mixpanel.track("Start mode: survival")),"top.sim-custom"==d.name&&(M.setSimulationMode("custom"),mixpanel.track("Start mode: custom")),"top.sim-tutorial"==d.name&&M.setSimulationMode("tutorial")}),h.bindToScope(e,"keydown",function(t){e.Top.hideUi&&(120==t.keyCode&&t.ctrlKey&&M.play(),121==t.keyCode&&t.ctrlKey&&M.pause())})}]),mod.controller("Top.Game.ChooseMap",["$scope","StaticMaps","MemoryStorage","Connection","Tutorial",function(e,t,o,r,n){}]),mod.factory("RoomGameLoader",["Loader","Api","$routeParams","$q",function(e,t,o,r){return e.factory(function(){var e=o.room.match(/^survival_(.*)$/);return{game:e?t.get("survival/game",{id:e[1]}).catch(function(){return null}):r.when(!1)}})}]),mod.controller("Top.RoomGame",["$scope","Auth","Connection","Socket","$routeSegment","$location","Api","$interval","data","$modal","Dialogs","LocalStorage","ArenaActivator","Tutorial","$routeParams","WorldRespawnChecker",function(e,t,o,r,n,a,i,s,c,u,l,p,m,d,h,f){var g=this;t.required(e),this.readOnly=!0,e.$watch(function(){return h.room},function(){g.survivalScore=null,g.arenaFinishScore=null,g.roomError=!1}),this.player=t.Me._id,o.setRunningLocal(!1),o.listenSocket(e),this.play=angular.noop,this.pause=angular.noop,this.speed=i.options.official?50:100,this.saveSurvivalScore=function(e){g.survivalScore=e,g.survivalReplayUploaded=!1;var t=h.room.match(/^survival_(.*)$/),o=_slicedToArray(t,2),r=(o[0],o[1]),n=function(){i.get("survival/replay",{game:r}).then(function(e){e.uploaded&&(a&&s.cancel(a),g.survivalReplayUploaded=e)})},a=s(n,1e3);n()},this.clearGame=function(){a.url("/g")},this.playSurvivalAgain=function(){return i.post("survival/create").then(function(e){a.url("/room/"+e.roomName)})},this.playArenaAgain=function(){return i.get("arena/find-init-room").then(function(e){a.url(n.getSegmentUrl("top.game-room",{room:e.room}))})},this.isSubscribeError=function(){return o.roomSubscribeError},c.game&&"finished"==c.game.status&&this.saveSurvivalScore(c.game.score),h.room.match(/^arena/)&&(this.arena={rooms:[["arena11","arena21","arena31"],["arena12","arena22","arena32"],["arena13","arena23","arena33"]]},t.Me&&i.get("arena/status").then(function(e){"not active"==e.status&&u.open({templateUrl:"components/game/dlg-tip-arena.html?bust=1561537540072",controller:l.Ctrl}).result.then(function(){return m.run(!0)})})),f.bind(e)}]),(mod=angular.module("app.game.lobby.arena",[])).config(["$routeSegmentProvider",function(e){e.when("/g/arena","top.game-lobby-arena-no-season").when("/g/arena/:season","top.game-lobby-arena.list").within("top").segment("game-lobby-arena-no-season",{resolve:{data:ngInject(["Api","$location","$routeSegment",function(e,t,o){return e.get("leaderboard/seasons",{mode:"arena"}).then(function(e){t.replace(),t.url(o.getSegmentUrl("top.game-lobby-arena.list",{season:e.seasons[0]._id}))})}])}}).segment("game-lobby-arena",{templateUrl:"components/game/lobby/arena/lobby-arena.html?bust=1561537540072",controller:"Top.LobbyArena as LobbyArena",dependencies:["season"],resolve:{data:ngInject(["LobbyArenaLoader",function(e){return e.load()}])}}).within().segment("list",{controller:"Top.LobbyArena.LeaderboardList as LeaderboardList",dependencies:["page"],resolve:{data:ngInject(["ArenaLeaderboardListLoader",function(e){return e.load()}])}})}]),mod.factory("LobbyArenaLoader",["Loader","Api","Auth","$routeParams","$location","$q","$timeout",function(e,t,o,r,n,a,i){return e.factory(function(){return o.Me&&_.isUndefined(r.page)&&i(angular.noop,10).then(function(){return t.get("leaderboard/find",{mode:"arena",season:r.season,username:o.Me.username})}).then(function(e){n.replace(),n.search("page",Math.floor(e.rank/10)+1),n.search("highlight",o.Me.username)}).catch(function(){n.replace(),n.search("page",1)}),{seasons:t.get("leaderboard/seasons").then(function(e){return e.seasons}),gameId:o.Me?t.get("survival/active-game").then(function(e){if(e)return e.gameId}).catch(function(e){return null}):a.when(),myResult:o.Me?t.get("leaderboard/find",{mode:"arena",season:r.season,username:o.Me.username}).catch(function(){return null}):a.when()}})}]),mod.controller("Top.LobbyArena",["$scope","Auth","Api","$location","data","$routeParams","$routeSegment","Loader","$q","Tutorial",function(e,t,o,r,n,a,i,s,c,u){var l=this;this.search="",this.myResult=n.myResult,this.seasonsList=n.seasons,this.season=_.find(this.seasonsList,{_id:i.$routeParams.season}),this.myResult&&(this.myResult.page=Math.floor(this.myResult.rank/10)+1),this.start=function(){if(!t.Me||t.Me.email)return o.get("arena/find-init-room").then(function(e){r.url(i.getSegmentUrl("top.game-room",{room:e.room}))});r.url(i.getSegmentUrl("top.register-confirm"))},this.submitSearch=function(){var e=l.search;return!e||e.length<5?c.reject():s.loading(o.get("leaderboard/find",{mode:"arena",season:l.season._id,username:e}).then(function(t){r.search("highlight",e),r.search("page",Math.floor(t.rank/10)+1)}))},e.$watch(function(){return i.$routeParams.page},function(e){e||(r.replace(),r.search("page",1))}),u.trigger("gameLobby")}]),mod.factory("ArenaLeaderboardListLoader",["Loader","Api","Auth","$routeParams",function(e,t,o,r){return e.factory(function(){return new Object({listData:t.get("leaderboard/list",{mode:"arena",season:r.season,offset:10*(r.page-1),limit:10})})})}]),mod.controller("Top.LobbyArena.LeaderboardList",["$scope","Api","data","$routeParams","$location","$routeSegment",function(e,t,o,r,n,a){var i=this;this.list=o.listData.list,this.users=o.listData.users,this.count=o.listData.count;var s=this.pageSize=10;this.pages=[];for(var c=Math.max(0,r.page-1-2);c<=Math.min(Math.floor((this.count-1)/s),r.page-1+2);c++)this.pages.push({num:c+1,active:c==r.page-1});this.startPage=r.page>1&&1,this.endPage=r.page<Math.floor(this.count/s)&&Math.floor((this.count-1)/s)+1,this.prevPage=r.page>1&&parseInt(r.page)-1,this.nextPage=r.page<Math.floor(this.count/s)&&parseInt(r.page)+1,e.$watch(function(){return r.highlight},function(e){return i.highlight=e})}]),(mod=angular.module("app.game.lobby",[])).config(["$routeSegmentProvider","$routeProvider",function(e,t){e.when("/g","top.game-lobby").within("top").segment("game-lobby",{templateUrl:"components/game/lobby/game-lobby.html?bust=1561537540072",controller:"Top.GameLobby as GameLobby",dependencies:["season"],resolve:{data:ngInject(["GameLobbyLoader",function(e){return e.load()}])}}),t.when("/g",{redirectTo:"/map"})}]),mod.factory("GameLobbyLoader",["Loader","Api","Auth","$routeParams","$location","$q",function(e,t,o,r,n,a){return e.factory(function(){var e=t.get("leaderboard/seasons").then(function(e){return e.seasons});return{seasons:e,myResults:o.Me?e.then(function(e){return a.all({survival:t.get("leaderboard/find",{mode:"survival",season:e[0]._id,username:o.Me.username}).catch(function(){return null}),arena:t.get("leaderboard/find",{mode:"arena",season:e[0]._id,username:o.Me.username}).catch(function(){return null})})}):a.when()}})}]),mod.controller("Top.GameLobby",["$scope","Auth","Api","$location","data","$routeParams","$routeSegment","Loader","$q","Dialogs","Tutorial","AccountSaveRedirector",function(e,t,o,r,n,a,i,s,c,u,l,p){t.Me&&!t.Me.badge&&(p.set("top.game-lobby"),r.url(i.getSegmentUrl("top.account-badge"))),this.myResults=n.myResults,this.seasons=n.seasons,this.disabledModeClick=function(){u.alert("In Development",{html:'This game mode is still in development.<br><a target="_blank" href="https://indiegogo.com/projects/screeps/" app-nw-external-link>Learn more&hellip;</a>'})},l.trigger("gameLobby")}]),(mod=angular.module("app.game.lobby.power",[])).config(["$routeSegmentProvider",function(e){e.when("/rank/power","top.game-lobby-power-no-season").when("/rank/power/:season","top.game-lobby-power.list").within("top").segment("game-lobby-power-no-season",{resolve:{data:ngInject(["Api","$location","$routeSegment",function(e,t,o){return e.get("leaderboard/seasons",{mode:"power"}).then(function(e){t.replace(),t.url(o.getSegmentUrl("top.game-lobby-power.list",{season:e.seasons[0]._id}))})}])}}).segment("game-lobby-power",{templateUrl:"components/game/lobby/power/lobby-power.html?bust=1561537540072",controller:"Top.LobbyPower as LobbyPower",dependencies:["season"],resolve:{data:ngInject(["LobbyPowerLoader",function(e){return e.load()}])}}).within().segment("list",{controller:"Top.LobbyPower.LeaderboardList as LeaderboardList",dependencies:["page"],resolve:{data:ngInject(["PowerLeaderboardListLoader",function(e){return e.load()}])}})}]),mod.factory("LobbyPowerLoader",["Loader","Api","Auth","$routeParams","$location","$q","$timeout",function(e,t,o,r,n,a,i){return e.factory(function(){return o.Me&&_.isUndefined(r.page)&&i(angular.noop,10).then(function(){return t.get("leaderboard/find",{mode:"power",season:r.season,username:o.Me.username})}).then(function(e){n.replace(),n.search("page",Math.floor(e.rank/10)+1),n.search("highlight",e.rank)}).catch(function(){n.replace(),n.search("page",1)}),{seasons:t.get("leaderboard/seasons").then(function(e){return e.seasons}),myResult:o.Me?t.get("leaderboard/find",{mode:"power",season:r.season,username:o.Me.username}).catch(function(){return null}):a.when()}})}]),mod.controller("Top.LobbyPower",["$scope","Auth","Api","$location","data","$routeParams","$routeSegment","Loader","$q","Tutorial",function(e,t,o,r,n,a,i,s,c,u){var l=this;this.search="",this.myResult=n.myResult,this.seasonsList=n.seasons,this.season=_.find(this.seasonsList,{_id:i.$routeParams.season}),this.myResult&&(this.myResult.page=Math.floor(this.myResult.rank/10)+1),this.submitSearch=function(){var e=l.search;return!e||e.length<5?c.reject():s.loading(o.get("leaderboard/find",{mode:"power",season:l.season._id,username:e}).then(function(e){r.search("highlight",e.rank),r.search("page",Math.floor(e.rank/10)+1)}))},e.$watch(function(){return i.$routeParams.page},function(e){e||(r.replace(),r.search("page",1))}),u.trigger("gameLobby")}]),mod.factory("PowerLeaderboardListLoader",["Loader","Api","Auth","$routeParams",function(e,t,o,r){return e.factory(function(){return new Object({listData:t.get("leaderboard/list",{mode:"power",season:r.season,offset:10*(r.page-1),limit:10})})})}]),mod.controller("Top.LobbyPower.LeaderboardList",["$scope","Api","data","$routeParams","$location","$routeSegment",function(e,t,o,r,n,a){var i=this;this.list=o.listData.list,this.users=o.listData.users,this.count=o.listData.count;var s=this.pageSize=10;this.pages=[];for(var c=Math.max(0,r.page-1-2);c<=Math.min(Math.floor((this.count-1)/s),r.page-1+2);c++)this.pages.push({num:c+1,active:c==r.page-1});this.startPage=r.page>1&&1,this.endPage=r.page<Math.floor(this.count/s)&&Math.floor((this.count-1)/s)+1,this.prevPage=r.page>1&&parseInt(r.page)-1,this.nextPage=r.page<Math.floor(this.count/s)&&parseInt(r.page)+1,e.$watch(function(){return r.highlight},function(e){return i.highlight=e})}]),(mod=angular.module("app.game.lobby.survival",[])).config(["$routeSegmentProvider",function(e){e.when("/g/survival","top.game-lobby-survival-no-season").when("/g/survival/:season","top.game-lobby-survival.list").within("top").segment("game-lobby-survival-no-season",{resolve:{data:ngInject(["Api","$location","$routeSegment",function(e,t,o){return e.get("leaderboard/seasons",{mode:"survival"}).then(function(e){t.replace(),t.url(o.getSegmentUrl("top.game-lobby-survival.list",{season:e.seasons[0]._id}))})}])}}).segment("game-lobby-survival",{templateUrl:"components/game/lobby/survival/lobby-survival.html?bust=1561537540072",controller:"Top.LobbySurvival as LobbySurvival",dependencies:["season"],resolve:{data:ngInject(["LobbySurvivalLoader",function(e){return e.load()}])}}).within().segment("list",{controller:"Top.LobbySurvival.LeaderboardList as LeaderboardList",dependencies:["page"],resolve:{data:ngInject(["SurvivalLeaderboardListLoader",function(e){return e.load()}])}})}]),mod.factory("LobbySurvivalLoader",["Loader","Api","Auth","$routeParams","$location","$q","$timeout",function(e,t,o,r,n,a,i){return e.factory(function(){return o.Me&&_.isUndefined(r.page)&&i(angular.noop,10).then(function(){return t.get("leaderboard/find",{mode:"survival",season:r.season,username:o.Me.username})}).then(function(e){n.replace(),n.search("page",Math.floor(e.rank/10)+1),n.search("highlight",o.Me.username)}).catch(function(){n.replace(),n.search("page",1)}),{seasons:t.get("leaderboard/seasons").then(function(e){return e.seasons}),gameId:o.Me?t.get("survival/active-game").then(function(e){if(e)return e.gameId}).catch(function(e){return null}):a.when(),myResult:o.Me?t.get("leaderboard/find",{mode:"survival",season:r.season,username:o.Me.username}).catch(function(){return null}):a.when()}})}]),mod.controller("Top.LobbySurvival",["$scope","Auth","Api","$location","data","$routeParams","$routeSegment","Loader","$q","Tutorial",function(e,t,o,r,n,a,i,s,c,u){var l=this;this.activeGameId=n.gameId,this.search="",this.myResult=n.myResult,this.seasonsList=n.seasons,this.season=_.find(this.seasonsList,{_id:i.$routeParams.season}),this.myResult&&(this.myResult.page=Math.floor(this.myResult.rank/10)+1),this.start=function(){if(!l.activeGameId||!t.Me)return t.Me&&!t.Me.email&&r.url(i.getSegmentUrl("top.register-confirm")),o.post("survival/create").then(function(e){r.url("/room/"+e.roomName)});r.url("/room/survival_"+l.activeGameId)},this.submitSearch=function(){var e=l.search;return!e||e.length<5?c.reject():s.loading(o.get("leaderboard/find",{mode:"survival",season:l.season._id,username:e}).then(function(t){r.search("highlight",e),r.search("page",Math.floor(t.rank/10)+1)}))},e.$watch(function(){return i.$routeParams.page},function(e){e||(r.replace(),r.search("page",1))}),u.trigger("gameLobby")}]),mod.factory("SurvivalLeaderboardListLoader",["Loader","Api","Auth","$routeParams",function(e,t,o,r){return e.factory(function(){return new Object({listData:t.get("leaderboard/list",{mode:"survival",season:r.season,offset:10*(r.page-1),limit:10})})})}]),mod.controller("Top.LobbySurvival.LeaderboardList",["$scope","Api","data","$routeParams","$location","$routeSegment",function(e,t,o,r,n,a){var i=this;this.list=o.listData.list,this.users=o.listData.users,this.count=o.listData.count;var s=this.pageSize=10;this.pages=[];for(var c=Math.max(0,r.page-1-2);c<=Math.min(Math.floor((this.count-1)/s),r.page-1+2);c++)this.pages.push({num:c+1,active:c==r.page-1});this.startPage=r.page>1&&1,this.endPage=r.page<Math.floor(this.count/s)&&Math.floor((this.count-1)/s)+1,this.prevPage=r.page>1&&parseInt(r.page)-1,this.nextPage=r.page<Math.floor(this.count/s)&&parseInt(r.page)+1,this.loadReplay=function(e){return t.get("survival/replay",{game:e.game}).then(function(e){e&&n.url(a.getSegmentUrl("top.replay",{replay:e._id})+"?s="+e.secret)})},e.$watch(function(){return r.highlight},function(e){return i.highlight=e})}]),mod.directive("appEnlargeOnClick",["$window","$timeout","$animate",function(e,t,o){return{link:function(r,n,a){var i=!1;n.click(function(){i=!i;var r=n.offset();if(i){var a=($(e).width()-386)/2,s=($(e).height()-386)/2;n.find("img").css({left:r.left+"px",top:r.top+"px"}),t(function(){n.find("img").addClass("animated"),n.find("img").css({left:a+"px",top:s+"px",width:"386px",height:"386px"}),o.removeClass(n.find(".cover"),"ng-hide")},10)}else n.find("img").css({left:r.left+"px",top:r.top+"px",width:"80px",height:"80px"}),o.addClass(n.find(".cover"),"ng-hide"),t(function(){return n.find("img").removeClass("animated")},300)})}}}]),(mod=angular.module("app.game.lobby.world",[])).config(["$routeSegmentProvider",function(e){e.when("/rank/world","top.game-lobby-world-no-season").when("/rank/world/:season","top.game-lobby-world.list").within("top").segment("game-lobby-world-no-season",{resolve:{data:ngInject(["Api","$location","$routeSegment",function(e,t,o){return e.get("leaderboard/seasons",{mode:"world"}).then(function(e){t.replace(),t.url(o.getSegmentUrl("top.game-lobby-world.list",{season:e.seasons[0]._id}))})}])}}).segment("game-lobby-world",{templateUrl:"components/game/lobby/world/lobby-world.html?bust=1561537540072",controller:"Top.LobbyWorld as LobbyWorld",dependencies:["season"],resolve:{data:ngInject(["LobbyWorldLoader",function(e){return e.load()}])}}).within().segment("list",{controller:"Top.LobbyWorld.LeaderboardList as LeaderboardList",dependencies:["page"],resolve:{data:ngInject(["WorldLeaderboardListLoader",function(e){return e.load()}])}})}]),mod.factory("LobbyWorldLoader",["Loader","Api","Auth","$routeParams","$location","$q","$timeout",function(e,t,o,r,n,a,i){return e.factory(function(){return o.Me&&_.isUndefined(r.page)&&i(angular.noop,10).then(function(){return t.get("leaderboard/find",{mode:"world",season:r.season,username:o.Me.username})}).then(function(e){n.replace(),n.search("page",Math.floor(e.rank/10)+1),n.search("highlight",e.rank)}).catch(function(){n.replace(),n.search("page",1)}),{seasons:t.get("leaderboard/seasons").then(function(e){return e.seasons}),myResult:o.Me?t.get("leaderboard/find",{mode:"world",season:r.season,username:o.Me.username}).catch(function(){return null}):a.when()}})}]),mod.controller("Top.LobbyWorld",["$scope","Auth","Api","$location","data","$routeParams","$routeSegment","Loader","$q","Tutorial",function(e,t,o,r,n,a,i,s,c,u){var l=this;this.search="",this.myResult=n.myResult,this.seasonsList=n.seasons,this.season=_.find(this.seasonsList,{_id:i.$routeParams.season}),this.myResult&&(this.myResult.page=Math.floor(this.myResult.rank/10)+1),this.submitSearch=function(){var e=l.search;return!e||e.length<5?c.reject():s.loading(o.get("leaderboard/find",{mode:"world",season:l.season._id,username:e}).then(function(e){r.search("highlight",e.rank),r.search("page",Math.floor(e.rank/10)+1)}))},e.$watch(function(){return i.$routeParams.page},function(e){e||(r.replace(),r.search("page",1))}),u.trigger("gameLobby")}]),mod.factory("WorldLeaderboardListLoader",["Loader","Api","Auth","$routeParams",function(e,t,o,r){return e.factory(function(){return new Object({listData:t.get("leaderboard/list",{mode:"world",season:r.season,offset:10*(r.page-1),limit:10})})})}]),mod.controller("Top.LobbyWorld.LeaderboardList",["$scope","Api","data","$routeParams","$location","$routeSegment",function(e,t,o,r,n,a){var i=this;this.list=o.listData.list,this.users=o.listData.users,this.count=o.listData.count;var s=this.pageSize=10;this.pages=[];for(var c=Math.max(0,r.page-1-2);c<=Math.min(Math.floor((this.count-1)/s),r.page-1+2);c++)this.pages.push({num:c+1,active:c==r.page-1});this.startPage=r.page>1&&1,this.endPage=r.page<Math.floor(this.count/s)&&Math.floor((this.count-1)/s)+1,this.prevPage=r.page>1&&parseInt(r.page)-1,this.nextPage=r.page<Math.floor(this.count/s)&&parseInt(r.page)+1,e.$watch(function(){return r.highlight},function(e){return i.highlight=e})}]);_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var o=[],r=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(o.push(i.value),!t||o.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}return o}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}(mod=angular.module("app.game.market.all-orders",[])).config(["$routeSegmentProvider",function(e){e.when("/market2/all","top.market2.all-orders-no-shard").within("top").within("market2").segment("all-orders-no-shard",{default:!0,resolve:{data:ngInject(["$q","$location","$routeParams","$routeSegment","Api",function(e,t,o,r,n){return n.get("user/world-start-room").then(function(o){var n=o.room[0].match(/^(.*)\/(.*)$/);return t.replace(),t.url(r.getSegmentUrl("top.market2.all-orders",{shard:n?n[1]:"shard0"})),e.defer().promise})}])}}),e.when("/market2/all/:shard","top.market2.all-orders").when("/market2/all/:shard/:resourceType","top.market2.all-orders-resource").within("top").within("market2").segment("all-orders",{templateUrl:"components/game/market/all-orders/market-all-orders.html?bust=1561537540072",controller:"Top.Market.AllOrders as AllOrders",dependencies:["shard"],resolve:{data:ngInject(["AllOrdersLoader",function(e){return e.load()}])}}).segment("all-orders-resource",{templateUrl:"components/game/market/all-orders/market-all-orders-resource.html?bust=1561537540072",controller:"Top.Market.ResourceOrders as ResourceOrders",dependencies:["shard","resourceType"],resolve:{data:ngInject(["ResourceOrdersLoader",function(e){return e.load()}])}})}]),mod.factory("AllOrdersLoader",["Loader","Api","Auth","$routeParams","$location","$q","$routeSegment",function(e,t,o,r,n,a,i){return e.factory(function(){return{index:t.get("game/market/orders-index",{shard:r.shard}).then(function(e){return _.indexBy(e.list,"_id")})}})}]),mod.controller("Top.Market.AllOrders",["$scope","data","Auth","ResourceTypeNames","$routeParams","$location","$routeSegment","Api",function(e,t,o,r,n,a,i,s){var c=this;o.required(),this.resources=r,this.data=t,this.shard=n.shard,this.shardsDropdownList=s.options.serverData.shards.map(function(e){return _defineProperty({},e,e)}),this.onShardChange=function(){a.url(i.getSegmentUrl("top.market.all-orders",{shard:c.shard}))}}]),mod.factory("ResourceOrdersLoader",["Loader","Api","Auth","$routeParams","$location","$q","$timeout",function(e,t,o,r,n,a,i){return e.factory(function(){return{orders:t.get("game/market/orders",{shard:r.shard,resourceType:r.resourceType}).then(function(e){return{sell:_.filter(e.list,{type:"sell"}),buy:_.filter(e.list,{type:"buy"})}}),stats:t.get("game/market/stats",{shard:r.shard,resourceType:r.resourceType}).then(function(e){return e.stats}),worldSize:t.get("game/world-size",{shard:r.shard})}})}]),mod.controller("Top.Market.ResourceOrders",["$scope","data","Auth","ResourceTypeNames","ResourceOrdersLoader","$routeSegment","MapUtils","Api","$location",function(e,t,o,r,n,a,i,s,c){var u=this;o.required(),this.resourceName=r[a.$routeParams.resourceType],this.data=t,this.targetRoom="",this.shard=a.$routeParams.shard;var l=function(e,t){if(!/^[WE]\d+[NS]\d+$/i.test(t))return 0;var o=i.roomNameToXY(e),r=_slicedToArray(o,2),n=r[0],a=r[1],s=i.roomNameToXY(t),c=_slicedToArray(s,2),l=c[0],p=c[1],m=Math.abs(l-n),d=Math.abs(p-a);return Math.max(Math.min(u.data.worldSize.width-m,m),Math.min(u.data.worldSize.height-d,d))},p=function(){u.data.orders.sell.forEach(function(e){return e.range=l(e.roomName,u.targetRoom)}),u.data.orders.buy.forEach(function(e){return e.range=l(e.roomName,u.targetRoom)})};this.onTargetRoomChange=function(){p()},this.reload=function(){return n.load().then(p)},this.shardsDropdownList=s.options.serverData.shards.map(function(e){return _defineProperty({},e,e)}),this.onShardChange=function(){c.url(a.getSegmentUrl("top.market.all-orders-resource",{resourceType:a.$routeParams.resourceType,shard:u.shard}))}}]),mod.directive("appMarketTable",function(){return{controller:function(){this.sort="",this.changeSort=function(e){this.sort=this.sort=="+"+e?"-"+e:"+"+e}},controllerAs:"MarketTable",link:function(e,t,o,r){r.sort=o.defaultSort}}}),(mod=angular.module("app.game.market.history",[])).config(["$routeSegmentProvider",function(e){e.when("/market2/history","top.market2.history").within("top").within("market2").segment("history",{templateUrl:"components/game/market/history/market-history.html?bust=1561537540072",controller:"Top.Market.History as History",resolve:{data:ngInject(["HistoryLoader",function(e){return e.load()}])}})}]),mod.factory("HistoryLoader",["Loader","Api","Auth","$routeParams","$location","$q","$timeout",function(e,t,o,r,n,a,i){return e.factory(function(e){return{money:t.get("user/money-history",{page:e})}})}]),mod.controller("Top.Market.History",["$scope","data","HistoryLoader","Auth","ResourceTypeNames",function(e,t,o,r,n){var a=this;r.required(),this.data=t,this.reload=function(){return o.load(a.data.money.page)},this.changePage=function(e){o.load(a.data.money.page+e)}}]),(mod=angular.module("app.game.market",[])).config(["$routeSegmentProvider",function(e){e.when("/market2","top.market2").within("top").segment("market2",{templateUrl:"components/game/market/market.html?bust=1561537540072"})}]),(mod=angular.module("app.game.market.my-orders",[])).config(["$routeSegmentProvider",function(e){e.when("/market2/my","top.market2.my-orders").within("top").within("market2").segment("my-orders",{templateUrl:"components/game/market/my-orders/market-my-orders.html?bust=1561537540072",controller:"Top.Market.MyOrders as MyOrders",resolve:{data:ngInject(["MyOrdersLoader",function(e){return e.load()}])}})}]),mod.factory("MyOrdersLoader",["Loader","Api","Auth","$routeParams","$location","$q","$timeout",function(e,t,o,r,n,a,i){return e.factory(function(){return{orders:t.get("game/market/my-orders").then(function(e){return e.shards||(e.shards={shard0:e.list}),e.shards})}})}]),mod.controller("Top.Market.MyOrders",["$scope","data","MyOrdersLoader","Auth","ResourceTypeNames",function(e,t,o,r,n){r.required(),this.resourceNames=n,this.data=t,this.reload=function(){return o.load()},this.getTotalCount=function(){return _.sum(_.mapValues(t.orders,function(e){return e.length}))}}]),(mod=angular.module("app.game.overview",[])).config(["$routeSegmentProvider",function(e){e.when("/overview","top.game-overview").within("top").segment("game-overview",{templateUrl:"components/game/overview/overview.html?bust=1561537540072",controller:"Top.GameOverview as GameOverview",resolve:{data:ngInject(["GameOverviewLoader",function(e){return e.load()}])}})}]),mod.factory("GameOverviewLoader",["Loader","Api","Auth","$routeParams","$location","$q","$timeout","LocalStorage",function(e,t,o,r,n,a,i,s){return e.factory(function(){var e=this,r=s.get("game.overview.displayOptions",{viewMode:"grid",statName:"energyHarvested",statInterval:8}),n=t.get("leaderboard/seasons").then(function(e){return e.seasons});return{auth:o.check(),seasons:n,leaderboardWorld:n.then(function(e){return t.get("leaderboard/find",{mode:"world",season:e[0]._id,username:o.Me.username})}).catch(function(){return null}),leaderboardPower:n.then(function(e){return t.get("leaderboard/find",{mode:"power",season:e[0]._id,username:o.Me.username})}).catch(function(){return null}),overview:t.get("user/overview",{statName:r.statName,interval:r.statInterval}).then(function(t){return e.displayOptions=r,e.max=t.statsMax,t.shards||(t.shards={shard0:t}),t})}})}]),mod.controller("Top.GameOverview",["$scope","Api","Auth","Constants","data","$routeSegment","$location","LocalStorage","GameOverviewLoader","$interval",function(e,t,o,r,n,a,i,s,c,u){var l=this;o.required(),e.Math=Math,this.data=n,this.displayOptions=s.createSyncedObj("game.overview.displayOptions",{viewMode:"grid",statName:"energyHarvested",statInterval:8,statNormalize:!1}),t.options.official||(this.displayOptions.viewMode="grid"),this.mapUrl=t.options.official?"https://d3os7yery2usni.cloudfront.net/map/":"http://"+t.options.host+":"+t.options.port+"/assets/map/",this.loader=c,this.offsetLabels={8:["-56m","-48m","-40m","-32m","-24m","-16m","-8m","0"],180:["-21h","-18h","-15h","-12h","-9h","-6h","-3h","0"],1440:["-6d","-5d","-4d","-3d","-2d","-1d","0"]},this.getGcl=function(){return o.Me.getGcl()},this.getGclBaseProgress=function(){return Math.pow(l.getGcl()-1,r.GCL_POW)*r.GCL_MULTIPLY},this.getGclCurrentProgress=function(){return(o.Me.gcl||0)-l.getGclBaseProgress()},this.getGclNeededProgress=function(){return Math.pow(l.getGcl(),r.GCL_POW)*r.GCL_MULTIPLY-l.getGclBaseProgress()},this.getPlBaseProgress=function(){return Math.pow(o.Me.getPowerLevel(),r.POWER_LEVEL_POW)*r.POWER_LEVEL_MULTIPLY},this.getPlCurrentProgress=function(){return(o.Me.power||0)-l.getPlBaseProgress()},this.getPlNeededProgress=function(){return Math.pow(o.Me.getPowerLevel()+1,r.POWER_LEVEL_POW)*r.POWER_LEVEL_MULTIPLY-l.getPlBaseProgress()},this.goToRoomOverview=function(e,t){i.url(a.getSegmentUrl("top.game-overview-room",{room:t,shard:e}))},this.goToRoom=function(e,t){i.url(a.getSegmentUrl("top.game-room",{room:t,shard:e}))},this.getRoomsCount=function(){return _(n.overview.shards).mapValues(function(e){return e.rooms.length}).sum()},e.$watchGroup([function(){return l.displayOptions.statName},function(){return l.displayOptions.statInterval}],function(){return c.load()});var p=u(function(){return c.load()},6e4);e.$on("$destroy",function(){return u.cancel(p)})}]),(mod=angular.module("app.game.overview.room",[])).config(["$routeSegmentProvider",function(e){e.when("/overview/:shard/:room","top.game-overview-room").within("top").segment("game-overview-room",{templateUrl:"components/game/overview/room/overview-room.html?bust=1561537540072",controller:"Top.GameOverviewRoom as GameOverviewRoom",dependencies:["room"],resolve:{data:ngInject(["GameOverviewRoomLoader",function(e){return e.load()}])}})}]),mod.factory("GameOverviewRoomLoader",["Loader","Api","Auth","$routeParams","$location","$q","$timeout","LocalStorage",function(e,t,o,r,n,a,i,s){return e.factory(function(){var e=this,o=s.get("game.overview.displayOptions",{statInterval:8});return{overview:t.get("game/room-overview",{room:r.room,shard:r.shard,interval:o.statInterval}).then(function(t){return e.displayOptions=o,e.max=t.statsMax,t})}})}]),mod.controller("Top.GameOverviewRoom",["$scope","Api","Auth","Constants","data","$routeSegment","$location","LocalStorage","GameOverviewRoomLoader","$interval",function(e,t,o,r,n,a,i,s,c,u){var l=this;this.displayOptions=s.createSyncedObj("game.overview.displayOptions",{statInterval:8}),this.offsetLabels={8:["-56m","-48m","-40m","-32m","-24m","-16m","-8m","0"],180:["-21h","-18h","-15h","-12h","-9h","-6h","-3h","0"],1440:["-6d","-5d","-4d","-3d","-2d","-1d","0"]},this.data=n,this.roomName=a.$routeParams.room,this.shardName=a.$routeParams.shard,this.loader=c,this.mapUrl=t.options.official?"https://d3os7yery2usni.cloudfront.net/map/":"http://"+t.options.host+":"+t.options.port+"/assets/map/",t.options.serverData.shards.length>1&&(this.mapUrl+=this.shardName+"/"),e.$watch(function(){return l.displayOptions.statInterval},function(){return c.load()});var p=u(function(){return c.load()},6e4);e.$on("$destroy",function(){return u.cancel(p)})}]),(mod=angular.module("app.game.replay-list",[])).config(["$routeSegmentProvider",function(e){e.when("/r","top.replay-list").within("top").segment("replay-list",{templateUrl:"components/game/replay-list/replay-list.html?bust=1561537540072",controller:"Top.ReplayList as ReplayList"})}]),mod.controller("Top.ReplayList",["Api","$location",function(e,t){var o=this;e.get("replays/list").then(function(e){o.list=e.list,_.forEach(o.list,function(e){e.date=new Date(e.date)})}),this.filter="",this.view=function(e){t.url("/replay/"+e._id),t.search("s",e.secret)}}]),(mod=angular.module("app.game.constructed-wall",[])).controller("ConstructedWall",["$scope",function(e){e.Math=Math}]),mod.directive("appGameConstructedWall",function(){return{scope:{objectData:"="},templateUrl:"components/game/room/constructed-wall/constructed-wall.html?bust=1561537540072",bindToController:!0,controller:"ConstructedWall as ConstructedWall"}}),(mod=angular.module("app.game.construction-site",[])).controller("ConstructionSite",["$scope","$element","$rootScope","$timeout","Connection",function(e,t,o,r,n){var a,i=this;e.Math=Math,e.$on("roomObjectsUpdated",function(){!_.isUndefined(a)&&i.objectData.progress>a&&$(t).find(".anim-build animate").each(function(e,t){return t.beginElement()}),a=i.objectData.progress})}]),mod.directive("appGameConstructionSite",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",speed:"="},templateUrl:"components/game/room/construction-site/construction-site.html?bust=1561537540072",bindToController:!0,controller:"ConstructionSite as ConstructionSite"}}),(mod=angular.module("app.game.container",[])).directive("appGameContainer",function(){return{scope:{objectData:"=",displayOptions:"=",player:"="},templateUrl:"components/game/room/container/container.html?bust=1561537540072",bindToController:!0,controller:"Container as Container"}}),mod.controller("Container",["$scope","$element","Connection","Constants",function(e,t,o,r){var n=this;e.Math=Math,e._=_;var a=function(){n.resourcesTotal=0,r.RESOURCES_ALL.forEach(function(e){n.objectData[e]&&(n.resourcesTotal+=n.objectData[e])})};e.$on("roomObjectsUpdated",a),a()}]),(mod=angular.module("app.game.controller",[])).directive("appGameController",function(){return{scope:{objectData:"=",displayOptions:"=",users:"=",speed:"=",gameTime:"=",player:"="},templateUrl:"components/game/room/controller/controller.html?bust=1561537540072",bindToController:!0,controller:"Controller as Controller"}}),mod.controller("Controller",["$scope","$element","Constants","Connection","Auth","Tutorial",function(e,t,o,r,n,a){var i,s,c=this;e.Math=Math,e.Me=function(){return n.Me},this.getLevelsPath=function(){for(var e="",t=0;t<c.objectData.level;t++){var o=-Math.PI/2;o+=t*Math.PI/4,e+="M 0 0 L "+75*Math.cos(o-Math.PI/8)+" "+75*Math.sin(o-Math.PI/8)+"\n                L "+75*Math.cos(o+Math.PI/8)+" "+75*Math.sin(o+Math.PI/8)+" Z"}return e},this.progress=function(){return Math.min(c.objectData.progress,o.CONTROLLER_LEVELS[c.objectData.level]-.01)},this.progressTotal=function(){return c.objectData.tutorial&&1==c.objectData.level?4:o.CONTROLLER_LEVELS[c.objectData.level]},this.getDowngradingOpacity=function(){return(o.CONTROLLER_DOWNGRADE[c.objectData.level]-(c.objectData.downgradeTime-c.gameTime))/o.CONTROLLER_DOWNGRADE[c.objectData.level]},e.$on("roomObjectsUpdated",function(){c.objectData.downgradeTime<c.gameTime+o.CONTROLLER_DOWNGRADE[c.objectData.level]&&$(t).find(".anim-downgrade animate").each(function(e,t){return t.beginElement()}),!_.isUndefined(i)&&c.objectData.progress>i&&$(t).find(".anim-upgrade animate").each(function(e,t){return t.beginElement()}),!_.isUndefined(s)&&c.objectData.reservation&&c.objectData.reservation.endTime>s&&$(t).find(".anim-upgrade animate").each(function(e,t){return t.beginElement()}),i=c.objectData.progress,s=c.objectData.reservation?c.objectData.reservation.endTime:void 0,c.objectData.user==c.player&&1==c.objectData.level&&c.objectData.downgradeTime-c.gameTime<19800&&c.objectData.downgradeTime-c.gameTime>0&&a.trigger("controllerDowngrade",{controller:c.objectData})})}]),(mod=angular.module("app.game.creep",[])).controller("Creep",["$scope","$element","Connection","$timeout","Constants",function(e,t,o,r,n){var a,i,s,c=this;e.Math=Math,e._=_,this.rotate=45*Math.floor(8*Math.random()),this.animActive=!1,this.say="";var u=null,l=function(e,t,o,r){if(!s&&(e!=o||t!=r)){var n;for(s=!0,e==o&&t<r&&(n=0),e>o&&t<r&&(n=45),e>o&&t==r&&(n=90),e>o&&t>r&&(n=135),e==o&&t>r&&(n=180),e<o&&t>r&&(n=-135),e<o&&t==r&&(n=-90),e<o&&t<r&&(n=-45);n-c.rotate>180;)n-=360;for(;n-c.rotate<-180;)n+=360;c.rotate=n}};this.users[this.objectData.user]&&this.users[this.objectData.user].badge&&this.users[this.objectData.user].badge._watching||(0==this.objectData.x&&(this.rotate=90),49==this.objectData.x&&(this.rotate=-90),0==this.objectData.y&&(this.rotate=180),49==this.objectData.y&&(this.rotate=0));var p=function(){s=!1,_.isUndefined(a)||l(c.objectData.x,c.objectData.y,a,i)},m=function(){var e=n.BODYPARTS_ALL,t={};c.activeBodyparts={},e.forEach(function(e){c.activeBodyparts[e]=_.filter(c.objectData.body,function(t){return t.type==e&&t.hits>0}).length}),(e=_.filter(e,function(e){return"tough"!=e&&"carry"!=e&&c.activeBodyparts[e]>0})).sort(function(e,t){return c.activeBodyparts[e]>c.activeBodyparts[t]?1:c.activeBodyparts[e]<c.activeBodyparts[t]?-1:0});var o=0;e.forEach(function(e){var r=Math.PI*c.activeBodyparts[e]/n.MAX_CREEP_SIZE;"move"==e?r=-r-Math.PI/2:(o=r+=o,r+=Math.PI/2),t[e]="M "+-39*Math.cos(r)+" "+-39*Math.sin(r)+" A 39 39 0 "+(r>Math.PI||r<-Math.PI?1:0)+" "+(r<0?1:0)+" "+39*Math.cos(r)+" "+-39*Math.sin(r)}),e.reverse(),c.bodypartPaths=_.map(e,function(e){return new Object({type:e,path:t[e]})})},d=function(e){e&&(e.x==c.objectData.x&&e.y<c.objectData.y&&$(t).find(".anim-top").each(function(e,t){return t.beginElement()}),e.x>c.objectData.x&&e.y<c.objectData.y&&$(t).find(".anim-top-right").each(function(e,t){return t.beginElement()}),e.x>c.objectData.x&&e.y==c.objectData.y&&$(t).find(".anim-right").each(function(e,t){return t.beginElement()}),e.x>c.objectData.x&&e.y>c.objectData.y&&$(t).find(".anim-bottom-right").each(function(e,t){return t.beginElement()}),e.x==c.objectData.x&&e.y>c.objectData.y&&$(t).find(".anim-bottom").each(function(e,t){return t.beginElement()}),e.x<c.objectData.x&&e.y>c.objectData.y&&$(t).find(".anim-bottom-left").each(function(e,t){return t.beginElement()}),e.x<c.objectData.x&&e.y==c.objectData.y&&$(t).find(".anim-left").each(function(e,t){return t.beginElement()}),e.x<c.objectData.x&&e.y<c.objectData.y&&$(t).find(".anim-top-left").each(function(e,t){return t.beginElement()}),l(e.x,e.y,c.objectData.x,c.objectData.y))},h=function(e,o){o&&(c.workAnim={size:e,x:o.x,y:o.y},r(function(){return $(t).find(".anim-work animate").each(function(e,t){return t.beginElement()})},0))},f=function(e,o){o&&$(t).find(".anim-"+e).each(function(e,t){return t.beginElement()})},g=function(){c.resourcesTotal=0,n.RESOURCES_ALL.forEach(function(e){c.objectData[e]&&(c.resourcesTotal+=c.objectData[e])})};p(),m(),g(),e.$on("roomObjectsUpdated",function(){p(),m(),g(),c.animActive&&c.objectData.actionLog&&(c.objectData.actionLog.rangedAttack||c.objectData.actionLog.rangedHeal||c.objectData.actionLog.repair||c.objectData.actionLog.build||c.objectData.actionLog.upgradeController)?(c.shotAnim=_.cloneDeep(c.objectData.actionLog.rangedAttack||c.objectData.actionLog.rangedHeal||c.objectData.actionLog.repair||c.objectData.actionLog.build||c.objectData.actionLog.upgradeController),c.shotAnim.fromX=a,c.shotAnim.fromY=i,c.shotAnim.type=c.objectData.actionLog.rangedAttack?"rangedAttack":c.objectData.actionLog.rangedHeal?"rangedHeal":"work",r(function(){return $(t).find(".anim-shot animate").each(function(e,t){return t.beginElement()})},0)):c.shotAnim=null,c.animActive=!0,c.workAnim=null,d(c.objectData.actionLog&&c.objectData.actionLog.harvest),d(c.objectData.actionLog&&c.objectData.actionLog.attack),d(c.objectData.actionLog&&c.objectData.actionLog.heal),d(c.objectData.actionLog&&c.objectData.actionLog.reserveController),f("attacked",c.objectData.actionLog&&c.objectData.actionLog.attacked),f("healed",c.objectData.actionLog&&c.objectData.actionLog.healed),h(36,c.objectData.actionLog&&c.objectData.actionLog.upgradeController),h(36,c.objectData.actionLog&&c.objectData.actionLog.reserveController),h(16,c.objectData.actionLog&&c.objectData.actionLog.build),h(46,c.objectData.actionLog&&c.objectData.actionLog.repair),c.objectData.actionLog&&c.objectData.actionLog.rangedMassAttack?(c.massShotAnim=!0,r(function(){return $(t).find(".anim-mass-shot animate").each(function(e,t){return t.beginElement()})},0)):c.massShotAnim=!1,c.objectData.actionLog&&c.objectData.actionLog.say&&(c.say=c.objectData.actionLog.say,c.say._visible=!1,u&&r.cancel(u),u=r(function(){c.say=null},2e3),r(function(){var e;$(t).find(".creep-say text").each(function(t,o){return e=o.getBBox().width+60}),$(t).find(".creep-say rect").each(function(t,o){o.setAttribute("width",e),o.setAttribute("x",50+(400-e)/2)}),c.say._visible=!0},0)),c.oldX=a,c.oldY=i,a=c.objectData.x,i=c.objectData.y}),e.$on("rotateCreep",function(e,t){t._id==c.objectData._id&&(c.rotate+=45)})}]),mod.directive("appGameCreep",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",users:"=",speed:"=",roomController:"=",gameTime:"="},templateUrl:"components/game/room/creep/creep.html?bust=1561537540072",bindToController:!0,controller:"Creep as Creep"}}),(mod=angular.module("app.game.disabled-object",[])).controller("DisabledObject",["$scope",function(e){e.Math=Math}]),mod.directive("appGameDisabledObject",function(){return{scope:{objectData:"="},templateUrl:"components/game/room/disabled-object/disabled-object.html?bust=1561537540072",bindToController:!0,controller:"DisabledObject as DisabledObject"}}),(mod=angular.module("app.game.room.display-options-block",[])).directive("appDisplayOptionsBlock",function(){return{templateUrl:"components/game/room/display-options-block/display-options-block.html?bust=1561537540072",controller:"DisplayOptionsBlock as DisplayOptionsBlock",scope:{model:"=",heading:"@",parent:"@",children:"="},bindToController:!0,link:function(e,t,o,r){}}}),mod.controller("DisplayOptionsBlock",["$scope",function(e){var t=this;if(this.parentSelected=void 0,this.parentModel=void 0,this.parent)e.$watch(function(){return t.model[t.parent]},function(e){return t.parentModel=e}),this.parentChange=function(){return t.model[t.parent]=t.parentModel};else{var o=[];_.forEach(this.children,function(e,r){o.push(function(){return t.model[r]})}),e.$watchGroup(o,function(){return function(){var e=0,o=0;for(var r in t.children)t.model[r]?e++:o++;t.parentSelected=0==e?"none":o>0?"partial":"all",t.parentModel="all"==t.parentSelected}()}),this.parentChange=function(){_.forEach(t.children,function(e,o){t.model[o]=t.parentModel})}}}]),(mod=angular.module("app.game.room.dlg-arena-activation",[])).controller("DlgArenaActivation",["$scope","MemoryStorage","$modalInstance","Api",function(e,t,o,r){var n=this;this.code="",this.error="",this.submit=function(){r.post("arena/activate",{code:n.code}).then(function(e){mixpanel.track("Arena activated"),o.close()}).catch(function(e){n.error="invalid code"==e?"Activation code is invalid":"Unknown error"})}}]),mod.factory("ArenaActivator",["Api","$routeSegment","$routeParams","$modal",function(e,t,o,r){var n={run:function(t){return e.post("arena/status",{respawn:t,room:o.room}).catch(function(e){"activation needed"==e&&r.open({templateUrl:"components/game/room/dlg-arena-activation/dlg-arena-activation.html?bust=1561537540072",controller:"DlgArenaActivation as DlgArenaActivation"}).result.then(function(){return n.run(t)})})}};return n}]),(mod=angular.module("app.game.room.dlg-creep",[])).controller("DlgCreep",["$scope","MemoryStorage","$modalInstance","data","Constants",function(e,t,o,r,n){var a=this;this.name=r.name,this.body=[],this.submit=function(){a.body.length>0&&o.close({name:a.name,body:a.body})},this.addBodypart=function(e){a.body.length!=n.MAX_CREEP_SIZE&&a.body.push(e)},this.removeBodypart=function(e){a.body.splice(e,1)}}]),(mod=angular.module("app.game.room.dlg-display-options",[])).controller("DlgDisplayOptions",["$scope","MemoryStorage","$modalInstance","data","Connection",function(e,t,o,r,n){var a=this;this.data=_.cloneDeep(r),this.showHd=window.devicePixelRatio>1,this.isWebGLSupported=GameRenderer.isWebGLSupported(),this.isWebGLSupported||(this.data.renderer.pixi.webgl=!1),this.submit=function(){o.close(a.data)}}]),(mod=angular.module("app.game.room.dlg-flag",[])).controller("DlgFlag",["$scope","MemoryStorage","$modalInstance","data","Connection",function(e,t,o,r,n){var a=this;this.name=r.name,this.flag=r.flag,this.color=10,this.secondaryColor=10,this.colorsList=[1,2,3,4,5,6,7,8,9,10],this.flag&&(this.color=this.flag.color,this.secondaryColor=this.flag.secondaryColor||this.flag.color),this.checkName=function(){n.checkUniqueFlagName(a.name,r.player).then(function(){return a.overwriteWarning=!1}).catch(function(e){return a.overwriteWarning="name exists"==e})},this.submit=function(){o.close({name:a.name,color:a.color,secondaryColor:a.secondaryColor})}}]),(mod=angular.module("app.game.energy",[])).controller("Energy",["$scope",function(e){e.Math=Math}]),mod.directive("appGameEnergy",function(){return{scope:{objectData:"="},templateUrl:"components/game/room/energy/energy.html?bust=1561537540072",bindToController:!0,controller:"Energy as Energy"}}),(mod=angular.module("app.game.exit",[])).controller("Exit",["$scope","Constants",function(e,t){e.Math=Math,this.getPath=function(){for(var e="",t=0;t<50;t++)e+="M "+(100*t+50)+" 20 l 30 50 h -60 Z";for(t=0;t<50;t++)e+="M "+(100*t+50)+" 4980 l 30 -50 h -60 Z";for(t=0;t<50;t++)e+="M 20 "+(100*t+50)+" l 50 30 v -60 Z";for(t=0;t<50;t++)e+="M 4980 "+(100*t+50)+" l -50 30 v -60 Z";return e}}]),mod.directive("appGameExit",function(){return{scope:{objectData:"="},templateUrl:"components/game/room/exit/exit.html?bust=1561537540072",bindToController:!0,controller:"Exit as Exit"}}),(mod=angular.module("app.game.extension",[])).controller("Extension",["$scope","Constants",function(e,t){var o=this;e.Math=Math,this.getSize=function(){return 200==o.objectData.energyCapacity?50:100==o.objectData.energyCapacity?40:34}}]),mod.directive("appGameExtension",function(){return{scope:{objectData:"=",displayOptions:"=",player:"="},templateUrl:"components/game/room/extension/extension.html?bust=1561537540072",bindToController:!0,controller:"Extension as Extension"}}),(mod=angular.module("app.game.extractor",[])).directive("appGameExtractor",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",speed:"="},templateUrl:"components/game/room/extractor/extractor.html?bust=1561537540072",bindToController:!0,controller:"Extractor as Extractor"}}),mod.controller("Extractor",["$scope","$rootScope","Constants","$element",function(e,t,o,r){var n,a=this;e.Math=Math,e.Constants=o,e.$on("roomObjectsUpdated",function(){a.objectData.cooldown&&!n&&$(r).find("svg").each(function(e,t){return t.unpauseAnimations()}),!a.objectData.cooldown&&(n>0||void 0===n)&&$(r).find("svg").each(function(e,t){return t.pauseAnimations()}),n=a.objectData.cooldown})}]),(mod=angular.module("app.game.flag",[])).controller("Flag",["$scope",function(e){e.Math=Math}]),mod.directive("appGameFlag",function(){return{scope:{objectData:"=",displayOptions:"=",player:"="},templateUrl:"components/game/room/flag/flag.html?bust=1561537540072",bindToController:!0,controller:"Flag as Flag"}}),(mod=angular.module("app.game.keeper-lair",[])).controller("KeeperLair",["$scope","$rootScope",function(e,t){e.Math=Math}]),mod.directive("appGameKeeperLair",function(){return{scope:{objectData:"=",displayOptions:"="},templateUrl:"components/game/room/keeper-lair/keeper-lair.html?bust=1561537540072",bindToController:!0,controller:"KeeperLair as KeeperLair"}}),(mod=angular.module("app.game.lab",[])).controller("Lab",["$scope","$element","Connection","$timeout",function(e,t,o,r){var n=this;e.Math=Math,e._=_,this.animActive=!1,e.$on("roomObjectsUpdated",function(){n.animActive=!0,n.objectData.actionLog&&n.objectData.actionLog.runReaction?(n.shotAnim=_.cloneDeep(n.objectData.actionLog.runReaction),$(t).find(".anim-shot animate").each(function(e,t){return t.beginElement()})):n.shotAnim=null})}]),mod.directive("appGameLab",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",speed:"="},templateUrl:"components/game/room/lab/lab.html?bust=1561537540072",bindToController:!0,controller:"Lab as Lab"}}),(mod=angular.module("app.game.link",[])).controller("Link",["$scope","$element","Connection","$timeout",function(e,t,o,r){var n=this;e.Math=Math,e._=_,this.animActive=!1,e.$on("roomObjectsUpdated",function(){n.animActive=!0,n.objectData.actionLog&&n.objectData.actionLog.transferEnergy?(n.shotAnim=_.cloneDeep(n.objectData.actionLog.transferEnergy),$(t).find(".anim-shot animate").each(function(e,t){return t.beginElement()})):n.shotAnim=null})}]),mod.directive("appGameLink",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",speed:"="},templateUrl:"components/game/room/link/link.html?bust=1561537540072",bindToController:!0,controller:"Link as Link"}}),(mod=angular.module("app.game.mineral",[])).directive("appGameMineral",function(){return{scope:{objectData:"="},templateUrl:"components/game/room/mineral/mineral.html?bust=1561537540072",bindToController:!0,controller:"GenericObject as GenericObject"}}),(mod=angular.module("app.game.nuke",[])).directive("appGameNuke",function(){return{scope:{objectData:"=",displayOptions:"=",gameTime:"="},templateUrl:"components/game/room/nuke/nuke.html?bust=1561537540072",bindToController:!0,controller:"GenericObject as GenericObject"}}),(mod=angular.module("app.game.nuker",[])).directive("appGameNuker",function(){return{scope:{objectData:"=",displayOptions:"=",player:"="},templateUrl:"components/game/room/nuker/nuker.html?bust=1561537540072",bindToController:!0,controller:"GenericObject as GenericObject"}}),(mod=angular.module("app.game.observer",[])).directive("appGameObserver",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",speed:"="},templateUrl:"components/game/room/observer/observer.html?bust=1561537540072",bindToController:!0,controller:"GenericObject as GenericObject"}}),(mod=angular.module("app.game.portal",[])).directive("appGamePortal",function(){return{scope:{objectData:"=",displayOptions:"="},templateUrl:"components/game/room/portal/portal.html?bust=1561537540072",bindToController:!0,controller:"GenericObject as GenericObject"}}),(mod=angular.module("app.game.power-bank",[])).controller("PowerBank",["$scope","Constants",function(e,t){var o=this;e.Math=Math,e.Constants=t,this.getRadius=function(){return Math.sqrt(o.objectData.power/t.POWER_BANK_CAPACITY_MAX*3e3/Math.PI)}}]),mod.directive("appGamePowerBank",function(){return{scope:{objectData:"=",displayOptions:"="},templateUrl:"components/game/room/power-bank/power-bank.html?bust=1561537540072",bindToController:!0,controller:"PowerBank as PowerBank"}}),(mod=angular.module("app.game.room.power-icon",[])).controller("PowerIcon",["$scope","$rootScope","Constants",function(e,t,o){var r=this;e.$watch(function(){return r.timerMax},function(){r._timerMax=_.isArray(r.timerMax)?r.timerMax[r.level-1]:r.timerMax}),e.$watch(function(){return r.powerId},function(){for(var e in o)o[e]==r.powerId&&-1!=e.indexOf("PWR_")&&(r.name=e.substring(4))})}]),mod.directive("appPowerIcon",function(){return{templateUrl:"components/game/room/power-icon/power-icon.html?bust=1561537540072",controller:"PowerIcon as PowerIcon",bindToController:!0,scope:{powerId:"=",level:"=",timer:"=",timerMax:"="}}}),(mod=angular.module("app.game.power-spawn",[])).controller("PowerSpawn",["$scope","$rootScope","Tutorial","Connection",function(e,t,o,r){e.Math=Math}]),mod.directive("appGamePowerSpawn",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",users:"="},templateUrl:"components/game/room/power-spawn/power-spawn.html?bust=1561537540072",bindToController:!0,controller:"PowerSpawn as PowerSpawn"}}),(mod=angular.module("app.game.room.controller-properties",[])).controller("Top.Game.Room.ControllerProperties",["$scope","$rootScope","Constants","Connection","WorldRespawnChecker","Dialogs",function(e,t,o,r,n,a){var i=this;this.askUnclaim=!1,this.increaseLevel=function(){var t=e.Room.selectedObject;t.level++,t.level>8&&(t.level=8),1==t.level&&(t.progress=0),t.user=e.Game.player},this.decreaseLevel=function(){var t=e.Room.selectedObject;t.level--,t.level<=0&&(t.level=0,t.user=null,t.progress=0)},this.unclaim=function(){if(i.askUnclaim){var t=e.Room.selectedObject;r.addObjectIntent(t._id,e.Game.player,"unclaim",{id:t._id});var o=e.$on("roomObjectsUpdated",function(){n.check(),o()})}else i.askUnclaim=!0},this.activateSafeMode=function(){return a.ask("","This action will consume 1 available safe mode activation. Proceed?").result.then(function(){var t=e.Room.selectedObject;r.addObjectIntent(t._id,e.Game.player,"activateSafeMode",{id:t._id}).catch(function(e){"safe mode active already"==e&&a.alert("","There is a room in safe mode already. You can activate safe mode in only one room at the same time.")})})},this.isSafeModeDisabled=function(){return!e.Room.selectedObject.safeModeAvailable||e.Room.selectedObject.safeMode>e.Room.gameTime||e.Room.selectedObject.safeModeCooldown>e.Room.gameTime||e.Room.selectedObject.upgradeBlocked>e.Room.gameTime||e.Room.selectedObject.downgradeTime<e.Room.gameTime+o.CONTROLLER_DOWNGRADE[e.Room.selectedObject.level]/2-o.CONTROLLER_DOWNGRADE_SAFEMODE_THRESHOLD}}]),(mod=angular.module("app.game.room.creep-properties",[])).controller("Top.Game.Room.CreepProperties",["$scope","$rootScope","Connection","Api",function(e,t,o,r){var n=this;this.askSuicide=!1,this.addMemoryWatch=function(){t.$broadcast("addMemoryWatch","creeps."+e.Room.selectedObject.name)},this.suicide=function(){if(n.askSuicide){var t=e.Room.selectedObject;o.addObjectIntent(t._id,e.Game.player,"suicide",{id:t._id}),e.Room.selectedObject=null}else n.askSuicide=!0},this.removeInvader=function(){r.post("game/remove-invader",{_id:e.Room.selectedObject._id,shard:e.Room.shardName}),e.Room.selectedObject=null}}]),(mod=angular.module("app.game.room.flag-properties",[])).controller("Top.Game.Room.FlagProperties",["$scope","$rootScope","Api","Dialogs","$modal","Connection",function(e,t,o,r,n,a){this.addMemoryWatch=function(){t.$broadcast("addMemoryWatch","flags."+e.Room.selectedObject.name)},this.changeColor=function(){n.open({templateUrl:"components/game/room/dlg-flag/dlg-flag.html?bust=1561537540072",controller:"DlgFlag as DlgFlag",resolve:{data:function(){return new Object({flag:e.Room.selectedObject})}}}).result.then(function(t){return a.changeFlagColor(e.Room.selectedObject.name,t.color,t.secondaryColor,e.Game.player)})}}]),(mod=angular.module("app.game.room.power-creep-properties",[])).controller("Top.Game.Room.PowerCreepProperties",["$scope","$rootScope","Connection","Api",function(e,t,o,r){var n=this;this.askSuicide=!1,this.addMemoryWatch=function(){t.$broadcast("addMemoryWatch","powerCreeps."+e.Room.selectedObject.name)},this.suicide=function(){if(n.askSuicide){var t=e.Room.selectedObject;o.addGlobalIntent(e.Game.player,"suicidePowerCreep",{id:t._id}),e.Room.selectedObject=null}else n.askSuicide=!0}}]),(mod=angular.module("app.game.room.rampart-properties",[])).controller("Top.Game.Room.RampartProperties",["$scope","$rootScope","Connection",function(e,t,o){this.setPublic=function(t){o.addObjectIntent(e.Room.selectedObject._id,e.Game.player,"setPublic",{isPublic:t})}}]),(mod=angular.module("app.game.room.spawn-properties",[])).controller("Top.Game.Room.SpawnProperties",["$scope","$rootScope","Api","Dialogs",function(e,t,o,r){this.addMemoryWatch=function(){t.$broadcast("addMemoryWatch","spawns."+e.Room.selectedObject.name)},this.getSpawningCreep=function(){return _.find(e.Room.objects,{type:"creep",spawning:!0,x:e.Room.selectedObject.x,y:e.Room.selectedObject.y})}}]),(mod=angular.module("app.game.rampart",[])).directive("appGameRampart",function(){return{scope:{objectData:"=",player:"="},templateUrl:"components/game/room/rampart/rampart.html?bust=1561537540072",bindToController:!0,controller:"GenericObject as GenericObject"}}),(mod=angular.module("app.game.room.rendered-svg-path",[])).directive("appRoomRenderedSvgPath",["RoomCanvasRenderer","$timeout",function(e,t){return{restrict:"E",templateUrl:"components/game/room/rendered-svg-path/rendered-svg-path.html?bust=1561537540072",controller:function(){this.activeCanvas=0},controllerAs:"RenderedSvgPath",link:function(t,o,r,n){var a,i,s=window.URL||window.webkitURL||window,c=0,u=e.register(),l=0,p=0,m=function(e){l=Date.now(),a=e,p||d()},d=function e(){p=Date.now(),u.start();var n=1-c,m=$(o).parentsUntil(".game-field").parent(),d=m.width(),h=m.height(),f='<svg xmlns="http://www.w3.org/2000/svg" width="'+d+'" height="'+h+'" '+_.map(t.$eval(r.svgOptions),function(e,t){return t+'="'+e+'"'}).join(" ")+"><path "+_.map(t.$eval(r.pathOptions),function(e,t){return t+'="'+e+'"'}).join(" ")+' d="'+a+'"></path></svg>',g=$(o).find("img")[n];g.width=d,g.height=h;var v=new Blob([f],{type:"image/svg+xml"});i&&s.revokeObjectURL(i),i=s.createObjectURL(v),g.onload=function(){$(o).find("img")[c].style.display="none",$(o).find("img")[n].style.display="",c=n,setTimeout(function(){t.$apply(function(){u.resolve(),l>p?e():p=0})},0)},g.src=i};t.$watch(r.path,m),t.$watch(r.pathOptions,function(){return m(t.$eval(r.path))}),t.$on("resize",_.debounce(function(e,o){o&&o.sameSize||m(t.$eval(r.path))},20));var h=_.debounce(function(){return t.$apply(function(){m(t.$eval(r.path))})},20);$(window).on("resize",h),t.$on("$destroy",function(){e.unregister(u),$(window).off("resize",h),i&&(s.revokeObjectURL(i),setTimeout(function(){$(o).find("img").each(function(){this.src=""})},1e3))})}}}]);var time=0;(mod=angular.module("app.game.room.roads",[])).factory("RoomRoads",function(){return function(e){if(!e)return"";performance.now();for(var t="",o={},r=-10;r<=50;r++)o[r]={};e.forEach(function(e){o[e.x][e.y]=e});for(r=0;r<50;r++)for(var n=0;n<50;n++)if(o[r][n]){var a=o[r][n];t+="M "+(100*a.x+50)+" "+(100*a.y+50)+" h 0 ",o[r][n-1]&&(t+="M "+(100*a.x+50)+" "+(100*a.y+50)+" l 0 -50 "),o[r+1][n-1]&&(t+="M "+(100*a.x+50)+" "+(100*a.y+50)+" l 50 -50 "),o[r+1][n]&&(t+="M "+(100*a.x+50)+" "+(100*a.y+50)+" l 50 0 "),o[r+1][n+1]&&(t+="M "+(100*a.x+50)+" "+(100*a.y+50)+" l 50 50 "),o[r][n+1]&&(t+="M "+(100*a.x+50)+" "+(100*a.y+50)+" l 0 50 "),o[r-1][n+1]&&(t+="M "+(100*a.x+50)+" "+(100*a.y+50)+" l -50 50 "),o[r-1][n]&&(t+="M "+(100*a.x+50)+" "+(100*a.y+50)+" l -50 0 "),o[r-1][n-1]&&(t+="M "+(100*a.x+50)+" "+(100*a.y+50)+" l -50 -50 ")}return t}});_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var o=[],r=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(o.push(i.value),!t||o.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}return o}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}(mod=angular.module("app.game.room",[])).factory("RoomViewPendingSelector",function(){var e;return{set:function(t){e=t},check:function(t){if(!e)return!1;var o=_.find(t,{_id:e});return o?(e=null,o):void 0}}}),mod.factory("RoomCanvasRenderer",function(){var e=[],t={dirty:!1,register:function(){var o={status:"inactive",start:function(){t.dirty=!1,this.time=performance.now(),this.status="pending"},resolve:function(){this.status="inactive"}};return e.push(o),o},unregister:function(t){e=_.without(e,t)},isComplete:function(){return!_.any(e,{status:"pending"})}};return t}),mod.controller("Top.Game.Room",["$scope","Connection","$timeout","LocalStorage","MemoryStorage","RoomWalls","RoomRoads","$modal","Dialogs","Constants","Tutorial","StaticMaps","$q","$window","Api","$routeSegment","RoomViewPendingSelector","$location","ArenaActivator","$routeParams","MapUtils","WorldActivator","Auth","Socket","ResourceTypeNames","WorldRespawnChecker","$rootScope","$templateCache",function(e,t,o,r,n,a,i,s,c,u,l,p,m,d,h,f,g,v,y,b,w,S,M,$,T,k,C,A){var R=this,O=this;if(this.zIndexByType={constructedWall:0,energy:1,source:2,keeperLair:3,controller:4,creep:5,portal:6,extension:7,spawn:8,link:9,constructionSite:10,flag:11},this.resourceTypeNames=T,this.densityNames={1:"Low",2:"Moderate",3:"High",4:"Ultra"},this.objects=[],this.flags=[],this.terrain=[],this.users={},this.hasExit={},this.Constants=u,this.gameTime=null,!h.options.official&&h.options.serverData.customObjectTypes)for(var L in this.customObjectTypes=h.options.serverData.customObjectTypes,h.options.serverData.customObjectTypes)A.put("customObjectTypeSvg_"+L,h.options.serverData.customObjectTypes[L].svg||""),A.put("customObjectTypeProperties_"+L,h.options.serverData.customObjectTypes[L].sidepanel||"");e.Game.simulationMode||h.get("game/time",{shard:b.shard}).then(function(e){R.gameTime=e.time}),e.$watchCollection(function(){return[b.room,b.shard]},function(){if(R.objects=[],R.flags=[],R.terrain=[],R.users={},R.hasExit={},R.isRoomUpdatedOnce=!1,R.roomName=b.room,b.shard==R.shardName||e.Game.simulationMode||h.get("game/time",{shard:b.shard}).then(function(e){R.gameTime=e.time}),R.shardName=b.shard,R.mapUrl=h.options.official?"https://d3os7yery2usni.cloudfront.net/map/":"http://"+h.options.host+":"+h.options.port+"/assets/map/",h.options.serverData.shards.length>1&&(R.mapUrl+=R.shardName+"/"),R.safeMode=null,R.roomController=null,R.canCreateInvaders=!1,C.$broadcast("roomChanged"),"history"!=e.Game.simulationMode&&t.reloadRoom(),R.terrain&&0!=R.terrain.length||D().catch(function(){return e.Game.roomError=!0}),R.roomName){var o=w.roomNameToXY(R.roomName),r=_slicedToArray(o,2),n=r[0],a=r[1];R.hasExit.left=w.getRoomNameFromXY(n-1,a),R.hasExit.right=w.getRoomNameFromXY(n+1,a),R.hasExit.top=w.getRoomNameFromXY(n,a-1),R.hasExit.bottom=w.getRoomNameFromXY(n,a+1),R.respawnProhibited=!1,M.Me&&(h.get("user/respawn-prohibited-rooms").then(function(e){_.contains(e.rooms,R.roomName)&&(R.respawnProhibited=!0)}),h.get("game/room-status",{room:R.roomName,shard:R.shardName}).then(function(e){R.roomStatusInfo=e.room}))}}),this.displayOptions=r.createSyncedObj("game.room.displayOptions",{showMyNames:{spawns:!0,creeps:!1},showEnemyNames:{spawns:!0,creeps:!1},showFlags:!0,showFlagsNames:!0,asideCollapsed:!1,showCreepSpeech:!0,showRoomVisual:!0,animations:!0,renderer:{pixi:{metrics:!1,swampTexture:"animated",lighting:"normal",webgl:!0,hd:"upscaling"}}}),this.asidePanels=r.createSyncedObj("game.room.asidePanels",{simulation:!0,displayOptions:!1,cursor:!0,playerControl:!1,customize:!0,construct:!0,view:!0,arena:!0,worldRoom:!0,worldMap:!1,invasion:!1}),this.selectedAction={action:"view"},this.selectedObject=null,this.cursorPos=null;var j=[20,30,40,50,65,80,100,125,150];this.zoomLevel=2,this.zoom=40,this.panActive=!1,this.symmetry="none",this.arenaRespawn=!1,this.roomController=null,this.now=function(){return Date.now()},this.dummyRoad={0:{type:"road",x:1,y:1}},this.dummyRampart={0:{type:"rampart",x:1,y:1,user:0}},this.dummyWall={0:{type:"constructedWall",x:1,y:1}},this.isPlacingFirstSpawn=!1,this.onNotifyWhenAttackedChange=function(){h.post("game/set-notify-when-attacked",{shard:R.shardName,_id:R.selectedObject._id,enabled:R.selectedObject.notifyWhenAttacked})},this.switchRoom=function(e){if(R.hasExit[e]){var t=f.getSegmentUrl(f.name,{room:R.hasExit[e]});"top.game-room-history"==f.name&&(t+="?t="+R.gameTime),v.url(t)}},this.getNeighborRoom=function(e,t){if(b.room){var o=w.roomNameToXY(b.room),r=_slicedToArray(o,2),n=r[0],a=r[1];return w.getRoomNameFromXY(n+e,a+t)}},this.goToMap=function(){var e=w.roomNameToXY(b.room),t=_slicedToArray(e,2),o=t[0],r=t[1];v.url(f.getSegmentUrl("top.game-world-map")+"?pos="+(o+.5)+","+(r+.5))},this.selectObjectPending=function(e){g.set(e),R.selectedAction={action:"view"},R.selectedObject=g.check(R.objects)||R.selectedObject,h.get("game/find-object",{_id:e}).then(function(e){e.object&&e.object.room!=b.room&&v.url(f.getSegmentUrl("top.game-room",{room:e.object.room}))})},this.onArenaRespawnChange=function(){y.run(R.arenaRespawn)};var E,I={};this.getRenderedPath=function(e,t,o){if(I[e]&&!o)return I[e];var r;if((!I[e]||o)&&("walls"==e&&(r=a(t?[t]:[R.objects,R.terrain],function(e){return"wall"==e.type||"constructedWall"==e.type},!1)),"swamps"==e&&(r=a([R.terrain],function(e){return"swamp"==e.type},!1)),"roads"==e&&(r=i(_.filter(t||R.objects,{type:"road"}))),/^ramparts/.test(e))){var n=e.match(/^ramparts:(.*)$/);r=a(t?[t]:[R.objects],function(e){return"rampart"==e.type&&!e.isPublic&&e.user==n[1]},!1)}return o||(I[e]=r),r},this.getUsersWithRamparts=function(){var e=[];return _.forEach(R.objects,function(t){"rampart"==t.type&&-1==e.indexOf(t.user)&&e.push(t.user)}),e},this.cursorPaint=function(e){if("view"==R.selectedAction.action&&("mouseup"==e.type?E=null:E?Math.max(Math.abs(E.x-e.pageX),Math.abs(E.y-e.pageY))>10&&(R.panActive=_.cloneDeep(E),E=null):E={x:e.pageX,y:e.pageY}),R.isLocationValid()&&R.cursorPos&&"customize"==R.selectedAction.action){if("erase"==R.selectedAction.customize){var t=n.get("rooms.objects");_.remove(t,{x:R.cursorPos.x,y:R.cursorPos.y}),n.put("rooms.objects",t),x(R.cursorPos.x,R.cursorPos.y,"plain")}_.isObject(R.selectedAction.customize)&&"create"==R.selectedAction.customize.action&&"spawn"!=R.selectedAction.customize.type&&N(R.selectedAction.customize.type,R.cursorPos)}},this.cursorClick=function(o){if(R.isLocationValid()&&R.cursorPos){if("spawn"==R.selectedAction.action){var n=_.filter(R.objects,{type:"source"}).length;if(0==n)return void c.alert("",{html:'<img src="components/game/room/room-spawn-2sources.png" align="left" style="margin-left:-15px">There are no energy sources in this room. It is not a very good idea to start playing in a room without ability to harvest energy. Please choose another room.'});if("world"==R.roomMode&&R.timeUntilCanSpawn())return;if(R.respawnProhibited)return;var a=R.cursorPos.x,i=R.cursorPos.y,s=m.when();"world"==R.roomMode&&(h.options.official&&!r.get("placeSpawnTutorialAsked",0)&&(s=s.then(function(){return c.ask({message:"Before you start in the real World, we recommend you to take the Tutorial that explains the game basics and everything you are going to face step by step. Have you already taken the tutorial? ",buttonLabel:"Yes, I have",buttonCancelLabel:"Go to Tutorial"}).result.then(function(){r.put("placeSpawnTutorialAsked",1)}).catch(function(e){return"cancel click"==e&&v.url(f.getSegmentUrl("top.sim.tutorial-index")),m.reject()})})),h.options.official&&(n<2&&(s=s.then(function(){return c.ask({message:'<img src="components/game/room/room-spawn-2sources.png" align="left" style="margin-left:-15px">There is only 1 energy source in this room. It may create a resource deficit when developing your new colony. We recommend to choose a room with 2 energy sources for your first start in the game.<br><br>Do you really want to place your spawn in this room?'}).result})),(!R.roomStatusInfo.novice||R.roomStatusInfo.novice<Date.now())&&M.Me&&M.Me.getGcl()<=3&&(s=s.then(function(){return c.ask({message:"<b>Warning!️</b> You are to settle a room outside the Novice Area! The <b>Novice Area</b> sector was created in order to protect novice players from fights with more skilled ones in the initial stages of the game. By settling outside of it, you risk becoming an easy prey in the case you are not familiar with the game yet.<br><br>Are you sure you want to found your colony here?",buttonLabel:"Proceed",buttonCancelLabel:"Go to Novice Area"}).result.catch(function(e){return"cancel click"==e&&v.url(f.getSegmentUrl("top.game-world-map")),m.reject()})})),R.roomController.hardSign&&R.roomController.hardSign.text==u.SIGN_PLANNED_AREA&&(s=s.then(function(){return c.ask({message:"A new Novice or Respawn Area is being planned somewhere in this sector. If you claim this room, it may be included into this area in the future.<br><br>Do you really want to place your spawn in this room?"}).result})),s=s.then(function(){return h.get("game/shards/info")}).then(function(e){var t=_.find(e.shards,{name:b.shard});if(t.cpuLimit&&M.Me&&M.Me.cpu>t.cpuLimit)return c.ask({message:"Warning: <b>"+b.shard+"</b> is CPU limited and designed for non-subscription players. You won't be able to use your full CPU on this shard.<br><br>Do you really want to found your colony here?"}).result}))),s.then(function(){if(!("world"==R.roomMode&&M.Me.credits<50)||M.Me.cpu)return c.askForName("spawn",e.Game.player).then(function(o){return t.placeSpawn(a,i,o,e.Game.player)}).then(function(t){if(R.selectedAction.action="view",e.Game.play(),"world"==R.roomMode)h.options.official&&(t.newbie?(mixpanel.track("Place first spawn"),ga("send","event","World","Place first spawn",R.roomName),c.alert("",{html:'<h4>Congratulations!</h4>\n                                        <p>This is your first room with your first spawn. This is where your expansion within the Screeps World gets started.</p>\n                                        <p>Since you have just spawned, we have turned on <strong>safe mode</strong> in your room. It means that no other creep will be able to use any harmful methods in this room. Safe mode lasts 20,000 game ticks (approx. 15 hours depending on the tick duration), so use this grace period to get familiarized with the game and <a href="http://docs.screeps.com/defense.html" app-nw-external-link target="_blank">set up your own defenses</a>.</p>\n                                        <p>Good luck and have fun scripting!</p>'})):(mixpanel.track("Respawn"),ga("send","event","World","Respawn")));else{var o=_.find(R.objects,{type:"controller"});o.user=e.Game.player,o.level=1,o.progress=0,o.progressTotal=0}}).catch(function(e){"out of borders"==e&&c.alert("","This room is not available for settlement yet. Please choose another room."),"novice area"==e&&c.alert("","This room is marked as Novice Area. Only players with Global Control Level < 4 can spawn here. Please choose another room."),"no cpu"==e&&v.url(f.getSegmentUrl("top.order"))});v.url(f.getSegmentUrl("top.order"))})}if("construct"==R.selectedAction.action&&H(R.selectedAction.construct,R.cursorPos),"view"==R.selectedAction.action)if(R.selectedAction.changeFlag){var l=R.selectedAction.changeFlag.color||u.COLOR_WHITE,p=R.selectedAction.changeFlag.secondaryColor||l,d=(a=R.cursorPos.x,i=R.cursorPos.y,R.selectedAction.changeFlag.name),g={type:"flag",_id:"tempFlag_"+R.cursorPos.x+"_"+R.cursorPos.y+"_"+d,color:l,secondaryColor:p,user:e.Game.player,x:a,y:i,temp:d};R.flags.push(g),e.$broadcast("roomObjectsUpdated",!0),t.createFlag(a,i,d,l,p,e.Game.player),delete R.selectedAction.changeFlag}else e.$broadcast("view",{event:o});"flag"==R.selectedAction.action&&U(R.cursorPos),"customize"==R.selectedAction.action&&("createCreep"==R.selectedAction.customize&&z(R.cursorPos),_.isObject(R.selectedAction.customize)&&"create"==R.selectedAction.customize.action&&N(R.selectedAction.customize.type,R.cursorPos)),"createInvader"==R.selectedAction.action&&e.$broadcast("createInvader")}else if("world"==R.roomMode){var y=R.checkController().msg;"spawn"==R.selectedAction.action&&("no controller"==y&&c.alert("","There is no Controller in this room. Controllers allow players capture rooms and build facilities in them. A room with no Controller cannot be captured. Please choose another room."),"controller busy"==y&&c.alert("","The Controller in this room is already captured by another player. It seems that somebody has come here ahead of you. Please choose another room.")),"construct"==R.selectedAction.action&&("no controller"==y&&c.alert("","There is no Controller in this room. Controllers allow players capture rooms and build facilities in them. Construction is impossible in this room."),"not a controller owner"==y&&c.alert("",{html:'<p>You can build facilities in your own rooms only. In order to do that, you must claim the Controller of the room.</p>\n                            <p>Read more about territory control in <a target="_blank" href="http://docs.screeps.com/control.html" app-nw-external-link>How to Play</a> articles.</p>'}),"RCL not enough"==y&&c.alert("",{html:'<p>The Room Controller Level of this room is insufficient for building this facility. You have to upgrade your Controller to the needed level.</p>\n                            <p>Read more about territory control in <a target="_blank" href="http://docs.screeps.com/control.html" app-nw-external-link>How to Play</a> articles.</p>'}))}},this.save=function(){var e=window.open(""),t=_.cloneDeep(R.terrain);t=t.concat(_.filter(R.objects,function(e){return"wall"==e.type||"swamp"==e.type})),e.document.write(JSON.stringify({terrain:[{_id:"terrain",type:"terrain",terrain:p.encodeTerrain(t)}],objects:_(R.objects).filter(function(e){return"wall"!=e.type&&"swamp"!=e.type}).map(function(e){return delete(e=_.cloneDeep(e)).room,delete e._id,e}).value()}))},this.restore=function(){var e=JSON.parse(R.restoreData);e.objects=e.objects.concat(p.decodeTerrain(e.terrain[0].terrain,"sim")),e.objects.forEach(function(t){t._id||(t._id=p.getUniqueId(e.objects)),2==t.user&&(t.user=1),t.room="sim",t.body&&(t.body=_.reduce(t.body,function(e,t){return e.push(t),e},[]))}),R.objects=e.objects,n.put("rooms.objects",e.objects)},this.isLocationValid=function(){if(!R.cursorPos)return!1;var e=R.cursorPos,t=e.x,o=e.y;if("none"!=R.symmetry&&("diagonal"==R.symmetry&&o<t||"horizontal"==R.symmetry&&t>24||"quadrant"==R.symmetry&&(t>24||o>24||o<t)))return!1;if("construct"==R.selectedAction.action||"spawn"==R.selectedAction.action){if(_.any(R.objects,{x:t,y:o,type:R.selectedAction.construct}))return!1;if(_.any(R.objects,{x:t,y:o,type:"constructionSite"}))return!1;if("extractor"==R.selectedAction.construct)return _.any(R.objects,{type:"mineral",x:t,y:o});if("road"!=R.selectedAction.construct&&_.any([R.objects,R.terrain],function(e){return _.any(e,function(e){return e.x==t&&e.y==o&&"wall"==e.type})}))return!1;if("road"!=R.selectedAction.construct&&"rampart"!=R.selectedAction.construct&&_.any(R.objects,function(e){return e.x==t&&e.y==o&&"rampart"!=e.type&&"road"!=e.type&&u.CONSTRUCTION_COST[e.type]}))return!1;if(t<=0||o<=0||t>=49||o>=49)return!1;if("road"!=R.selectedAction.construct&&"container"!=R.selectedAction.construct&&(1==t&&!_.every([-1,0,1],function(e){return"wall"==R.getTerrainAtCursor({x:0,y:o+e})})||48==t&&!_.every([-1,0,1],function(e){return"wall"==R.getTerrainAtCursor({x:49,y:o+e})})||1==o&&!_.every([-1,0,1],function(e){return"wall"==R.getTerrainAtCursor({x:t+e,y:0})})||48==o&&!_.every([-1,0,1],function(e){return"wall"==R.getTerrainAtCursor({x:t+e,y:49})})))return!1;if("OK"!=R.checkController().msg)return!1}if(R.selectedAction.customize){var r=function(e){return 0==e||49==e};if("erase"==R.selectedAction.customize)return!(r(t)&&r(o));if(_.isEqual(R.selectedAction.customize,{action:"create",type:"extractor"})&&!_.any(R.objects,{type:"mineral",x:t,y:o}))return!1}if("createInvader"==R.selectedAction.action){if(0!=t&&49!=t&&0!=o&&49!=o)return!1;if("wall"==R.getTerrainAtCursor())return!1}return!0},this.getTerrainAtCursor=function(e){if(e||R.cursorPos){e||(e=R.cursorPos);var t=_.filter(R.objects,{x:e.x,y:e.y}).concat(_.filter(R.terrain,{x:e.x,y:e.y}));return _.any(t,{type:"wall"})?"wall":_.any(t,{type:"swamp"})?"swamp":"plain"}},this.showTutorial=function(){l.show()},this.removeSelectedConstructionSite=function(){R.selectedObject&&"constructionSite"==R.selectedObject.type&&(R.selectedObject.user==e.Game.player||R.roomController&&R.roomController.user==e.Game.player)&&(R.selectedObject.tempRemove=!0,e.$broadcast("roomObjectsUpdated",!0),t.addObjectIntent("room",e.Game.player,"removeConstructionSite",[{id:R.selectedObject._id,roomName:R.selectedObject.room}]),R.selectedObject=null)},this.removeSelectedFlag=function(){R.selectedObject&&"flag"==R.selectedObject.type&&(R.selectedObject.tempRemove=!0,e.$broadcast("roomObjectsUpdated",!0),t.removeFlag(R.selectedObject.name,e.Game.player),R.selectedObject=null)},this.destroySelectedObject=function(){if(R.selectedObject&&u.CONSTRUCTION_COST[R.selectedObject.type]){R.selectedObject.tempRemove=!0,e.$broadcast("roomObjectsUpdated",!0),t.addObjectIntent("room",e.Game.player,"destroyStructure",[{id:R.selectedObject._id,roomName:R.selectedObject.room,user:R.roomController.user}]),R.selectedObject=null;var o=e.$on("roomObjectsUpdated",function(){k.check(),o()})}},this.zoomIn=function(){R.zoomLevel++,R.zoomLevel>=j.length&&R.zoomLevel--,R.zoom=j[R.zoomLevel],e.$broadcast("resize")},this.zoomOut=function(){R.zoomLevel--,R.zoomLevel<0&&R.zoomLevel++,R.zoom=j[R.zoomLevel],e.$broadcast("resize")},this.creepFilter=function(e){return"creep"==e.type&&(!e.ticksToSpawn||e.ticksToSpawn<3)},this.finishGame=function(){return t.finishGame()},this.symmetryMirror=function(){var e,t=n.get("rooms.objects");"diagonal"==R.symmetry&&(_.remove(t,function(e){return e.y<e.x}),e=_.cloneDeep(t),_.forEach(e,function(e){if(e.x!=e.y){var o=[e.y,e.x];e.x=o[0],e.y=o[1],e._id=p.getUniqueId(t),t.push(e)}})),"horizontal"==R.symmetry&&(_.remove(t,function(e){return e.x>24}),e=_.cloneDeep(t),_.forEach(e,function(e){e.x=49-e.x,e._id=p.getUniqueId(t),t.push(e)})),"quadrant"==R.symmetry&&(_.remove(t,function(e){return e.x>24||e.y>24||e.y<e.x}),e=_.cloneDeep(t),_.forEach(e,function(e){if(e.x!=e.y){var o=[e.y,e.x];e.x=o[0],e.y=o[1],e._id=p.getUniqueId(t),t.push(e)}}),e=_.cloneDeep(t),_.forEach(e,function(e){var o=e;(e=_.cloneDeep(o)).x=49-e.x,e._id=p.getUniqueId(t),t.push(e),(e=_.cloneDeep(o)).y=49-e.y,e._id=p.getUniqueId(t),t.push(e),(e=_.cloneDeep(o)).x=49-e.x,e.y=49-e.y,e._id=p.getUniqueId(t),t.push(e)})),n.put("rooms.objects",t)},this.rotate=function(){R.objects=[],o(function(){var e=n.get("rooms.objects");e.forEach(function(t){var o=t.y;t.y=t.x,t.x=49-o,"exit"==t.type&&(t.exit+=2,t.exit>8&&(t.exit-=8)),_.contains(["portal"],t.type)&&(t._id=p.getUniqueId(e))}),n.put("rooms.objects",e),R.objects=e},10)},this.timeUntilCanSpawn=function(){if(!M.Me||!M.Me.lastRespawnDate)return!1;var e=M.Me.lastRespawnDate-$.timeCorrection,t=M.Me.respawnPenalty||18e4;return!(Date.now()>e+t)&&Math.floor((e+t-Date.now())/1e3)},this.worldLaunched=function(){return Date.now()>=S.launchTime},this.runWave=function(){return t.runWave()},this.pauseSurvival=function(){R.survivalEnabled=!1,t.survivalEnabled(!1)},this.resumeSurvival=function(){R.survivalEnabled=!0,t.survivalEnabled(!0)},this.saveObjectsToMemory=function(){n.put("rooms.objects",R.objects)},this.goToHistory=function(){h.get("game/time",{shard:R.shardName}).then(function(e){var t=Math.floor((e.time-150)/h.options.serverData.historyChunkSize)*h.options.serverData.historyChunkSize;v.url(f.getSegmentUrl("top.game-room-history")+"?t="+t)})},this.historyShare={url:"",room:"",shard:"",time:0,create:function(){var e=this;return h.post("game/history-share",{shard:O.shardName,room:O.roomName,time:O.gameTime}).then(function(t){e.url="screeps.com/s/"+t.code,e.room=t.room,e.time=t.time,e.shard=t.shard})}},this.calcResources=function(e){return _.sum(u.RESOURCES_ALL,function(t){return e[t]})},this.checkController=function(t){t||(t=R.selectedAction);var o=_.find(R.objects,{type:"controller"});if("spawn"==t.action)return o?o.user?{msg:"controller busy"}:o.reservation?{msg:"controller busy"}:{msg:"OK"}:{msg:"no controller"};if(t.construct){var r=0;if(o&&(r=o.level),o&&(o.user&&o.user!=e.Game.player||o.reservation&&o.reservation.user!=e.Game.player))return{msg:"not a controller owner",rcl:1};if("road"==t.construct)return{msg:"OK",count:2500};var n=_(R.objects).filter(function(e){return e.type==t.construct||"constructionSite"==e.type&&e.structureType==t.construct}).size(),a=u.CONTROLLER_STRUCTURES[t.construct][r];if(n<a)return{msg:"OK",count:a-n};if(o&&o.level){for(var i=-1,s=o.level+1;s<=8;s++)if(u.CONTROLLER_STRUCTURES[t.construct][s]>n){i=s;break}return{msg:"RCL not enough",rcl:i}}return{msg:"RCL not enough",rcl:1}}},this.isSelectedObjectNPC=function(){return!!_.contains(["1","2","3"],R.selectedObject.user)||"Screeps"==R.users[R.selectedObject.user].username},this.selectedObjectHasEffects=function(){return R.gameTime&&R.selectedObject.effects&&_.any(R.selectedObject.effects,function(e){return e.endTime>=R.gameTime})},this.openDlgDisplayOptions=function(){s.open({templateUrl:"components/game/room/dlg-display-options/dlg-display-options.html?bust=1561537540072",controller:"DlgDisplayOptions as DlgDisplayOptions",windowClass:"dlg-display-options-window",resolve:{data:function(){return R.displayOptions}}}).result.then(function(t){Object.assign(R.displayOptions,t),e.Top.hideUi=t.hideUi,e.$broadcast("displayOptionsUpdated")})};var P=function(e){if("extractor"==e.type&&!e.user)return!1;if(!u.CONSTRUCTION_COST[e.type])return!1;if("rampart"==e.type||"constructedWall"==e.type||"road"==e.type)return!1;var t=_.filter(R.objects,{type:e.type,user:e.user}),o=R.roomController?R.roomController.level:0;return!u.CONTROLLER_STRUCTURES[e.type][0]&&(!R.roomController||o<1||R.roomController.user!=e.user)||t.length>u.CONTROLLER_STRUCTURES[e.type][o]&&(t.sort(W(R.roomController)),t=_.take(t,u.CONTROLLER_STRUCTURES[e.type][o]),!_.contains(t,e))},x=function(e,t,o){var r=n.get("rooms.terrain"),a=_.find(r,{room:"sim"}),i="wall"==o?"1":"swamp"==o?"2":"0";a.terrain=a.terrain.substring(0,50*t+e)+i+a.terrain.substring(50*t+e+1),D(),I={}},D=function(){return t.getRoomTerrain().then(function(t){R.terrain=t,e.$broadcast("roomTerrainUpdated")})},G=_.throttle(function(){e.$broadcast("roomObjectsUpdated",!0)},1e3),N=function(o,r,a){var i=["H","H","H","H","H","O","O","O","O","O","Z","Z","Z","K","K","K","X","U","U","U","L","L","L"];return m(function(s,l){if(_.contains(["swamp","wall","road","spawn","extension","rampart","constructedWall","source","keeperLair","controller","portal","link","storage","tower","observer","powerBank","powerSpawn","energy","invader","mineral","terminal","lab","extractor","container","nuker"],o)){var p=r.x,m=r.y;if("custom"!=e.Game.simulationMode&&"survival"!=e.Game.simulationMode&&"spawn"!=R.selectedAction.action)return void l();var d={type:o,x:p,y:m,room:"sim",name:a};if("wall"==o||"swamp"==o)return void x(p,m,o);if("spawn"==o&&_.extend(d,{user:e.Game.player,energy:"spawn"==R.selectedAction.action?u.SPAWN_ENERGY_START:u.SPAWN_ENERGY_CAPACITY,energyCapacity:u.SPAWN_ENERGY_CAPACITY,hits:u.SPAWN_HITS,hitsMax:u.SPAWN_HITS,spawning:null}),"extension"==o&&_.extend(d,{user:e.Game.player,energy:0,energyCapacity:0,hits:u.EXTENSION_HITS,hitsMax:u.EXTENSION_HITS}),"storage"==o&&_.extend(d,{user:e.Game.player,energy:u.STORAGE_CAPACITY/2,energyCapacity:u.STORAGE_CAPACITY,L:.3*u.STORAGE_CAPACITY,hits:u.STORAGE_HITS,hitsMax:u.STORAGE_HITS}),"link"==o&&_.extend(d,{user:e.Game.player,energy:u.LINK_CAPACITY/2,energyCapacity:u.LINK_CAPACITY,hits:u.LINK_HITS,hitsMax:u.LINK_HITS,cooldown:0}),"tower"==o&&_.extend(d,{user:e.Game.player,energy:u.TOWER_CAPACITY/2,energyCapacity:u.TOWER_CAPACITY,hits:u.TOWER_HITS,hitsMax:u.TOWER_HITS}),"terminal"==o&&_.extend(d,{user:e.Game.player,energy:u.TERMINAL_CAPACITY/2,energyCapacity:u.TERMINAL_CAPACITY,hits:u.TERMINAL_HITS,hitsMax:u.TERMINAL_HITS}),"extractor"==o&&_.extend(d,{user:e.Game.player,hits:u.EXTRACTOR_HITS,hitsMax:u.EXTRACTOR_HITS}),"lab"==o&&_.extend(d,{user:e.Game.player,mineralAmount:u.LAB_MINERAL_CAPACITY/2,mineralType:i[Math.floor(Math.random()*i.length)],mineralCapacity:u.LAB_MINERAL_CAPACITY,energy:u.LAB_ENERGY_CAPACITY/2,energyCapacity:u.LAB_ENERGY_CAPACITY,hits:u.LAB_HITS,hitsMax:u.LAB_HITS,cooldown:0}),"observer"==o&&_.extend(d,{user:e.Game.player,hits:u.OBSERVER_HITS,hitsMax:u.OBSERVER_HITS}),"source"==o&&_.extend(d,{energy:u.SOURCE_ENERGY_CAPACITY,energyCapacity:u.SOURCE_ENERGY_CAPACITY,ticksToRegeneration:u.ENERGY_REGEN_TIME}),"mineral"==o){var h=i[Math.floor(Math.random()*i.length)];_.extend(d,{mineralType:h,mineralAmount:u.MINERAL_MIN_AMOUNT[h]*(1+Math.random()*(u.MINERAL_RANDOM_FACTOR-1)),ticksToRegeneration:null})}if("rampart"==o&&_.extend(d,{user:e.Game.player,hits:u.RAMPART_HITS,hitsMax:u.RAMPART_HITS,nextDecayTime:R.gameTime+u.RAMPART_DECAY_TIME}),"powerBank"==o&&_.extend(d,{power:Math.floor(Math.random()*(u.POWER_BANK_CAPACITY_MAX-u.POWER_BANK_CAPACITY_MIN)+u.POWER_BANK_CAPACITY_MIN),hits:u.POWER_BANK_HITS,hitsMax:u.POWER_BANK_HITS,decayTime:R.gameTime+u.POWER_BANK_DECAY}),"powerSpawn"==o&&_.extend(d,{user:e.Game.player,power:u.POWER_SPAWN_POWER_CAPACITY/2,powerCapacity:u.POWER_SPAWN_POWER_CAPACITY,energy:u.POWER_SPAWN_ENERGY_CAPACITY/2,energyCapacity:u.POWER_SPAWN_ENERGY_CAPACITY,hits:u.POWER_SPAWN_HITS,hitsMax:u.POWER_SPAWN_HITS}),"container"==o&&_.extend(d,{energy:u.CONTAINER_CAPACITY/2,energyCapacity:u.CONTAINER_CAPACITY,hits:u.CONTAINER_HITS,hitsMax:u.CONTAINER_HITS,nextDecayTime:R.gameTime+u.CONTAINER_DECAY_TIME}),"road"==o){var f=u.ROAD_HITS;_.any([R.objects,R.terrain],function(e){return _.any(e,{x:p,y:m,type:"swamp"})})&&(f*=u.CONSTRUCTION_COST_ROAD_SWAMP_RATIO),_.any([R.objects,R.terrain],function(e){return _.any(e,{x:p,y:m,type:"wall"})})&&(f*=u.CONSTRUCTION_COST_ROAD_WALL_RATIO),_.extend(d,{hits:f,hitsMax:f})}"constructedWall"==o&&_.extend(d,{hits:u.WALL_HITS,hitsMax:u.WALL_HITS_MAX}),"keeperLair"==o&&_.extend(d,{ticksToSpawn:1,user:"3"}),"controller"==o&&_.extend(d,{level:0}),"nuker"==o&&_.extend(d,{user:e.Game.player,hits:u.NUKER_HITS,hitsMax:u.NUKER_HITS,energy:u.NUKER_ENERGY_CAPACITY,energyCapacity:u.NUKER_ENERGY_CAPACITY,G:u.NUKER_GHODIUM_CAPACITY,GCapacity:u.NUKER_GHODIUM_CAPACITY,cooldownTime:R.gameTime+10});var g=function(){var a=n.get("rooms.objects");_.any(a,{x:r.x,y:r.y,type:o})?l():("controller"==o&&_.remove(a,{type:"controller"}),"storage"==o&&_.remove(a,{type:"storage"}),d._id=t.genUniqueId(a),a.push(d),n.put("rooms.objects",a),R.objects=a,"constructedWall"==o||"wall"==o||"swamp"==o?G():e.$broadcast("roomObjectsUpdated",!0),s(),I={})};"spawn"!=o||d.name?g():c.askForName("spawn",e.Game.player).then(function(e){d.name=e,g()}).catch(function(){return l()})}})},U=function(o){t.genUniqueFlagName(e.Game.player).then(function(r){s.open({templateUrl:"components/game/room/dlg-flag/dlg-flag.html?bust=1561537540072",controller:"DlgFlag as DlgFlag",resolve:{data:function(){return new Object({name:r,player:e.Game.player})}}}).result.then(function(r){var n={type:"flag",_id:"tempFlag_"+o.x+"_"+o.y+"_"+r.name,color:r.color,secondaryColor:r.secondaryColor,user:e.Game.player,x:o.x,y:o.y,temp:r.name};R.flags.push(n),e.$broadcast("roomObjectsUpdated",!0),t.createFlag(o.x,o.y,r.name,r.color,r.secondaryColor,e.Game.player).catch(function(e){"flags limit exceeded"==e&&c.alert("","You cannot create more than 10,000 flags.")})})})},H=function(o,r){if(o){var n,a={type:"constructionSite",_id:"tempConstructionSite_"+r.x+"_"+r.y,x:r.x,y:r.y,user:e.Game.player,structureType:o,progress:0,progressTotal:1,temp:!0};R.objects.push(a),C.$broadcast("roomObjectsUpdated",!0),(n="spawn"==o?c.askForName("spawn",e.Game.player).then(function(n){return t.createConstruction(o,r.x,r.y,e.Game.player,n)}):t.createConstruction(o,r.x,r.y,e.Game.player)).then(function(e){return a.temp=e}),n.catch(function(e){_.remove(R.objects,a),"too many"==e&&c.alert("","You have too many construction sites. The maximum number of construction sites per player is 100.")})}},z=function(o){t.genUniqueNameForType("creep",e.Game.player).then(function(r){s.open({templateUrl:"components/game/room/dlg-creep/dlg-creep.html?bust=1561537540072",controller:"DlgCreep as DlgCreep",resolve:{data:function(){return new Object({name:r})}}}).result.then(function(r){var a=r.body,i=0;a=_.map(a,function(e){return"carry"==e&&(i+=u.CARRY_CAPACITY),{type:e,hits:100}});var s=n.get("rooms.objects");s.push({_id:t.genUniqueId(),type:"creep",name:r.name,body:a,x:o.x,y:o.y,user:e.Game.player,room:"sim",energy:0,power:0,energyCapacity:i,hits:100*a.length,hitsMax:100*a.length,spawning:!1,fatigue:0,ageTime:R.gameTime+(_.any(a,{type:"claim"})?u.CREEP_CLAIM_LIFE_TIME:u.CREEP_LIFE_TIME)}),n.put("rooms.objects",s)})})},W=function(e){return e.pos&&(e=e.pos),function(t,o){return t.pos&&(t=t.pos),o.pos&&(o=o.pos),Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))-Math.max(Math.abs(o.x-e.x),Math.abs(o.y-e.y))}};t.onRoomUpdate(e,function(t,r,a,i,s,c){if(I={},R.gameTime=i,R.isRoomUpdatedOnce=!0,R.visual=c,r)for(var u in r)R.users[u]=r[u];R.objects=t,R.flags=[],s&&!_.isString(s)&&(s=s[0]&&!_.isUndefined(s[0].user)?(s=_.find(s,{user:e.Game.player})||{data:""}).data:void 0),s&&s.split("|").forEach(function(e){if(e){var t=e.split("~");R.flags.push({name:t[0].replace(/\$VLINE\$/g,"|").replace(/\$TILDE\$/g,"~"),color:Number(t[1]),secondaryColor:Number(t[2]),x:Number(t[3]),y:Number(t[4]),_id:"flag_"+t[0],type:"flag"})}}),R.safeMode=null,R.roomController=null;for(var p=0;p<R.objects.length;p++){if("controller"==(d=R.objects[p]).type&&(R.roomController=d,d.safeMode&&(R.safeMode=d.safeMode)),d.temp&&!0!==d.temp){var m=_.find(R.objects,function(e){return e._id==d.temp||e.name==d.temp});m&&m.x==d.x&&m.y==d.y&&R.objects.splice(p--,1)}}for(p=0;p<R.objects.length;p++){var d;(d=R.objects[p])._isDisabled=P(d)}if(R.canCreateInvaders=R.roomController&&R.roomController.user==e.Game.player&&_.filter(R.objects,{type:"creep",user:"2"}).length<5&&0==_.filter(R.objects,function(e){return"creep"==e.type&&"2"!=e.user&&e.user!=R.roomController.user}).length,R.canCreateInvaders||"createInvader"!=R.selectedAction.action||(R.selectedAction.action="view"),a&&(R.roomMode=a.mode,"survival"==a.mode?(R.survivalScore=a.score||0,R.timeToWave=a.timeToWave||200,R.wave=a.wave||1,a.user==e.Game.player&&(e.Game.readOnly=!1,_.any(R.objects,{type:"spawn"})||(R.selectedAction.action="spawn",R.isPlacingFirstSpawn=!0)),R.survivalEnabled=a.survivalEnabled,a.status):"world"==a.mode&&(e.Game.readOnly&&"top.game-room-history"!=f.name&&h.get("user/world-status").then(function(t){"empty"==t.status&&(R.selectedAction.action="spawn",R.isPlacingFirstSpawn=!0),e.Game.readOnly=!1}),R.historyTimestamp=a.historyTimestamp,R.historyTickRecorded=a.historyTickRecorded)),R.isPlacingFirstSpawn&&_.any(t,{type:"spawn",user:e.Game.player})&&(R.isPlacingFirstSpawn=!1,"spawn"==R.selectedAction.action&&(R.selectedAction.action="view")),R.selectedObject&&("flag"==R.selectedObject.type?R.selectedObject=_.find(R.flags,{_id:R.selectedObject._id}):R.selectedObject=_.find(R.objects,{_id:R.selectedObject._id})),"tutorial"==e.Game.simulationMode&&(l.trigger("objectsStart"),_.forEach(t,function(e){"creep"==e.type&&l.trigger("creep",{creep:e}),"controller"==e.type&&l.trigger("controller",{controller:e}),"road"==e.type&&l.trigger("road",{road:e}),"constructionSite"==e.type&&l.trigger("constructionSite",{constructionSite:e})}),l.trigger("objectsEnd",{objects:t})),R.selectedObject=g.check(R.objects)||R.selectedObject,"history"==e.Game.simulationMode&&i>=e.Game.historyMaxGameTime&&e.Game.pause(),R.autoCreateCreeps){R.objects=[];for(var v=5;v<=45;v++)for(var y=5;y<=45;y++)if(!((v+y)%2)){var b={_id:"id"+Math.floor(1e5*Math.random())+Date.now(),type:"creep",user:e.Game.player,body:[{type:"move",hits:100}],name:"x"+v+"y"+y,x:v,y:y,room:"sim",hits:100,hitsMax:100,carryCapacity:0,energy:0,ageTime:1e12};R.objects.push(b)}for(u=0;u<400;u++){var w={_id:"id"+Math.floor(1e5*Math.random())+Date.now(),type:"road",x:Math.floor(40*Math.random())+5,y:Math.floor(40*Math.random())+5,room:"sim",hits:1e5,hitsMax:1e5,decayTime:1e12};R.objects.push(w),w={_id:"id"+Math.floor(1e5*Math.random())+Date.now(),type:"rampart",user:e.Game.player,decayTime:1e7,x:Math.floor(40*Math.random())+5,y:Math.floor(40*Math.random())+5,room:"sim",hits:1e5,hitsMax:1e5},R.objects.push(w)}["container","controller","extension","extractor","keeperLair","lab","link","mineral","nuker","observer","powerBank","powerSpawn","source","spawn","storage","terminal","tower"].forEach(function(t){for(var o=0;o<5;o++)R.objects.push({_id:"id"+Math.floor(1e5*Math.random())+Date.now(),type:t,user:e.Game.player,x:Math.floor(30*Math.random())+10,y:Math.floor(30*Math.random())+10,room:"sim",hits:100,hitsMax:100})}),n.put("rooms.objects",R.objects)}o(10).then(function(){return e.$broadcast("roomObjectsUpdated")})}),e.Game.simulationMode&&!e.Game.readOnly&&"history"!=e.Game.simulationMode&&t.setSimLostWarning(e),e.$on("$destroy",function(){e.Game.pause()}),C.isDebug&&(e.$watch(function(){return R.selectedObject},function(e){R.selectedObjectJSON=JSON.stringify(R.selectedObject)},!0),this.setSelectedObjectJSON=function(){var e=_.findIndex(R.objects,{_id:R.selectedObject._id});R.selectedObject=R.objects[e]=JSON.parse(R.selectedObjectJSON)}),l.trigger("roomEntered")}]),mod.controller("GenericObject",["$scope","$rootScope","Constants",function(e,t,o){e.Math=Math,e.Constants=o}]),mod.controller("Top.Game.Room.Invasion",["$scope","MemoryStorage","Connection","Dialogs",function(e,t,o,r){var n=this;this.type="Melee",this.size="small",e.$on("createInvader",function(){o.createInvader(e.Room.cursorPos.x,e.Room.cursorPos.y,n.type,n.size,n.boosted).catch(function(e){"not owned"==e&&r.alert("","You must own or reserve this room to generate invaders.")})})}]),mod.directive("appAsideBlock",function(){return{scope:{heading:"@",show:"=visibilityModel"},transclude:!0,templateUrl:"room-aside-block-template",controller:function(){var e=this;this.toggle=function(){return e.show=!e.show}},controllerAs:"AsideBlock",bindToController:!0}}),mod.directive("appRoomCursorPos",["$parse","$document",function(e,t){return{link:function(o,r,n){var a=!1,i=_.throttle(function(){return o.$apply()},15);$(r).mousemove(function(t){var s=$(t.target).offset(),c=Math.floor((t.pageX-s.left)/$(r).width()*50),u=Math.floor((t.pageY-s.top)/$(r).height()*50);e(n.appRoomCursorPos).assign(o,{x:c,y:u}),a&&e(n.appRoomCursorPaint)(o,{$event:t}),i()}),$(r).mouseleave(function(t){null!==t.relatedTarget&&o.$apply(function(){e(n.appRoomCursorPos).assign(o,null)})}),$(r).bind("touchstart",function(t){var a=t.originalEvent.changedTouches[0],s=$(a.target).offset(),c=Math.floor((a.pageX-s.left)/$(r).width()*50),u=Math.floor((a.pageY-s.top)/$(r).height()*50);e(n.appRoomCursorPos).assign(o,{x:c,y:u}),e(n.appRoomCursorClick)(o,{$event:a}),i()}),$(r).click(function(t){return o.$apply(function(){e(n.appRoomCursorClick)(o,{$event:t})}),!1}),$(r).mousedown(function(){return o.$apply(function(){a=!0}),!1});var s=function(t){return o.$apply(function(){a&&e(n.appRoomCursorPaint)(o,{$event:t}),a=!1}),!1};$(t).bind("mouseup",s),o.$on("$destroy",function(){t.unbind("mouseup",s)})}}}]),mod.directive("appRoomConstructionAvailable",function(){return{templateUrl:"room-construction-available",bindToController:{structure:"@"},controller:function(){},controllerAs:"RoomConstructionAvailable",scope:!0}}),mod.directive("appRoomDestroyStructure",["Auth","Dialogs",function(e,t){return{templateUrl:"room-destroy-structure",bindToController:{},controller:["$scope",function(o){var r=this;this.confirm=!1,this.start=function(){_.any(o.Room.objects,function(t){return"creep"==t.type&&t.user!=o.Game.player&&(0!=t.user||!e.Me||o.Game.player!=e.Me._id)})?t.alert("","It is not allowed to destroy a structure when hostile creeps are in the room."):r.confirm=!0}}],controllerAs:"RoomDestroyStructure",scope:!0}}]),mod.directive("appRoomVisual",function(){return{link:function(e,t,o){var r,n=t[0],a=n.getContext("2d");function i(e){a.strokeStyle=e.color,a.lineWidth=e.width*n.width/50,a.globalAlpha=e.opacity,e.fill&&(a.fillStyle=e.fill,a.fill()),e.stroke&&(e.lineStyle&&("dotted"==e.lineStyle&&a.setLineDash([.1*n.width/50,.2*n.width/50]),"dashed"==e.lineStyle&&a.setLineDash([.3*n.width/50,.25*n.width/50])),a.strokeStyle=e.stroke,a.lineWidth=(e.strokeWidth||.1)*n.width/50,a.stroke())}function s(){a.clearRect(0,0,n.width,n.height),r&&r.split("\n").forEach(function(e){var t;if(e){switch(e=JSON.parse(e),a.save(),e.t){case"l":t=_.defaults(e.s||{},{width:.1,color:"#fff",opacity:.5}),a.beginPath(),a.moveTo((.5+e.x1)*n.width/50,(.5+e.y1)*n.height/50),a.lineTo((.5+e.x2)*n.width/50,(.5+e.y2)*n.height/50),a.strokeStyle=t.color,a.lineWidth=t.width*n.width/50,a.globalAlpha=t.opacity,t.lineStyle&&("dotted"==t.lineStyle&&a.setLineDash([1,2]),"dashed"==t.lineStyle&&a.setLineDash([6,5])),a.stroke();break;case"c":t=_.defaults(e.s||{},{radius:.15,fill:"#fff",opacity:.5}),a.beginPath(),a.arc((.5+e.x)*n.width/50,(.5+e.y)*n.height/50,t.radius*n.width/50,0,2*Math.PI),i(t);break;case"r":t=_.defaults(e.s||{},{fill:"#fff",opacity:.5}),a.beginPath(),a.rect((.5+e.x)*n.width/50,(.5+e.y)*n.height/50,e.w*n.width/50,e.h*n.height/50),i(t);break;case"p":t=_.defaults(e.s||{},{stroke:"#fff",opacity:.5}),a.beginPath(),a.moveTo((.5+e.points[0][0])*n.width/50,(.5+e.points[0][1])*n.width/50);for(var o=1;o<e.points.length;o++)a.lineTo((.5+e.points[o][0])*n.width/50,(.5+e.points[o][1])*n.width/50);i(t);break;case"t":t=_.defaults(e.s||{},{color:"#fff",opacity:1,align:"center",strokeWidth:.15,backgroundPadding:.3}),a.globalAlpha=t.opacity;var r=.7*n.width/50+"px";if(t.size&&void 0===t.font&&(r=+t.size*n.width/50+"px"),void 0!==t.font&&(r=_.isNumber(t.font)?t.font*n.width/50+"px":t.font.replace(/([\d\.]+)(?![\d\w])/,function(e,t){return t*n.width/50+"px"})),/^[\d\.]+px$/.test(r)&&(r+=" sans-serif"),a.font=r,a.textAlign=t.align,t.backgroundColor){a.textBaseline="middle";var s=a.measureText(e.text);a.fillStyle=t.backgroundColor;var c=(.5+e.x)*n.width/50,u=(.5+e.y)*n.height/50;"center"==t.align&&(c-=s.width/2),"right"==t.align&&(c-=s.width);var l=t.backgroundPadding*n.width/50,p=+a.font.match(/([\d\.]+)px/)[1];a.fillRect(c-l,u-l-p/2,s.width+2*l,p+2*l)}a.fillStyle=t.color,t.stroke&&(a.strokeStyle=t.stroke,a.lineWidth=t.strokeWidth*n.width/50,a.lineJoin="round",a.strokeText(e.text,(.5+e.x)*n.width/50,(.5+e.y)*n.height/50)),a.fillText(e.text,(.5+e.x)*n.width/50,(.5+e.y)*n.height/50)}a.restore()}})}function c(){n.width=t.parent().width(),n.height=t.parent().height(),s()}e.$watch(o.appRoomVisual,function(e){r=e,s()}),e.$on("resize",_.debounce(function(e,t){t&&t.sameSize||c()},20)),$(window).on("resize",c),e.$on("$destroy",function(){return $(window).unbind("resize",c)}),c()}}}),mod.directive("appGameRenderer",["$interval","Api","$routeParams","$rootScope","$document",function(e,t,o,r,n){var a,i=["creep-npc","flag","flag-secondary","powerBank","extractor","controller","controller-level","constructedWall","nuker","nuker-border","link","link-border","extension-border50","extension-border100","extension-border200","lab","terminal-border","terminal-arrows","tombstone-border","tombstone-resource","bodyPartBar","tower-base","storage","storage-border"],s={CELL_SIZE:100,ATTACK_PENETRATION:10,VIEW_BOX:5e3,RENDER_SIZE:{width:2048,height:2048},metadata:null,gameData:{}};return r.$watch(function(){return t.options.serverData.renderer},function(){var e=t.options.serverData.renderer||{},o=e.metadata,r=e.resources;s.metadata=_.cloneDeep(RENDERER_METADATA),o&&Object.assign(s.metadata.objects,o),a=_.cloneDeep(RENDERER_RESOURCES),r&&(Object.assign(a,r),Object.keys(a).forEach(function(e){return a[e]=a[e].replace(/\{ASSETS_URL\}/,"http://"+t.options.host+":"+t.options.port+"/assets/")})),GameRenderer.compileMetadata(s.metadata)}),{controller:function(){this.tickDuration=2},link:function(c,u,l,p){var m,d,h=!1;function f(){var e={width:u.width(),height:u.height()};return window.devicePixelRatio>1&&"native"==c.Room.displayOptions.renderer.pixi.hd&&(e.width*=window.devicePixelRatio,e.height*=window.devicePixelRatio),e}function g(){m&&(m.release(),u.find("canvas").remove()),h=!1,setTimeout(function(){!function(e){Object.assign(s.gameData,{player:e.Game.player,showFlags:e.Room.displayOptions.showFlags,showFlagsNames:e.Room.displayOptions.showFlagsNames,showCreepSpeech:e.Room.displayOptions.showCreepSpeech,showMyNames:_.clone(e.Room.displayOptions.showMyNames),showEnemyNames:_.clone(e.Room.displayOptions.showEnemyNames),swampTexture:e.Room.displayOptions.renderer.pixi.swampTexture}),Object.assign(s,{BADGE_URL:t.options.apiUrl+"user/badge-svg?username=%1",lighting:e.Room.displayOptions.renderer.pixi.lighting,forceCanvas:!e.Room.displayOptions.renderer.pixi.webgl})}(c),(m=new GameRenderer(_defineProperty({size:f(),autoFocus:!1,resourceMap:a,countMetrics:c.Room.displayOptions.renderer.pixi.metrics,rescaleResources:i,worldConfigs:s,onGameLoop:function(){}},"countMetrics",!0))).init(u.find(".pixijs-renderer__container")[0]).then(function(e){return m.setTerrain(c.Room.terrain)}).then(function(){var e="native"==c.Room.displayOptions.renderer.pixi.hd?Math.max(1,window.devicePixelRatio||1):1;m.zoomLevel=c.Room.zoom/250*e,m.pan(u.width()/2*e-5e3*m.zoomLevel/2,u.height()/2*e-5e3*m.zoomLevel/2),b(),h=!0,r.$broadcast("resize"),y()})},100)}c.Game.simulationMode||(t.options.official?t.get("game/shards/tick",{shard:o.shard}).then(function(e){p.tickDuration=e.tick/1e3}):t.get("game/tick").catch(function(){return{tick:0}}).then(function(e){p.tickDuration=Math.max(e.tick,t.options.serverData.socketUpdateThrottle||200)/1e3}));var v=function(e){if(h){var t=_.cloneDeep(c.Room.objects);c.Room.displayOptions.showFlags&&(t=t.concat(_.cloneDeep(c.Room.flags))),m.applyState({objects:t,users:c.Room.users,gameTime:c.Room.gameTime},e)}},y=_.throttle(function(){c.Game.simulationMode&&(p.tickDuration=100/c.Game.speed),v(Math.max(p.tickDuration,.1))},100),b=function(){var e="native"==c.Room.displayOptions.renderer.pixi.hd?Math.max(1,window.devicePixelRatio||1):1,t=5e3*m.zoomLevel/e;u.find(".pixijs-renderer__stage").css({left:m.app.stage.position.x/e+"px",top:m.app.stage.position.y/e+"px",width:t+"px",height:t+"px"})};g(),c.$on("$destroy",function(){m.release()}),c.$on("displayOptionsUpdated",g),c.$on("resize",function(){h&&m.resize(f())});var w=function(){h&&(b(),m.resize(f()))};c.$on("roomObjectsUpdated",function(e,t){h&&(t?v(0):y())}),c.$on("roomTerrainUpdated",_.throttle(function(){h&&m.setTerrain(c.Room.terrain)},1e3)),e.bindToScope(c,function(){h&&c.Room.displayOptions.renderer.pixi.metrics&&u.find(".pixijs-renderer__metrics").html(_.map(m.metrics,function(e,t){if(_.isObject(e)){var o=t+":<ul>";return o+=_.map(e,function(e,t){return"<li>"+t+": "+e+"</li>"}).join("")}return t+": "+e}).join("<br>"))},1e3);var S=c.$applyAsync;u.bind("mousedown touchstart",function(e){return e.originalEvent&&e.originalEvent.changedTouches&&(e=e.originalEvent.changedTouches[0]),c.Room.panActive={x:e.pageX,y:e.pageY},S(),!1}),u.bind("mousemove touchmove",function(e){e.originalEvent&&e.originalEvent.changedTouches&&(e=e.originalEvent.changedTouches[0]),d={x:e.pageX,y:e.pageY}}),u.bind("mouseleave touchend",function(){d=null}),u.bind("wheel",function(e){Math.abs(e.originalEvent.deltaY)<3||c.$apply(function(){e.originalEvent.deltaY<0?c.Room.zoomIn():c.Room.zoomOut()})}),c.$watch(function(){return c.Room.zoomLevel},function(){if(h){var e=u.width()/2,t=u.height()/2;d&&(e=d.x-u.offset().left,t=d.y-u.offset().top);var o="native"==c.Room.displayOptions.renderer.pixi.hd?Math.max(1,window.devicePixelRatio||1):1;m.zoomTo(c.Room.zoom/250*o,e*o,t*o),b()}});var M=function(e){e.originalEvent&&e.originalEvent.changedTouches&&(e=e.originalEvent.changedTouches[0]);var t="native"==c.Room.displayOptions.renderer.pixi.hd?Math.max(1,window.devicePixelRatio||1):1;c.Room.panActive&&(m.pan((e.pageX-c.Room.panActive.x)*t,(e.pageY-c.Room.panActive.y)*t),c.Room.panActive={x:e.pageX,y:e.pageY},b()),S()},T=function(e){c.$applyAsync(function(){c.Room.panActive=null})};n.bind("mousemove touchmove",M),n.bind("mouseup touchend",T),$(window).bind("resize",w),c.$on("$destroy",function(){n.unbind("mousemove touchmove",M),n.unbind("mouseup touchend",T),$(window).unbind("resize",w)})}}}]),mod.directive("appGameRendererTransitionDuration",function(){return{require:"^appGameRenderer",link:function(e,t,o,r){e.$watch(function(){return r.tickDuration},function(){$(t).css({"transition-duration":r.tickDuration+"s"})})}}}),mod.filter("orderByNameNumerically",["$filter",function(e){return function(t){return _.isObject(t)&&!_.isArray(t)?((t=e("keyFilter")(t)).sort(function(e,t){return parseInt(e.$name)-parseInt(t.$name)}),t):t}}]),(mod=angular.module("app.game.source",[])).controller("Source",["$scope",function(e){e.Math=Math}]),mod.directive("appGameSource",function(){return{scope:{objectData:"=",displayOptions:"="},templateUrl:"components/game/room/source/source.html?bust=1561537540072",bindToController:!0,controller:"Source as Source"}}),(mod=angular.module("app.game.spawn",[])).controller("Spawn",["$scope","$rootScope","Tutorial","Connection",function(e,t,o,r){var n=this;e.Math=Math,this.isSpawning=function(){return n.objectData.spawning}}]),mod.directive("appGameSpawn",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",users:"="},templateUrl:"components/game/room/spawn/spawn.html?bust=1561537540072",bindToController:!0,controller:"Spawn as Spawn"}}),(mod=angular.module("app.game.storage",[])).controller("Storage",["$scope","Connection","Constants",function(e,t,o){var r=this;e.Math=Math,e.Constants=o;var n=function(){r.resourcesTotal=0,o.RESOURCES_ALL.forEach(function(e){r.objectData[e]&&(r.resourcesTotal+=r.objectData[e])})};e.$on("roomObjectsUpdated",n),n()}]),mod.directive("appGameStorage",function(){return{scope:{objectData:"=",displayOptions:"=",player:"="},templateUrl:"components/game/room/storage/storage.html?bust=1561537540072",bindToController:!0,controller:"Storage as Storage"}}),(mod=angular.module("app.game.terminal",[])).controller("Terminal",["$scope","$element","Connection","Constants",function(e,t,o,r){var n=this;e.Math=Math,e._=_,e.Constants=r;var a=function(){n.resourcesTotal=0,r.RESOURCES_ALL.forEach(function(e){n.objectData[e]&&(n.resourcesTotal+=n.objectData[e])})};e.$on("roomObjectsUpdated",function(){a(),n.objectData.cooldownTime>n.gameTime&&$(t).find("animate").each(function(e,t){return t.beginElement()})}),a()}]),mod.directive("appGameTerminal",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",speed:"=",gameTime:"="},templateUrl:"components/game/room/terminal/terminal.html?bust=1561537540072",bindToController:!0,controller:"Terminal as Terminal"}}),(mod=angular.module("app.game.tower",[])).controller("Tower",["$scope","$element","Connection","$timeout",function(e,t,o,r){var n=this;e.Math=Math,e._=_,this.animActive=!1,this.rotate=Math.random()*Math.PI*2,this.shotAnim=void 0;e.$on("roomObjectsUpdated",function(){n.animActive=!0,n.workAnim=null,n.objectData.actionLog&&(n.objectData.actionLog.attack||n.objectData.actionLog.heal||n.objectData.actionLog.repair)?(n.shotAnim=_.cloneDeep(n.objectData.actionLog.attack||n.objectData.actionLog.heal||n.objectData.actionLog.repair),n.shotAnim.type=n.objectData.actionLog.attack?"attack":n.objectData.actionLog.heal?"heal":"repair",function(e,t){var o=e-n.objectData.x,r=t-n.objectData.y,a=(0==o?r>0?-Math.PI/2:Math.PI/2:Math.atan(r/o))-Math.PI/2;for(o>0&&(a+=Math.PI);a-n.rotate>Math.PI;)a-=2*Math.PI;for(;a-n.rotate<-Math.PI;)a+=2*Math.PI;n.rotate=a}(n.shotAnim.x,n.shotAnim.y),$(t).find(".anim-shot animate").each(function(e,t){return t.beginElement()}),n.objectData.actionLog.repair&&(n.workAnim={size:46,x:n.objectData.actionLog.repair.x,y:n.objectData.actionLog.repair.y},r(function(){return $(t).find(".anim-work animate").each(function(e,t){return t.beginElement()})},0))):n.shotAnim=null})}]),mod.directive("appGameTower",function(){return{scope:{objectData:"=",displayOptions:"=",player:"=",speed:"="},templateUrl:"components/game/room/tower/tower.html?bust=1561537540072",bindToController:!0,controller:"Tower as Tower"}}),mod.directive("appGameTowerAutoRotate",function(){return{require:"^appGameTower",link:function(e,t,o,r){var n=!1,a=(Date.now(),-1),i=Date.now();!function o(){n||(!r.shotAnim&&Date.now()>i+1e4&&(r.rotate=Math.random()*Math.PI*2,i=Date.now()),r.shotAnim&&(i=Date.now()),a!=r.rotate&&t.css({transform:"rotate("+r.rotate+"rad)",transition:e.Tower.displayOptions.renderer.svg.animations?"transform "+(r.shotAnim?"0.1s":"2s"):"none"}),Date.now(),a=r.rotate,setTimeout(o,30))}(),e.$on("$destroy",function(){return n=!0})}}}),(mod=angular.module("app.game.room.view-popup",[])).controller("ViewPopup",["$scope","Tutorial","$rootScope",function(e,t,o){var r=this;this.visible=!1,this.select=function(n){e.Room.selectedObject=n,o.$broadcast("roomObjectSelected",n),r.visible=!1,t.trigger("view",{object:n}),e.Room.rotateCreepOnClick&&"creep"==n.type&&e.$broadcast("rotateCreep",{_id:n._id})}}]),mod.directive("appViewPopup",["$document","MemoryStorage","$timeout",function(e,t,o){return{templateUrl:"components/game/room/view-popup/view-popup.html?bust=1561537540072",controller:"ViewPopup as ViewPopup",bindToController:!0,link:function(t,r,n,a){t.$on("view",function(e,r){t.Room.selectedObject=null,o(function(){a.mouseX=(r.event.offsetX||r.event.clientX-$(r.event.target).offset().left)+10,a.mouseY=(r.event.offsetY||r.event.clientY-$(r.event.target).offset().top)+10;var e=t.Room.objects,o=t.Room.flags;a.objects=_.filter([].concat(e,o),function(e){return!e.temp&&(("creep"!=e.type||!e.spawning)&&(e.x==t.Room.cursorPos.x&&e.y==t.Room.cursorPos.y&&"wall"!=e.type&&"swamp"!=e.type&&"exit"!=e.type))}),a.visible=a.objects.length>1,1==a.objects.length&&a.select(a.objects[0]),0==a.objects.length&&a.select(null)},0)}),$(e).click(function(){t.$apply(function(){return a.visible=!1})})}}}]);var time2=0;(mod=angular.module("app.game.room.walls",[])).factory("RoomWalls",["Connection",function(e){return function(e,t,o){performance.now();for(var r="",n={},a={},i=0;i<50;i++)n[i]={},a[i]={};for(var s=0;s<e.length;s++)if(e[s])_.forEach(e[s],function(e){t(e)&&(n[e.x][e.y]=e),a[e.x][e.y]=!1});else if(0==s)return"";function c(e,t){e>0&&t>0&&!n[e-1][t]?r+="a 50 50 0 0 0 -50 -50 h 50 ":r+="v -50 "}function u(e,t){t>0&&e>0&&!n[e][t-1]?r+="v -50 a 50 50 0 0 0 50 50 ":r+="h 50 "}function l(e,t){0==e||n[e-1][t]||0==t||n[e][t-1]?r+="v -50 h 50 ":r+="a 50 50 0 0 1 50 -50 "}function p(e,t){t>0&&e<49&&!n[e][t-1]?r+="a 50 50 0 0 0 50 -50 v 50 ":r+="h 50 "}function m(e,t){e<49&&t>0&&!n[e+1][t]?r+="h 50 a 50 50 0 0 0 -50 50 ":r+="v 50 "}function d(e,t){49==e||n[e+1][t]||0==t||n[e][t-1]?r+="h 50 v 50 ":r+="a 50 50 0 0 1 50 50 "}function h(e,t){49==e||n[e+1][t]||49==t||n[e][t+1]||n[e+1][t+1]&&n[e+1][t]?r+="v 50 h -50 ":r+="a 50 50 0 0 1 -50 50 "}function f(e,t){0==e||n[e-1][t]||49==t||n[e][t+1]||n[e-1][t+1]&&n[e-1][t]?r+="h -50 v -50 ":r+="a 50 50 0 0 1 -50 -50 "}function g(e,t,i,s){a[e][t]?r+=i?"v 100 ":"h -100 ":(o?i?(r+="h 100 ",e<49&&n[e+1][t]?g(e+1,t,1,0):r+="v 100 ",r+="h -100 "):(r+="v 100 ",t<49&&n[e][t+1]?g(e,t+1,0,1):r+="h -100 ",r+="v -100 "):i?(0==e||0==t||n[e-1][t-1]&&(n[e-1][t]||n[e][t-1])?u(e,t):r+="h 50 ",e<49&&n[e+1][t]?(49==e||0==t||n[e+1][t-1]&&(n[e+1][t]||n[e][t-1])?p(e,t):r+="h 50 ",g(e+1,t,1,0),r+="h -100 "):(49==e||0==t||n[e+1][t-1]&&(n[e+1][t]||n[e][t-1])?(p(e,t),m(e,t)):d(e,t),h(e,t),r+="h -50 ")):(49==e||0==t||n[e+1][t-1]&&(n[e+1][t]||n[e][t-1])?m(e,t):r+="v 50 ",t<49&&n[e][t+1]?(r+="v 50 ",g(e,t+1,0,1),r+="v -50 "):(h(e,t),f(e,t)),0==e||0==t||n[e-1][t-1]?c(e,t):r+="v -50 "),e<50&&t<50&&(a[e][t]=!0))}for(i=0;i<50;i++)for(var v=0;v<50;v++)if(n[i][v]&&!a[i][v]){r+=o?"M "+100*i+" "+100*v+" ":"M "+100*i+" "+(100*v+50)+" ",a[i][v]=!0;var y=0;do{y++}while(i+y<50&&n[i+y][v]);var b=0;do{b++}while(v+b<50&&n[i][v+b]);b<y?(o?r+="h 100 ":0==i||0==v||n[i-1][v-1]&&(n[i-1][v]||n[i][v-1])?(c(i,v),u(i,v)):l(i,v),i<49&&n[i+1][v]?(o||(49==i||0==v||n[i+1][v-1]&&(n[i+1][v]||n[i][v-1])?p(i,v):r+="h 50 "),g(i+1,v,1),o||(r+="h -50 ")):o?r+="v 100 ":(49==i||0==v||n[i+1][v-1]&&(n[i+1][v]||n[i][v-1])?(p(i,v),m(i,v)):d(i,v),h(i,v)),o?r+="h -100 v -100 ":f(i,v)):(o?r+="h 100 v 100 ":(0==i||0==v||n[i-1][v-1]&&(n[i-1][v]||n[i][v-1])?(c(i,v),u(i,v)):l(i,v),49==i||0==v||n[i+1][v-1]&&(n[i+1][v]||n[i][v-1])?(p(i,v),m(i,v)):d(i,v)),v<49&&n[i][v+1]?(o||(r+="v 50 "),g(i,v+1,0),o||(r+="v -50 ")):o?r+="h -100 ":(h(i,v),f(i,v)),o&&(r+="v -100 ")),r+="Z "}return r}}]),(mod=angular.module("app.game.shards",[])).config(["$routeSegmentProvider",function(e){e.when("/shards2","top.shards2").within("top").segment("shards2",{templateUrl:"components/game/shards/shards.html?bust=1561537540072",controller:"Top.Shards as Shards",resolve:{data:ngInject(["ShardsLoader",function(e){return e.load()}])}})}]),mod.factory("ShardsLoader",["Loader","Api",function(e,t){return e.factory(function(){return{shards:t.get("game/shards/info").then(function(e){return e.shards})}})}]),mod.controller("Top.Shards",["$scope","data","Auth","Dialogs","Api",function(e,t,o,r,n){var a=this;o.required(),this.data=t,this.assignCpuMode=!1,this.assignCpu={},this.startAssignCpuMode=function(){t.shards.forEach(function(e){return a.assignCpu[e.name]=o.Me.cpuShard[e.name]||0}),a.sumCpu=_.sum(a.assignCpu),a.assignCpuMode=!0},this.onChangeCpu=function(e){a.assignCpu[e.shard.name]=+a.assignCpu[e.shard.name];var t=_.reduce(a.assignCpu,function(t,o,r){return r!=e.shard.name&&(t[r]=o),t},{}),o=_.sum(t),r=_.mapValues(t,function(e){return o>0?e/o:1/Object.keys(t).length});_.shuffle(Object.keys(t)).every(function(t){return a.assignCpu[t]=Math.min(a.assignCpu[t],Math.floor((a.sumCpu-a.assignCpu[e.shard.name])*r[t])),a.sumCpu!==_.sum(a.assignCpu)}),a.balance=a.sumCpu-_.sum(a.assignCpu)},this.canReassignCpu=function(){return o.Me.cpuShardUpdatedTime>=Date.now()-432e5},this.onSaveCpu=function(){return r.ask({message:"<p>You're going to re-assign your CPU to the following shards:</p>\n                      <ul>"+_.keys(a.assignCpu).map(function(e){return"<li>"+e+": <b>"+a.assignCpu[e]+" CPU</b></li>"}).join("")+"</ul>\n                      <p>You will not be able to change these settings in the next <b>12 hours</b>! Do you want to proceed?</p>",buttonClass:"md-warn md-hue-2",callback:function(){return n.post("user/cpu-shards",{cpu:a.assignCpu})}}).result.then(o.check).then(function(){return a.assignCpuMode=!1})}}]),(mod=angular.module("app.game.tutorial.section1",[])).run(["TutorialCode","TutorialSteps","MemoryStorage","Connection",function(e,t,o,r){e.section1={main:"module.exports.loop = function () {\n\n}"},t.section1={1:{},2:{selector:".room-controls .md-button:last-child img",snap:{top:!0,center:!0}},3:{gameObjectSelector:{type:"spawn"},snap:{top:!0,center:!0}},4:{selector:".console-tab",snap:{bottom:!0,left:!0},trigger:function(e){return"consoleClick"==e}},5:{selector:"section.console .console-input .tutorial-dummy",snap:{bottom:!0,left:!0},trigger:function(e){return"sendConsole"==e}},6:{selector:"section.console .console-message:last-child",snap:{bottom:!0,left:!0},anchor:{left:!0,offset:100}},7:{trigger:function(e,t){return"creep"==e&&"Harvester1"==t.creep.name&&!t.creep.spawning},codeHint:"Game.spawns['Spawn1'].spawnCreep( [WORK, CARRY, MOVE], 'Harvester1' );"},8:{gameObjectSelector:{type:"creep"},snap:{top:!0,center:!0}},9:{selector:".room-controls .md-button:first-child img",snap:{top:!0,center:!0}},10:{gameObjectSelector:{type:"creep"},snap:{bottom:!0,center:!0},trigger:function(e,t){return"view"==e}},11:{selector:"section.room aside .object-properties label:first-child",snap:{top:!0,right:!0}},12:{gameObjectSelector:{type:"source"},snap:{top:!0,center:!0}},13:{selector:".script-tab",snap:{bottom:!0,left:!0},anchor:{offset:20},trigger:function(e){return"scriptClick"==e}},14:{selector:"section.script button.submit",snap:{bottom:!0,left:!0},anchor:{offset:10}},15:{trigger:function(e,t){return"creep"==e&&"Harvester1"==t.creep.name&&t.creep.energy>0},codeHint:"module.exports.loop = function () {\n    var creep = Game.creeps['Harvester1'];\n    var sources = creep.room.find(FIND_SOURCES);\n    if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n        creep.moveTo(sources[0]);\n    }\n}"},16:{gameObjectSelector:{type:"creep"},snap:{top:!0,center:!0}},17:{trigger:function(e,t){return"creep"==e&&"Harvester1"==t.creep.name&&t.creep.x<=26},codeHint:"module.exports.loop = function () {\n    var creep = Game.creeps['Harvester1'];\n\n    if(creep.carry.energy < creep.carryCapacity) {\n        var sources = creep.room.find(FIND_SOURCES);\n        if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n            creep.moveTo(sources[0]);\n        }\n    }\n    else {\n        if( creep.transfer(Game.spawns['Spawn1'], RESOURCE_ENERGY) == ERR_NOT_IN_RANGE ) {\n            creep.moveTo(Game.spawns['Spawn1']);\n        }\n    }\n}"},18:{trigger:function(e,t){return"creep"==e&&"Harvester2"==t.creep.name&&!t.creep.spawning},codeHint:"Game.spawns['Spawn1'].spawnCreep( [WORK, CARRY, MOVE], 'Harvester2' );"},19:{trigger:function(e,t){return"creep"==e&&"Harvester2"==t.creep.name&&t.creep.x>26},codeHint:"module.exports.loop = function () {\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n\n        if(creep.carry.energy < creep.carryCapacity) {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0]);\n            }\n        }\n        else {\n            if(creep.transfer(Game.spawns['Spawn1'], RESOURCE_ENERGY) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(Game.spawns['Spawn1']);\n            }\n        }\n    }\n}"},20:{trigger:function(e,t){return"submitScript"==e&&t.modules["role.harvester"]},codeHint:"var roleHarvester = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\t    if(creep.carry.energy < creep.carryCapacity) {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0]);\n            }\n        }\n        else {\n            if(creep.transfer(Game.spawns['Spawn1'], RESOURCE_ENERGY) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(Game.spawns['Spawn1']);\n            }\n        }\n\t}\n};\n\nmodule.exports = roleHarvester;"},21:{trigger:function(e,t){return"submitScript"==e&&/require/.test(t.modules.main)},codeHint:"var roleHarvester = require('role.harvester');\n\nmodule.exports.loop = function () {\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        roleHarvester.run(creep);\n    }\n}"},22:{}}}]),(mod=angular.module("app.game.tutorial.section2",[])).run(["TutorialCode","TutorialSteps","MemoryStorage","Connection",function(e,t,o,r){e.section2={main:"var roleHarvester = require('role.harvester');\n\nmodule.exports.loop = function () {\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        roleHarvester.run(creep);\n    }\n}","role.harvester":"var roleHarvester = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\t    if(creep.carry.energy < creep.carryCapacity) {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0]);\n            }\n        }\n        else if(Game.spawns['Spawn1'].energy < Game.spawns['Spawn1'].energyCapacity) {\n            if(creep.transfer(Game.spawns['Spawn1'], RESOURCE_ENERGY) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(Game.spawns['Spawn1']);\n            }\n        }\n\t}\n};\n\nmodule.exports = roleHarvester;"},t.section2={1:{gameObjectSelector:{type:"controller"},snap:{top:!0,center:!0}},2:{trigger:function(e,t){return"creep"==e&&"Upgrader1"==t.creep.name&&!t.creep.spawning},codeHint:"Game.spawns['Spawn1'].spawnCreep( [WORK, CARRY, MOVE], 'Upgrader1' );"},3:{gameObjectSelector:{type:"creep",name:"Upgrader1",spawning:!1},snap:{top:!0,center:!0}},4:{trigger:function(e,t){if("creep"==e&&"Upgrader1"==t.creep.name){var r=o.get("users.memory"),n=JSON.parse(r[0].memory);return _.isObject(n.creeps)&&_.isObject(n.creeps.Upgrader1)&&"upgrader"==n.creeps.Upgrader1.role}},codeHint:"Game.creeps['Harvester1'].memory.role = 'harvester';\nGame.creeps['Upgrader1'].memory.role = 'upgrader';"},5:{trigger:function(e,t){return"submitScript"==e&&t.modules["role.upgrader"]},codeHint:"var roleUpgrader = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\t    if(creep.carry.energy == 0) {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0]);\n            }\n        }\n        else {\n            if(creep.upgradeController(creep.room.controller) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(creep.room.controller);\n            }\n        }\n\t}\n};\n\nmodule.exports = roleUpgrader;"},6:{trigger:function(e,t){return"controller"==e&&2==t.controller.level},codeHint:"var roleHarvester = require('role.harvester');\nvar roleUpgrader = require('role.upgrader');\n\nmodule.exports.loop = function () {\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'upgrader') {\n            roleUpgrader.run(creep);\n        }\n    }\n}"},7:{gameObjectSelector:{type:"controller"},snap:{top:!0,center:!0}}}}]),(mod=angular.module("app.game.tutorial.section3",[])).run(["TutorialCode","TutorialSteps","MemoryStorage","Connection","$timeout",function(e,t,o,r,n){e.section3={main:"var roleHarvester = require('role.harvester');\n\nmodule.exports.loop = function () {\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n    }\n}","role.harvester":"var roleHarvester = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\t    if(creep.carry.energy < creep.carryCapacity) {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0]);\n            }\n        }\n        else if(Game.spawns['Spawn1'].energy < Game.spawns['Spawn1'].energyCapacity) {\n            if(creep.transfer(Game.spawns['Spawn1'], RESOURCE_ENERGY) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(Game.spawns['Spawn1']);\n            }\n        }\n\t}\n};\n\nmodule.exports = roleHarvester;"},t.section3={1:{init:function(){var e=o.get("users.memory"),t=JSON.parse(e[0].memory);t.creeps={Harvester1:{role:"harvester"}},e[0].memory=JSON.stringify(t)}},2:{gameObjectSelector:{type:"constructionSite"},snap:{top:!0,center:!0}},3:{trigger:function(e,t){return"creep"==e&&"Builder1"==t.creep.name&&!t.creep.spawning},codeHint:"Game.spawns['Spawn1'].spawnCreep( [WORK, CARRY, MOVE], 'Builder1',\n    { memory: { role: 'builder' } } );"},4:{gameObjectSelector:{type:"creep",name:"Builder1",spawning:!1},snap:{top:!0,center:!0}},5:{trigger:function(e,t){return"submitScript"==e&&t.modules["role.builder"]},codeHint:"var roleBuilder = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\n\t    if(creep.memory.building && creep.carry.energy == 0) {\n            creep.memory.building = false;\n            creep.say('🔄 harvest');\n\t    }\n\t    if(!creep.memory.building && creep.carry.energy == creep.carryCapacity) {\n\t        creep.memory.building = true;\n\t        creep.say('🚧 build');\n\t    }\n\n\t    if(creep.memory.building) {\n\t        var targets = creep.room.find(FIND_CONSTRUCTION_SITES);\n            if(targets.length) {\n                if(creep.build(targets[0]) == ERR_NOT_IN_RANGE) {\n                    creep.moveTo(targets[0], {visualizePathStyle: {stroke: '#ffffff'}});\n                }\n            }\n\t    }\n\t    else {\n\t        var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n            }\n\t    }\n\t}\n};\n\nmodule.exports = roleBuilder;"},6:{trigger:function(e,t){if("objectsEnd"==e)return 5==_(t.objects).filter({type:"extension"}).size()},codeHint:"var roleHarvester = require('role.harvester');\nvar roleBuilder = require('role.builder');\n\nmodule.exports.loop = function () {\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'builder') {\n            roleBuilder.run(creep);\n        }\n    }\n}"},7:{gameObjectSelector:{type:"extension"},snap:{top:!0,center:!0}},8:{trigger:function(e,t){return"submitScript"==e&&/STRUCTURE_EXTENSION/.test(t.modules["role.harvester"])},codeHint:"var roleHarvester = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\t    if(creep.carry.energy < creep.carryCapacity) {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n            }\n        }\n        else {\n            var targets = creep.room.find(FIND_STRUCTURES, {\n                    filter: (structure) => {\n                        return (structure.structureType == STRUCTURE_EXTENSION || structure.structureType == STRUCTURE_SPAWN) &&\n                            structure.energy < structure.energyCapacity;\n                    }\n            });\n            if(targets.length > 0) {\n                if(creep.transfer(targets[0], RESOURCE_ENERGY) == ERR_NOT_IN_RANGE) {\n                    creep.moveTo(targets[0], {visualizePathStyle: {stroke: '#ffffff'}});\n                }\n            }\n        }\n\t}\n};\n\nmodule.exports = roleHarvester;"},9:{trigger:function(e,t){if("objectsEnd"==e)return 5==_(t.objects).filter({type:"extension",energy:50}).size()&&300==_.find(t.objects,{type:"spawn"}).energy},codeHint:"var roleHarvester = require('role.harvester');\nvar roleBuilder = require('role.builder');\n\nmodule.exports.loop = function () {\n\n    for(var name in Game.rooms) {\n        console.log('Room \"'+name+'\" has '+Game.rooms[name].energyAvailable+' energy');\n    }\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'builder') {\n            roleBuilder.run(creep);\n        }\n    }\n}"},10:{gameObjectSelector:{type:"extension"},snap:{top:!0,center:!0}},11:{trigger:function(e,t){return"creep"==e&&"HarvesterBig"==t.creep.name&&!t.creep.spawning},codeHint:"Game.spawns['Spawn1'].spawnCreep( [WORK,WORK,WORK,WORK,CARRY,MOVE,MOVE],\n    'HarvesterBig',\n    { memory: { role: 'harvester' } } );"},12:{gameObjectSelector:{type:"creep",name:"HarvesterBig",spawning:!1},snap:{top:!0,center:!0},trigger:function(e,t){return"view"==e}},13:{selector:"section.room aside .object-properties .body",snap:{bottom:!0,right:!0}},14:{}}}]),(mod=angular.module("app.game.tutorial.section4",[])).run(["TutorialCode","TutorialSteps","MemoryStorage","Connection",function(e,t,o,r){e.section4={main:"var roleHarvester = require('role.harvester');\nvar roleUpgrader = require('role.upgrader');\n\nmodule.exports.loop = function () {\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'upgrader') {\n            roleUpgrader.run(creep);\n        }\n    }\n}","role.harvester":"var roleHarvester = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\t    if(creep.carry.energy < creep.carryCapacity) {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n            }\n        }\n        else {\n            var targets = creep.room.find(FIND_STRUCTURES, {\n                    filter: (structure) => {\n                        return (structure.structureType == STRUCTURE_EXTENSION || structure.structureType == STRUCTURE_SPAWN) &&\n                            structure.energy < structure.energyCapacity;\n                    }\n            });\n            if(targets.length > 0) {\n                if(creep.transfer(targets[0], RESOURCE_ENERGY) == ERR_NOT_IN_RANGE) {\n                    creep.moveTo(targets[0], {visualizePathStyle: {stroke: '#ffffff'}});\n                }\n            }\n        }\n\t}\n};\n\nmodule.exports = roleHarvester;","role.upgrader":"var roleUpgrader = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\n        if(creep.memory.upgrading && creep.carry.energy == 0) {\n            creep.memory.upgrading = false;\n            creep.say('🔄 harvest');\n\t    }\n\t    if(!creep.memory.upgrading && creep.carry.energy == creep.carryCapacity) {\n\t        creep.memory.upgrading = true;\n\t        creep.say('⚡ upgrade');\n\t    }\n\n\t    if(creep.memory.upgrading) {\n            if(creep.upgradeController(creep.room.controller) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(creep.room.controller, {visualizePathStyle: {stroke: '#ffffff'}});\n            }\n        }\n        else {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n            }\n        }\n\t}\n};\n\nmodule.exports = roleUpgrader;"},t.section4={1:{init:function(){var e=o.get("users.memory"),t=JSON.parse(e[0].memory);t.creeps={Harvester1:{role:"harvester"},Harvester2:{role:"harvester"},Upgrader1:{role:"upgrader"}},e[0].memory=JSON.stringify(t)}},2:{trigger:function(e,t){return"submitScript"==e&&/console\.log/.test(t.modules.main)&&/filter/.test(t.modules.main)},codeHint:"var roleHarvester = require('role.harvester');\nvar roleUpgrader = require('role.upgrader');\n\nmodule.exports.loop = function () {\n\n    var harvesters = _.filter(Game.creeps, (creep) => creep.memory.role == 'harvester');\n    console.log('Harvesters: ' + harvesters.length);\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'upgrader') {\n            roleUpgrader.run(creep);\n        }\n    }\n}"},3:{trigger:function(e,t){return"submitScript"==e&&/spawnCreep/.test(t.modules.main)},codeHint:"var roleHarvester = require('role.harvester');\nvar roleUpgrader = require('role.upgrader');\n\nmodule.exports.loop = function () {\n\n    var harvesters = _.filter(Game.creeps, (creep) => creep.memory.role == 'harvester');\n    console.log('Harvesters: ' + harvesters.length);\n\n    if(harvesters.length < 2) {\n        var newName = 'Harvester' + Game.time;\n        console.log('Spawning new harvester: ' + newName);\n        Game.spawns['Spawn1'].spawnCreep([WORK,CARRY,MOVE], newName, \n            {memory: {role: 'harvester'}});        \n    }\n    \n    if(Game.spawns['Spawn1'].spawning) { \n        var spawningCreep = Game.creeps[Game.spawns['Spawn1'].spawning.name];\n        Game.spawns['Spawn1'].room.visual.text(\n            '🛠️' + spawningCreep.memory.role,\n            Game.spawns['Spawn1'].pos.x + 1, \n            Game.spawns['Spawn1'].pos.y, \n            {align: 'left', opacity: 0.8});\n    }\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'upgrader') {\n            roleUpgrader.run(creep);\n        }\n    }\n}"},4:{trigger:function(e,t){if("objectsEnd"==e)return _.filter(t.objects,function(e){return/Harvester/.test(e.name)}).length<2},codeHint:"Game.creeps['Harvester1'].suicide()"},5:{gameObjectSelector:{type:"spawn"},snap:{top:!0,center:!0}},6:{trigger:function(e,t){if("objectsEnd"==e){var r=o.get("users.memory"),n=JSON.parse(r[0].memory);return _.isObject(n.creeps)&&(!n.creeps.Harvester1||!n.creeps.Harvester2)}},codeHint:"var roleHarvester = require('role.harvester');\nvar roleUpgrader = require('role.upgrader');\n\nmodule.exports.loop = function () {\n\n    for(var name in Memory.creeps) {\n        if(!Game.creeps[name]) {\n            delete Memory.creeps[name];\n            console.log('Clearing non-existing creep memory:', name);\n        }\n    }\n\n    var harvesters = _.filter(Game.creeps, (creep) => creep.memory.role == 'harvester');\n    console.log('Harvesters: ' + harvesters.length);\n\n    if(harvesters.length < 2) {\n        var newName = 'Harvester' + Game.time;\n        console.log('Spawning new harvester: ' + newName);\n        Game.spawns['Spawn1'].spawnCreep([WORK,CARRY,MOVE], newName, \n            {memory: {role: 'harvester'}});\n    }\n    \n    if(Game.spawns['Spawn1'].spawning) { \n        var spawningCreep = Game.creeps[Game.spawns['Spawn1'].spawning.name];\n        Game.spawns['Spawn1'].room.visual.text(\n            '🛠️' + spawningCreep.memory.role,\n            Game.spawns['Spawn1'].pos.x + 1, \n            Game.spawns['Spawn1'].pos.y, \n            {align: 'left', opacity: 0.8});\n    }\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'upgrader') {\n            roleUpgrader.run(creep);\n        }\n    }\n}"},7:{}}}]),(mod=angular.module("app.game.tutorial.section5",[])).run(["TutorialCode","TutorialSteps","MemoryStorage","Connection",function(e,t,o,r){e.section5={main:"var roleHarvester = require('role.harvester');\nvar roleUpgrader = require('role.upgrader');\nvar roleBuilder = require('role.builder');\n\nmodule.exports.loop = function () {\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'upgrader') {\n            roleUpgrader.run(creep);\n        }\n        if(creep.memory.role == 'builder') {\n            roleBuilder.run(creep);\n        }\n    }\n}","role.harvester":"var roleHarvester = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\t    if(creep.carry.energy < creep.carryCapacity) {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n            }\n        }\n        else {\n            var targets = creep.room.find(FIND_STRUCTURES, {\n                    filter: (structure) => {\n                        return (structure.structureType == STRUCTURE_EXTENSION || structure.structureType == STRUCTURE_SPAWN) &&\n                            structure.energy < structure.energyCapacity;\n                    }\n            });\n            if(targets.length > 0) {\n                if(creep.transfer(targets[0], RESOURCE_ENERGY) == ERR_NOT_IN_RANGE) {\n                    creep.moveTo(targets[0], {visualizePathStyle: {stroke: '#ffffff'}});\n                }\n            }\n        }\n\t}\n};\n\nmodule.exports = roleHarvester;","role.upgrader":"var roleUpgrader = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\n        if(creep.memory.upgrading && creep.carry.energy == 0) {\n            creep.memory.upgrading = false;\n            creep.say('🔄 harvest');\n\t    }\n\t    if(!creep.memory.upgrading && creep.carry.energy == creep.carryCapacity) {\n\t        creep.memory.upgrading = true;\n\t        creep.say('⚡ upgrade');\n\t    }\n\n\t    if(creep.memory.upgrading) {\n            if(creep.upgradeController(creep.room.controller) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(creep.room.controller, {visualizePathStyle: {stroke: '#ffffff'}});\n            }\n        }\n        else {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n            }\n        }\n\t}\n};\n\nmodule.exports = roleUpgrader;","role.builder":"var roleBuilder = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\n\t    if(creep.memory.building && creep.carry.energy == 0) {\n            creep.memory.building = false;\n            creep.say('🔄 harvest');\n\t    }\n\t    if(!creep.memory.building && creep.carry.energy == creep.carryCapacity) {\n\t        creep.memory.building = true;\n\t        creep.say('🚧 build');\n\t    }\n\n\t    if(creep.memory.building) {\n\t        var targets = creep.room.find(FIND_CONSTRUCTION_SITES);\n            if(targets.length) {\n                if(creep.build(targets[0]) == ERR_NOT_IN_RANGE) {\n                    creep.moveTo(targets[0], {visualizePathStyle: {stroke: '#ffffff'}});\n                }\n            }\n\t    }\n\t    else {\n\t        var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n            }\n\t    }\n\t}\n};\n\nmodule.exports = roleBuilder;"},t.section5={1:{init:function(){var e=o.get("users.memory"),t=JSON.parse(e[0].memory);t.creeps={Harvester1:{role:"harvester"},Builder1:{role:"builder"},Upgrader1:{role:"upgrader"}},e[0].memory=JSON.stringify(t)}},2:{gameObjectSelector:{type:"creep"},snap:{center:!0,top:!0}},3:{trigger:function(e,t){return"objectsEnd"==e&&!!_.find(t.objects,{type:"controller"}).safeMode},codeHint:"Game.spawns['Spawn1'].room.controller.activateSafeMode();"},4:{gameObjectSelector:{type:"creep"},snap:{center:!0,top:!0}},5:{trigger:function(e,t){return"objectsEnd"==e&&_.any(t.objects,{type:"constructionSite",structureType:"tower"})},selector:".room-controls button:nth-child(3)",snap:{top:!0,center:!0},codeHint:"Game.spawns['Spawn1'].room.createConstructionSite( 23, 22, STRUCTURE_TOWER );"},6:{gameObjectSelector:{type:"creep",name:"Builder1"},snap:{top:!0,center:!0},trigger:function(e,t){return"objectsEnd"==e&&_.any(t.objects,{type:"tower"})}},7:{gameObjectSelector:{type:"tower"},snap:{top:!0,center:!0},trigger:function(e,t){return"objectsEnd"==e&&_.any(t.objects,function(e){return"tower"==e.type&&e.energy>0})},codeHint:"var roleHarvester = {\n\n    /** @param {Creep} creep **/\n    run: function(creep) {\n\t    if(creep.carry.energy < creep.carryCapacity) {\n            var sources = creep.room.find(FIND_SOURCES);\n            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {\n                creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n            }\n        }\n        else {\n            var targets = creep.room.find(FIND_STRUCTURES, {\n                    filter: (structure) => {\n                        return (structure.structureType == STRUCTURE_EXTENSION ||\n                                structure.structureType == STRUCTURE_SPAWN ||\n                                structure.structureType == STRUCTURE_TOWER) && structure.energy < structure.energyCapacity;\n                    }\n            });\n            if(targets.length > 0) {\n                if(creep.transfer(targets[0], RESOURCE_ENERGY) == ERR_NOT_IN_RANGE) {\n                    creep.moveTo(targets[0], {visualizePathStyle: {stroke: '#ffffff'}});\n                }\n            }\n        }\n\t}\n};\n\nmodule.exports = roleHarvester;"},8:{trigger:function(e,t){return"objectsEnd"==e&&!_.any(t.objects,{type:"creep",name:"invader1"})},codeHint:"var roleHarvester = require('role.harvester');\nvar roleUpgrader = require('role.upgrader');\nvar roleBuilder = require('role.builder');\n\nmodule.exports.loop = function () {\n\n    var tower = Game.getObjectById('{{TOWER_ID}}');\n    if(tower) {\n        var closestHostile = tower.pos.findClosestByRange(FIND_HOSTILE_CREEPS);\n        if(closestHostile) {\n            tower.attack(closestHostile);\n        }\n    }\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'upgrader') {\n            roleUpgrader.run(creep);\n        }\n        if(creep.memory.role == 'builder') {\n            roleBuilder.run(creep);\n        }\n    }\n}"},9:{gameObjectSelector:function(e){return"constructedWall"==e.type&&e.hits<3e8},snap:{top:!0,center:!0}},10:{trigger:function(e,t){return"objectsEnd"==e&&!_.any(t.objects,function(e){return"constructedWall"==e.type&&e.hits<3e8})},codeHint:"var roleHarvester = require('role.harvester');\nvar roleUpgrader = require('role.upgrader');\nvar roleBuilder = require('role.builder');\n\nmodule.exports.loop = function () {\n\n    var tower = Game.getObjectById('{{TOWER_ID}}');\n    if(tower) {\n        var closestDamagedStructure = tower.pos.findClosestByRange(FIND_STRUCTURES, {\n            filter: (structure) => structure.hits < structure.hitsMax\n        });\n        if(closestDamagedStructure) {\n            tower.repair(closestDamagedStructure);\n        }\n\n        var closestHostile = tower.pos.findClosestByRange(FIND_HOSTILE_CREEPS);\n        if(closestHostile) {\n            tower.attack(closestHostile);\n        }\n    }\n\n    for(var name in Game.creeps) {\n        var creep = Game.creeps[name];\n        if(creep.memory.role == 'harvester') {\n            roleHarvester.run(creep);\n        }\n        if(creep.memory.role == 'upgrader') {\n            roleUpgrader.run(creep);\n        }\n        if(creep.memory.role == 'builder') {\n            roleBuilder.run(creep);\n        }\n    }\n}"},11:{}}}]),(mod=angular.module("app.game.tutorial",[])).value("TutorialCode",{}),mod.value("TutorialSteps",{}),mod.factory("Tutorial",["$rootScope","$timeout","MemoryStorage","Connection","Constants","LocalStorage","Auth","$http","$templateCache","Dialogs","$modal","TutorialSteps","$routeSegment","Api","$location",function(e,t,o,r,n,a,i,s,c,u,l,p,m,d,h){var f,g=0,v=!1,y={tipFacebookLike:{},tipSteamReview:{wrapController:function(e){e.goToSteam=function(){window.nw?window.nw.Shell.openExternal("steam://store/464350"):window.open("http://store.steampowered.com/app/464350","_blank").focus(),e.close()}}},tipCpuLimitedShard:{},tipShard3:{},tipLegacyVm:{},tipLifetimeSale:{},tipChangelog:{selector:".navbar-header .navbar-brand",snap:{top:!0,left:!0},className:"color-primary width-auto no-controls"},tipPixiOptimized:{selector:".right-top-controls",snap:{top:!0,right:!0},className:"color-primary width-auto no-controls"},tipSvgRenderer:{selector:".right-top-controls",snap:{top:!0,right:!0},className:"color-primary width-auto no-controls"},tipIvmDefault:{wrapController:function(e){e.activateIvm=function(){return d.post("user/ivm",{legacy:!1}).then(function(){return i.check()}).then(function(){return e.close()})}}},tipUpgradeCtrl:{gameObjectSelector:{type:"controller"},snap:{bottom:!0,center:!0},className:"color-primary width-auto no-controls"},tipTipOfTheDay:{selector:".editor-panel .script-tab",snap:{bottom:!0,left:!0},className:"width-auto no-controls no-arrow"}},b={tipSvgRenderer:function(e,t){var o=+a.get("firstVisit",0,"");return"svg"==a.get("game.room.displayOptions",{}).rendererType&&o<1552637823269&&+a.get("tipSvgRenderer",0,"")<1552637823269&&_.contains(["roomEntered"],e)},tipLegacyVm:function(e,t){return i.Me&&i.Me.runtime&&i.Me.runtime.legacyVm&&+a.get("tipLegacyVm",0,"")<Date.now()-864e5&&_.contains(["worldMapEntered","roomEntered"],e)},tipLifetimeSale:function(e,t){return+a.get("firstVisit",0,"")<1561482198287&&Date.now()<15626916e5&&+a.get("tipLifetimeSale",0,"")<1561482198287&&_.contains(["worldMapEntered","roomEntered"],e)},tipPixiOptimized:function(e,t){var o=+a.get("firstVisit",0,""),r=a.get("game.room.displayOptions",{});return GameRenderer.isWebGLSupported()&&"pixi"==r.rendererType&&!r.renderer.pixi.webgl&&o<1552637823269&&+a.get("tipPixiOptimized",0,"")<1552637823269&&_.contains(["roomEntered"],e)},tipCpuLimitedShard:function(e,t){return d.options.official&&"shard3"==m.$routeParams.shard&&i.Me&&i.Me.cpuShard&&i.Me.cpuShard.shard3>20&&!a.get("tipCpuLimitedShard",0,"")&&_.contains(["worldMapEntered","roomEntered"],e)},tipChangelog:function(t,o){var r=+a.get("firstVisit",0,"");return!e.ptr&&r<1544796518148&&+a.get("tipChangelog",0,"")<1544796518148&&_.contains(["worldMapEntered","roomEntered","gameLobby","simulationMainMenu"],t)},tipFacebookLike:function(e,t){var o=a.get("firstVisit",0,"");return!window.nw&&(!i.Me||!i.Me.isSteamOwner())&&!a.get("tipFacebookLike",!1,"")&&_.contains(["worldMapEntered","simulationMainMenu"],e)&&o&&o<(new Date).getTime()-6048e5},tipSteamReview:function(e,t){var o=a.get("firstVisit",0,"");return(window.nw||i.Me&&i.Me.isSteamOwner())&&!a.get("tipSteamReview",!1,"")&&_.contains(["worldMapEntered","roomEntered","simulationMainMenu"],e)&&o&&o<(new Date).getTime()-6048e5},tipUpgradeCtrl:function(e,t){return 0==+a.get("tipUpgradeCtrl",0,"")&&"controllerDowngrade"==e&&t.controller&&"sim"!=t.controller.room},tipTipOfTheDay:function(e,t){var o=+a.get("tipTipOfTheDay",0,"");return 0==o||-1!=o&&(_.contains(["roomEntered"],e)&&Date.now()-864e5>o)}};return f={visible:!1,start:function(){if("top.sim-tutorial"==m.name)for(var e=1;e<=_.size(p["section"+m.$routeParams.section]);e++)s.get("components/game/tutorial/section"+m.$routeParams.section+"/step"+e+".html?bust=1561537540072",{cache:c});g=1;var t=this.getStepInfo();t&&t.init&&t.init(),this.show()},next:function(){var o=this;"top.sim-tutorial"==m.name&&(e.debug||(mixpanel.track("Tutorial: "+m.$routeParams.section+"/"+g),ga("send","event","Tutorial","Step "+m.$routeParams.section+"/"+g)),i.Me&&1==m.$routeParams.section&&21==g&&d.post("user/tutorial-done")),f.visible=!1,t(function(){v=!1,g++,o.show()},300)},trigger:function(e,t){var o=this.getStepInfo();if(!v&&o&&o.trigger&&o.trigger(e,t)&&(v=!0,this.next()),!g)for(var r in b)if(b[r](e,t)){y[r]&&(f.visible=!0,g=r,this.show()),a.put(r,(new Date).getTime(),""),"tipFacebookLike"==r&&(mixpanel.track("Facebook Like Asked"),ga("send","event","Facebook","Like Asked"));break}},show:function(){e.$broadcast("tutorialShow")},getStep:function(){return g},getStepInfo:function(){return"top.sim-tutorial"==m.name?p["section"+m.$routeParams.section][g]:y[g]},getStepTemplate:function(){return"top.sim-tutorial"==m.name?"section"+m.$routeParams.section+"/step"+this.getStep():this.getStep()},getStepCodeHint:function(){return p["section"+m.$routeParams.section][this.getStep()].codeHint},resetStep:function(){g=0,this.visible=!1}}}]),mod.directive("appTutorial",["Tutorial","$document","$window","$timeout","$location","$routeSegment","Connection","LocalStorage","MemoryStorage","$routeParams",function(e,t,o,r,n,a,i,s,c,u){return{controller:["$scope","$element","$rootScope",function(r,l,p){var m,d=this;r.TutorialService=e,this.quit=function(){p.$broadcast("gameSimulationReset"),e.visible=!1,e.resetStep();var t=a.getSegmentUrl("top.sim");u.anonymous&&(t+="?anonymous=1"),i.allowChangeUrl(t),n.url(t)},this.next=function(){e.next()},this.close=function(){e.visible=!1},this.finish=function(){var t=s.get("tutorialSectionsDone",{},"");t[a.$routeParams.section]=!0,s.put("tutorialSectionsDone",t,""),p.$broadcast("gameSimulationReset"),e.visible=!1,e.resetStep();var o=a.getSegmentUrl("top.sim.tutorial-index");u.anonymous&&(o+="?anonymous=1"),i.allowChangeUrl(o),n.url(o)},this.getClassName=function(){var t="tutorial-"+e.getStepTemplate(),o=e.getStepInfo();return o&&o.className&&(t+=" "+o.className),t};var h=function(t,r,n,a){var i=e.getStepInfo(),s={top:"auto",left:"auto",bottom:"auto",right:"auto"};d.snap=_.clone(i.snap),i.snap.top&&(s.top=t+a),i.snap.bottom&&(s.bottom=o.innerHeight-t),i.snap.left&&(s.left=r-32),i.snap.center&&(s.left=r-l.width()/2),i.snap.right&&(s.right=o.innerWidth-r-32),i.anchor&&i.anchor.left||(i.snap.left||i.snap.center?s.left+=n/2:s.right-=n/2),i.anchor&&i.anchor.offset&&(i.snap.left||i.snap.center?s.left+=i.anchor.offset:s.right-=i.anchor.offset),"auto"!=s.left&&(s.left=Math.round(s.left)+"px"),"auto"!=s.right&&(s.right=Math.round(s.right)+"px"),"auto"!=s.top&&(s.top=Math.round(s.top)+"px"),"auto"!=s.bottom&&(s.bottom=Math.round(s.bottom)+"px"),l.css(s);var c=l.position(),u=l.width(),p=l.height();c.left<0&&(l.css({left:0,right:"auto"}),d.snap=null),c.left>o.innerWidth-u&&(l.css({left:"auto",right:0}),d.snap=null),c.top<0&&(l.css({top:0,bottom:"auto"}),d.snap=null),c.top>o.innerHeight-p&&(l.css({top:"auto",bottom:0}),d.snap=null)},f=function(){if(e.visible){var o=e.getStepInfo();if(o)if(o.selector){var r=$(t).find(o.selector);if(!r.length)return void(d.anchorFound=!1);d.anchorFound=!0,h(r.offset().top,r.offset().left,r.width(),r.height())}else if(o.gameObjectSelector){var n=c.get("rooms.objects",{}),a=_.find(n,o.gameObjectSelector),i=$(".pixijs-renderer__stage");if(!a||!i.length)return void(d.anchorFound=!1);d.anchorFound=!0;var s=i.width()/50,u=i.offset();h(u.top+s*a.y,u.left+s*a.x,s,s)}else d.anchorFound=!0,d.snap=null,l.css({left:"calc(50% - "+l.width()/2+"px)",top:"50px"})}else clearInterval(m)},g=function(){var t=e.getStepInfo();t&&(e.visible=!0,m&&clearInterval(m),m=setInterval(f,100),f(),t.wrapController&&t.wrapController(d))};g(),r.$on("tutorialShow",g),r.$watch(function(){return e.step},this.contentLoaded=!1),r.$on("tutorialContentLinked",function(){f(),d.contentLoaded=!0}),r.$on("$destroy",function(){return e.resetStep()})}],controllerAs:"Tutorial"}}]),mod.directive("appTutorialCode",["Tutorial","MemoryStorage",function(e,t){return{templateUrl:"components/game/tutorial/code.html?bust=1561537540072",bindToController:{title:"@"},scope:{},controller:function(){if(this.code=e.getStepCodeHint(),this.visible=!0,-1!=this.code.indexOf("{{TOWER_ID}}")){var o=t.get("rooms.objects"),r=_.find(o,{type:"tower"});r&&(this.code=this.code.replace(/\{\{TOWER_ID\}\}/,r._id))}},controllerAs:"TutorialCode"}}]),mod.directive("appTutorialContent",function(){return{link:function(e,t,o){e.$emit("tutorialContentLinked")}}}),mod.controller("Top.Tutorial.TipOfTheDay",["$scope","Dialogs","LocalStorage",function(e,t,o){var r=this,n=["To save your CPU, use less creeps of a larger size.","A good way to save CPU is caching often-used paths.","The more body parts of one type a creep has, the greater its productivity.","Use storage to not lose surplus of mined resources.","A resource abandoned on the ground eventually vanishes.","Use towers to set up automatic defense of your room.","The more small objects in the Memory, the more CPU spent on its parsing.","Inscreasing the <code>reusePath</code> option in the <code>Creep.moveTo</code> method helps saving CPU.","The <code>RANGED_ATTACK</code> body part is 2 times weaker than <code>ATTACK</code> and 2 times costlier at that.","You can have as many rooms under your control as your Global Control Level.","You can address from your script only those rooms that contain your creeps or structures.","Observers allow to get the <code>Room</code> object for the rooms that have no objects of yours.","Build roads to save on <code>MOVE</code> body parts of your creeps.","Roads wear out as they are used, so don’t forget to repair them.","Walls and roads don’t belong to any player, so they should be searched with the help of <code>FIND_STRUCTURES</code>, not <code>FIND_MY_STRUCTURES</code>.","Use try/catch blocks in right places to avoid a complete halt of your script due to errors.","Use branches to test and debug your temporary code and also do backups.","Set up a grunt task to write scripts on your local machine and commit them to Screeps.","More spawns in a room allows building more creeps at a time.","The more spawn extensions in a room, the more energy you can spend on building one creep.","Spawn extensions capacity increases on room levels 7 and 8.","Spawn extensions do not have to be placed near spawns, their range is the whole room.","Towers can aim at any object in a room even through walls and obstacles.","A tower’s effectiveness depends on the distance to the target.","Power banks appear only in neutral rooms that divide living sectors on the map.","Ramparts can be built not just on empty squares but on existing structures too.","While not destroyed, a rampart protects a creep or building on its square from any type of attack.","Creeps cannot move faster than 1 square per tick.","Use links to save on creep building and CPU.","Links can pass energy to other links at any point inside the same room.","You can build and repair roads in any rooms, even neutral ones.","Leaderboards reset to zero each month, while your game process continues.","Modular architecture of a script will allow easy testing of individual functions in the simulator.","You can create any objects in the simulator to test your script.","The <code>console.log</code> function of the simulator displays a live expandable object in the browser console.","Walking over swamps is 5 times slower compared to plain land.","Ramparts and walls initially have 1 hit point. Repair them after construction.","You cannot have more than 3 rooms in the Novice Area.","If you want to play from scratch, you can always Respawn in a new room.","Every creep dies after 1500 ticks, however you can prolong its life using the <code>Spawn.renewCreep</code> method.","To control a room continuously, you need to upgrade your controller from time to time.","A spawn automatically replenishes itself with power until the energy in the room reaches 300 units.","Test various game scenarios in the simulator in order to be prepared for surprises.","Always try to control as many rooms as your GCL allows. It will allow your colony to develop at the maximum speed.","You can use more CPU than your CPU limit allows in short bursts.","Unless you use up your CPU limit each tick, it is stored for future use.","There is a keyword <code>debugger</code> in the simulator that stops your script in the browser.","Your CPU Limit depends on your Global Control Level.","Send emails to yourself with the function <code>Game.notify</code> to be aware of everything happening in the game.","The <code>Game.notify</code> function automatically groups identical messages using the specified interval.","It is too costly and senseless to maintain an army of military creeps in the peacetime.","The creep memory is saved upon death, so clear <code>Memory.creeps.*</code> to prevent overflowing.","You can output HTML content to the console, like links to rooms.","Each game action has a constant cost of 0.2 CPU.","Creeps can miss each other if they walk towards each other simultaneously or follow step by step.","A creep can execute some commands simultaneously in one tick, for example <code>move</code>+<code>build</code>+<code>dropEnergy</code>.","<code>require</code> spends CPU depending on the size and complexity of the module loaded.","Use loop architecture to save CPU on the logic you do not have to run each tick.","The game is fully recorded, so you can see replay of any room for the past several days.","If CPU limit raises, your script will execute only partially.","To output an object content into the console, use <code>JSON.stringify</code>.","A creep with an <code>ATTACK</code> part automatically strikes back at every attacker by <code>ATTACK</code>.","Respawning in a chosen room would automatically destroy all structures except walls and roads.","You can apply <code>transfer</code> and <code>heal</code> to another player’s creep, and <code>transfer,</code> <code>build</code> and <code>repair</code> to others’ structures.","To prevent other players from seizing a neutral room you want, use <code>Creep.reserveController</code>.","Energy in a storage can not be used to spawn creeps. Transfer it to a spawn or extensions instead.","You can speed up downgrading of hostile room controller by using <code>Creep.claimController</code> on it.","Sources in neutral rooms have reduced capacity. Reserve or claim the room to restore it to full capacity.","Use <code>Room.energyAvailable</code> and <code>Room.energyCapacityAvailable</code> to determine how much energy all the spawns and extensions in the room contain.","Dead body parts have weight and generate fatigue as well."];this.nextTip=function(){return r.tip=n[Math.floor(Math.random()*n.length)]},this.nextTip(),this.block=function(){t.ask("","Do you want to turn off tips of the day?").result.then(function(){e.Tutorial.close(),o.put("tipTipOfTheDay",-1,"")})}}]);_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var o=[],r=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(o.push(i.value),!t||o.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}return o}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();var roomGridSize,sectorGridSizeFactor,viewportWidth,viewportHeight,viewportRoomsX,viewportRoomsY,viewportTop,viewportLeft,viewportRight,viewportBottom,grid={},sectors=[],float={left:0,top:0,active:!1,hover:{}},roomGridSizeList={1:20,2:50,3:150},sectorGridSizeFactorList={1:10,2:4,3:1};function hsl2rgbArr(e,t,o){e<0&&(e+=360);var r,n,a,i=(1-Math.abs(2*o-1))*t,s=e/60,c=i*(1-Math.abs(s%2-1));void 0===e||isNaN(e)||null===e?r=n=a=0:s>=0&&s<1?(r=i,n=c,a=0):s>=1&&s<2?(r=c,n=i,a=0):s>=2&&s<3?(r=0,n=i,a=c):s>=3&&s<4?(r=0,n=c,a=i):s>=4&&s<5?(r=c,n=0,a=i):s>=5&&s<6&&(r=i,n=0,a=c);var u,l,p,m=o-i/2;return u=255*(r+m),l=255*(n+m),p=255*(a+m),[u=Math.round(u),l=Math.round(l),p=Math.round(p)]}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}(mod=angular.module("app.game.world-map",[])).config(["$routeSegmentProvider",function(e){e.when("/map","top.game-world-map-no-shard").within("top").segment("game-world-map-no-shard",{resolve:{data:ngInject(["$q","$location","$routeParams","$routeSegment","Api",function(e,t,o,r,n){return n.get("user/world-start-room").then(function(o){var n=o.room[0].match(/^(.*)\/(.*)$/);return t.replace(),t.url(r.getSegmentUrl("top.game-world-map",{shard:n?n[1]:"shard0"})),e.defer().promise})}])}}),e.when("/map/:shard","top.game-world-map").within("top").segment("game-world-map",{templateUrl:"components/game/world-map/world-map.html?bust=1561537540072",controller:"Top.WorldMap as WorldMap",resolve:{startRoom:ngInject(["Api","$routeParams",function(e,t){return e.get("user/world-start-room",{shard:t.shard}).then(function(e){return e.room})}]),worldStartRoom:ngInject(["Api",function(e){return e.get("user/world-start-room").then(function(e){return e.room})}]),worldStatus:ngInject(["Api",function(e){return e.get("user/world-status").then(function(e){return e.status})}])}})}]),mod.controller("Top.WorldMap",["$scope","$location","$routeSegment","LocalStorage","$q","MapUtils","Loader","Tutorial","WorldActivator","Auth","$interval","$timeout","WorldRespawnChecker","startRoom","worldStartRoom","Api","AccountSaveRedirector","worldStatus","ResourceTypeNames","$routeParams",function(e,t,o,r,n,a,i,s,c,u,l,p,m,d,h,f,g,v,y,b){var w=this;if(u.required(e)){if(!u.Me.badge)return g.set("top.game-world-map"),void t.url(o.getSegmentUrl("top.account-badge"));if(f.options.official&&!r.get("tutorialVisited",!1))return r.put("tutorialVisited",!0),void t.url(o.getSegmentUrl("top.sim-tutorial",{section:1}))}this.startRoom=d,this.worldStartRoom=h,this.worldStatus=v,this.resourceTypeNames=y,this.densityNames={1:"Low",2:"Moderate",3:"High",4:"Ultra"},this.zoom=3,this.shard=b.shard;var S=f.options.official?1:2;roomGridSize=roomGridSizeList[this.zoom],sectorGridSizeFactor=sectorGridSizeFactorList[this.zoom];var M=-1;grid={},sectors=[],this.grid=grid,this.sectors=sectors,this.displayOptions=r.createSyncedObj("game.world-map.displayOptions2",{layer:"owner0",units:!0}),this.searchRoom="",this.updateRoomStats=[],this.roomStats={},this.roomUsers={},this.roomStatsMax={},this.respawnProhibitedRooms={},this.now=function(){return Date.now()},this.goToRoom=function(){float.roomName&&w.roomStats[float.roomName]&&t.url(o.getSegmentUrl("top.game-room",{room:float.roomName,shard:w.shard}))},this.zoomChange=function(t){w.zoom+=t,w.zoom>3?w.zoom=3:w.zoom<S?w.zoom=S:(roomGridSize=roomGridSizeList[w.zoom],sectorGridSizeFactor=sectorGridSizeFactorList[w.zoom],sectors.forEach(function(e){e.pos&&(delete grid[e.pos[1]][e.pos[0]],e.pos=null)}),e.$broadcast("recalcMapSectors"),T())},this.switchNoviceArea=function(){++M>=h.length&&(M=0);var e,r,n=h[M],i=n.match(/^(.*)\/(.*)$/);i?(e=i[1],r=i[2]):(e="shard0",r=n),t.replace();var s=a.roomNameToXY(r),c=_slicedToArray(s,2),u=c[0],l=c[1];e==w.shard?t.search("pos",u+.5+","+(l+.5)):t.url(o.getSegmentUrl("top.game-world-map",{shard:e})+"?pos="+(u+.5)+","+(l+.5))},this.randomNoviceRoom=function(){return f.get("game/random-novice-room",{shard:w.shard}).then(function(e){e.room&&t.url(o.getSegmentUrl("top.game-room",{room:e.room,shard:e.shard}))})},this.lookForRoom=function(){return n.when().then(function(){return/^(W|E)\d+(N|S)\d+$/i.test(w.searchRoom)?w.searchRoom:f.get("user/find",{username:w.searchRoom}).then(function(e){return f.get("user/rooms",{id:e.user._id})}).then(function(e){return e.shards||(e.shards={shard0:e.rooms}),e.shards[w.shard]?_.sample(e.shards[w.shard]):n.reject()})}).then(function(e){var o=a.roomNameToXY(e),r=_slicedToArray(o,2),n=r[0],i=r[1];t.replace(),t.search("pos",n+.5+","+(i+.5))})},this.worldLaunched=function(){return new Date>=c.launchTime},this.getStatsCircleSize=function(e){var t;return(t="owner0"==w.displayOptions.layer?8:w.roomStatsMax[w.displayOptions.layer])?2*Math.sqrt(Math.min(e,t)/t*4071/Math.PI)+8:0},this.toggleUnits=function(){return w.displayOptions.units=!w.displayOptions.units},this.isRoomRespawnProhibited=function(e){if(!w.roomStats[e])return!0;if("out of borders"==w.roomStats[e].status)return!0;if(w.roomStats[e].openTime&&w.roomStats[e].openTime>Date.now())return!0;var t=a.roomNameToXY(e),o=_slicedToArray(t,2),r=o[0],n=o[1];return!!a.isCenter(r,n)||(!(!a.isBus(r)&&!a.isBus(n))||(!!w.respawnProhibitedRooms[e]||!(!w.roomStats[e]||!w.roomStats[e].own)))},this.onShardChange=function(){location.hash="#!/shards"};!function(){var e=new Date;e>=c.launchTime?w.remainingTime=null:w.remainingTime={days:Math.floor((c.launchTime-e)/24/3600/1e3),hours:Math.floor((c.launchTime-e)/3600/1e3)%24,minutes:Math.floor((c.launchTime-e)/60/1e3)%60,seconds:Math.floor((c.launchTime-e)/1e3)%60}}();var $=function(){return _.reduce(w.sectors,function(e,t){return t.name&&e.push(t.name),t.rooms&&(e=e.concat(t.rooms.split(","))),e},[])},T=function(t){return _.isArray(t)||(t=$()),i.loading(n.all([f.post("game/map-stats",{rooms:t,shard:w.shard,statName:3==w.zoom?w.displayOptions.layer:"owner0"}).then(function(e){w.gameTime=e.gameTime,_.extend(w.roomStats,e.stats),_.extend(w.roomUsers,e.users),w.roomStatsMax=e.statsMax}),"empty"==w.worldStatus?f.get("user/respawn-prohibited-rooms").then(function(e){w.respawnProhibitedRooms=_.reduce(e.rooms,function(e,t){return e[t]=!0,e},{})}):n.when()]).then(function(){return e.$broadcast("mapStatsUpdated")}))};!function(){if(!t.search().pos)if(M=0,d[0]){t.replace();var e=a.roomNameToXY(d[0]),o=_slicedToArray(e,2),r=o[0],n=o[1];t.search("pos",r+.5+","+(n+.5))}else t.search("pos","0,0")}();var k=function(){f.options.official?w.mapUrl={base:"https://d3os7yery2usni.cloudfront.net/map/"}:(S=2,w.mapUrl={base:"http://"+f.options.host+":"+f.options.port+"/assets/map/",query:"bust="+Date.now()}),f.options.serverData.shards.length>1&&(w.mapUrl.base+=w.shard+"/"),w.mapUrl.zoom1=w.mapUrl.base+"zoom1/",w.mapUrl.zoom2=w.mapUrl.base+"zoom2/"};k(),c.launchTime>new Date&&p(function(){return window.location.reload()},c.launchTime-new Date),e.$watch(_.throttle(function(){return e.$applyAsync(function(){_.remove(w.updateRoomStats,function(e){return e in w.roomStats}),w.updateRoomStats.length&&T(w.updateRoomStats),w.updateRoomStats=[]})},200)),e.$watchCollection(function(){return[w.displayOptions.layer,b.shard]},function(){w.roomStats={},w.updateRoomStats=$(),b.shard&&(w.shard=b.shard),k(),_.remove(w.updateRoomStats,function(e){return!e})}),l.bindToScope(e,T,6e4),e.$on("respawned",function(){w.worldStatus="empty",w.curNoviceArea=-1,function(){f.get("user/world-start-room",{shard:w.shard}).then(function(e){return d=e.room})}(),T().then(function(){return c.run()})}),u.Me&&u.Me.badge&&c.run(),m.bind(e),s.trigger("worldMapEntered")}]),mod.directive("appGameMapContainer",["$location","MapUtils","$document","$timeout",function(e,t,o,r){return{link:function(o,n,a){function i(){if(e.search().pos){var r=e.search().pos.split(/,/),a=_slicedToArray(r,2),i=a[0],s=a[1];i=parseFloat(i),s=parseFloat(s),viewportWidth=n.width(),viewportHeight=n.height(),viewportRoomsX=Math.ceil(viewportWidth/roomGridSize)+1,viewportRoomsY=Math.ceil(viewportHeight/roomGridSize)+1,viewportTop=s*roomGridSize-viewportHeight/2,viewportLeft=i*roomGridSize-viewportWidth/2,viewportRight=i*roomGridSize+viewportWidth/2,viewportBottom=s*roomGridSize+viewportHeight/2;var c=Math.ceil(viewportRoomsX/sectorGridSizeFactor+1)*Math.ceil(viewportRoomsY/sectorGridSizeFactor+1);if(sectors.length<c)for(var u=sectors.length;u<c;u++)sectors.push({id:Math.floor(1e7*Math.random())});if(sectors.length>c){for(u=c;u<sectors.length;u++)sectors[u].pos&&delete grid[sectors[u].pos[1]][sectors[u].pos[0]];sectors.splice(c,sectors.length-c)}for(var l in grid)for(var p in grid[l])(p<Math.floor(viewportLeft/roomGridSize)||p>Math.floor(viewportRight/roomGridSize)||l<Math.floor(viewportTop/roomGridSize)||l>Math.floor(viewportBottom/roomGridSize)||p%sectorGridSizeFactor||l%sectorGridSizeFactor)&&(sectors[grid[l][p]].pos=null,delete grid[l][p]);for(l=Math.floor(viewportTop/roomGridSize/sectorGridSizeFactor)*sectorGridSizeFactor;l<=Math.floor(viewportBottom/roomGridSize/sectorGridSizeFactor)*sectorGridSizeFactor;l+=sectorGridSizeFactor){grid[l]||(grid[l]={});for(p=Math.floor(viewportLeft/roomGridSize/sectorGridSizeFactor)*sectorGridSizeFactor;p<=Math.floor(viewportRight/roomGridSize/sectorGridSizeFactor)*sectorGridSizeFactor;p+=sectorGridSizeFactor)if(_.isUndefined(grid[l][p]))for(u=0;u<sectors.length;u++)if(!sectors[u].pos){if(sectors[u].pos=[p,l],grid[l][p]=u,3==o.WorldMap.zoom)sectors[u].name=t.getRoomNameFromXY(p,l),o.WorldMap.updateRoomStats.push(sectors[u].name);else{for(var m=[],d=0;d<sectorGridSizeFactor;d++)for(var h=0;h<sectorGridSizeFactor;h++){var f=t.getRoomNameFromXY(p+d,l+h);m.push(f),o.WorldMap.updateRoomStats.push(f)}sectors[u].rooms=m.join(","),sectors[u].firstRoomName=m[0]}break}}for(u=0;u<sectors.length;u++)sectors[u].pos&&(sectors[u].left=sectors[u].pos[0]*roomGridSize+viewportWidth/2-i*roomGridSize,sectors[u].top=sectors[u].pos[1]*roomGridSize+viewportHeight/2-s*roomGridSize);o.$broadcast("mapSectorsRecalced")}}function s(e){var o=n.offset(),r=Math.floor((e.pageX-o.left+viewportLeft)/roomGridSize),a=Math.floor((e.pageY-o.top+viewportTop)/roomGridSize);float.left=e.pageX-o.left+10,float.top=e.pageY-o.top+10,float.roomName=t.getRoomNameFromXY(r,a),float.hover.left=r*roomGridSize-viewportLeft,float.hover.top=a*roomGridSize-viewportTop,float.hover.size=roomGridSize,float.active=!0}var c=!1,u=!1;o.locked=!0,n.mousedown(function(e){return o.$applyAsync(function(){c=e.pageX,u=e.pageY}),!1});n.bind("mousemove",function(t){t.preventDefault(),o.$apply(function(){if(s(t),!1!==c&&!1!==u&&!(o.locked&&Math.abs(t.pageX-c)<5&&Math.abs(t.pageY-u)<5)){o.locked=!1;var r=e.search().pos.split(/,/),n=_slicedToArray(r,2),a=n[0],i=n[1];a=parseFloat(a),i=parseFloat(i),a-=(t.pageX-c)/roomGridSize,i-=(t.pageY-u)/roomGridSize,a=Math.round(1e3*a)/1e3,i=Math.round(1e3*i)/1e3,e.replace(),e.search("pos",a+","+i),c=t.pageX,u=t.pageY}})}),n.bind("mouseup",function(e){o.$applyAsync(function(){c=!1,u=!1,r(function(){return o.locked=!0},50)})}),n.bind("mouseover",function(e){s(e)}),n.bind("mouseout",function(e){o.$applyAsync(function(){float.active=!1,c=!1,u=!1})}),n.bind("wheel",function(t){Math.abs(t.originalEvent.deltaY)<3||o.$applyAsync(function(){var r=roomGridSize,a=n.width(),s=n.height(),c=t.originalEvent.pageX-n.offset().left,u=t.originalEvent.pageY-n.offset().top;t.originalEvent.deltaY<0?o.WorldMap.zoomChange(1):o.WorldMap.zoomChange(-1);var l=c*(1-roomGridSize/r)+(a*roomGridSize/r-a)/2,p=u*(1-roomGridSize/r)+(s*roomGridSize/r-s)/2;i();var m=viewportLeft-l,d=Math.round((m+viewportWidth/2)/roomGridSize*1e3)/1e3,h=viewportTop-p,f=Math.round((h+viewportHeight/2)/roomGridSize*1e3)/1e3;e.search("pos",d+","+f)})}),$(window).resize(i),i(),o.$on("recalcMapSectors",i),o.$watch(function(){return e.search().pos},i)}}}]),mod.factory("MapUtils",function(){return{getRoomNameFromXY:function(e,t){return""+(e=e<0?"W"+(-e-1):"E"+e)+(t=t<0?"N"+(-t-1):"S"+t)},roomNameToXY:function(e){var t=(e=e.toUpperCase()).match(/^(\w)(\d+)(\w)(\d+)$/),o=_slicedToArray(t,5),r=(o[0],o[1]),n=o[2],a=o[3],i=o[4];return[n="W"==r?-n-1:+n,i="N"==a?-i-1:+i]},isBus:function(e){return e<0&&(e+1)%10==0||e>0&&e%10==0||0==e},isCenter:function(e,t){return(e<0&&Math.abs(e+1)%10>=4&&Math.abs(e+1)%10<=6||e>=0&&Math.abs(e)%10>=4&&Math.abs(e)%10<=6)&&(t<0&&Math.abs(t+1)%10>=4&&Math.abs(t+1)%10<=6||t>=0&&Math.abs(t)%10>=4&&Math.abs(t)%10<=6)}}}),mod.controller("Top.WorldMap.MapFloatInfo",["$scope","$location","$routeSegment",function(e,t,o){this.float=float}]),mod.directive("appGameMapRoomObjects",["Socket","$timeout","$interval","Auth","Api",function(e,t,o,r,n){function a(e,t,o,r){if(t&&t.length)for(var n=0;n<r;n++)for(var a=0;a<r;a++)t.forEach(function(t){e.data[50*r*(r*t[1]+a)*4+4*(r*t[0]+n)+0]=o[0],e.data[50*r*(r*t[1]+a)*4+4*(r*t[0]+n)+1]=o[1],e.data[50*r*(r*t[1]+a)*4+4*(r*t[0]+n)+2]=o[2],e.data[50*r*(r*t[1]+a)*4+4*(r*t[0]+n)+3]=255})}var i={2:[255,150,0],3:[255,150,0],w:[0,0,0],r:[60,60,60],pb:[255,255,255],m:[170,170,170],p:[0,200,255],k:[100,0,0],c:[80,80,80],s:[255,242,70]};return{link:function(o,s,c){var u,l,p,m,d,h=s[0].getContext("2d"),f=parseInt(c.mapScale);r.Me&&(i[r.Me._id]=[0,255,0]);var g=function(t,r){return o.$applyAsync(function(){u=e.bindEventToScope(o,"roomMap2:"+(n.options.serverData.shards.length>1?t+"/":"")+r,function(e){if(m==r&&d==t){var o=h.createImageData(50*f,50*f);e&&(e.roads&&a(o,e.roads,i.roads,f),_.forEach(e,function(e,t){"roads"!=t&&(i[t]||(i[t]=function(){var e,t,o,r,n=0;do{n++,e=5*Math.round(30*Math.random()/5)-15,t=.1*Math.round(.2*Math.random()/.1)+.8,o=.1*Math.round(.2*Math.random()/.1)+.4,r=hsl2rgbArr(e,t,o)}while(n<100&&_.any(i,function(e){return _.isEqual(r,e)}));return r}()),a(o,e,i[t],f))})),h.putImageData(o,0,0),l&&clearInterval(l)}})})};c.$observe("appGameMapRoomObjects",function(e){var o=e.split("/"),r=_slicedToArray(o,2),n=r[0],a=r[1];u&&(u.remove(),h.putImageData(h.createImageData(50*f,50*f),0,0),u=null),l&&(clearInterval(l),l=null),p&&(t.cancel(p),p=null),n&&a&&(d=n,m=a,p=t(500).then(function(){g(n,a),p=null}))})}}}]),mod.directive("appGameMapSector",["BadgeGenerator","$timeout","$q",function(e,t,o){var r=0;return setInterval(function(){(r+=10)>255&&(r=0)},1e3),{link:function(t,r,n){var a,i=r[0].getContext("2d");i.canvas.width,i.canvas.height;function s(e,t,r,n,a,s){return o(function(o){var c=new Image;c.onload=function(){s()&&(i.globalAlpha=a,i.drawImage(c,t-n/2,r-n/2),c.src="",a&&(i.strokeStyle="#000",i.lineWidth=n/10,i.beginPath(),i.arc(t,r,n/2+i.lineWidth/2,0,2*Math.PI,!1),i.closePath(),i.stroke()),o())},c.src=e})}function c(){var o=t.WorldMap.roomUsers,r=t.WorldMap.roomStats;i.clearRect(0,0,200,200);var n=Date.now();if(a=n,t.sector.rooms)for(var c=t.sector.rooms.split(","),u=0;u<sectorGridSizeFactor;u++)for(var l=0;l<sectorGridSizeFactor;l++){var p=c[u*sectorGridSizeFactor+l];p&&r[p]?("empty"==t.WorldMap.worldStatus&&t.WorldMap.isRoomRespawnProhibited(p)?(i.fillStyle="rgb(255, 50, 50)",i.globalAlpha=.2,i.fillRect(u*roomGridSize,l*roomGridSize,roomGridSize,roomGridSize)):r[p].novice&&r[p].novice>Date.now()?(i.fillStyle="#57FF59",i.globalAlpha=.1,i.fillRect(u*roomGridSize,l*roomGridSize,roomGridSize,roomGridSize)):r[p].respawnArea&&r[p].respawnArea>Date.now()&&(i.fillStyle="rgb(0,110,255)",i.globalAlpha=.15,i.fillRect(u*roomGridSize,l*roomGridSize,roomGridSize,roomGridSize)),("normal"!=r[p].status&&!r[p].safeMode||r[p].openTime>Date.now())&&(i.fillStyle="#000",i.globalAlpha=.4,i.fillRect(u*roomGridSize,l*roomGridSize,roomGridSize,roomGridSize)),r[p].safeMode&&(i.strokeStyle="rgb(255, 232, 0)",i.globalAlpha=.22,i.lineWidth=1,i.strokeRect(u*roomGridSize+1,l*roomGridSize+1,roomGridSize-2,roomGridSize-2)),r[p].own&&o[r[p].own.user]&&function(t,i,c){var u=(20+20*r[c].own.level/8)*roomGridSize/100;e.getImageData(o[r[c].own.user].badge,u,u).then(function(e){s(e,t*roomGridSize+roomGridSize/2,i*roomGridSize+roomGridSize/2,u,r[c].own.level?1:.5,function(){return a==n})})}(u,l,p)):(i.fillStyle="#000",i.globalAlpha=.4,i.fillRect(u*roomGridSize,l*roomGridSize,roomGridSize,roomGridSize))}}t.$watch("sector.rooms",c),t.$on("mapStatsUpdated",c)}}}]),(mod=angular.module("app.login",[])).factory("Login",["$injector",function(e){return{visible:!1,show:function(){if(window.nw)return e.get("Auth").signInSteamByTicket();this.visible=!0},hide:function(){this.visible=!1},nwShow:function(){window.nw&&(this.visible=!0)}}}]),mod.directive("appLogin",function(){return{templateUrl:"components/login/login.html?bust=1561537540072",controller:"Login as Login"}}),mod.controller("Login",["$scope","Login","Api","Auth","$window","$location","$routeSegment","LocalStorage","$q","ZendeskSso",function(e,t,o,r,n,a,i,s,c,u){var l=this;this.svc=t,this.email="",this.password="",this.signIn=function(e){if(l.email&&l.password)return p(r.signIn(l.email,l.password,e))},this.signInGithub=function(){return p(r.signInGithub())},this.signInSteam=function(){return p(r.signInSteam())};var p=function(e){return e.then(function(){if(window.nw)t.hide(),a.url("/");else if(r.Me&&!r.Me.username)t.hide(),a.url("/register");else if(i.startsWith("top.register"))t.hide(),a.url("/");else{if("top.sso"!=i.name)return n.location.reload(),c.defer().promise;u.run()}}).catch(function(){return l.error=!0,c.reject()})}}]),mod.factory("ZendeskSso",["Api","$location","Dialogs",function(e,t,o){return{run:function(){e.get("sso/jwt").then(function(e){document.location.href="https://screeps.zendesk.com/access/jwt?jwt="+e.token+"&redirect_to="+t.search().redirect_to}).catch(function(e){"no subscription"==e&&o.alert("","Posting on the forums is only allowed for users with an active subscription due to a large amount of spam. We are very sorry."),"invalid email"==e&&o.alert("","You must set an email in your account settings to post on the forums.")})}}}]),(mod=angular.module("app.register",[])).config(["$routeSegmentProvider",function(e){e.when("/register","top.register").when("/sso","top.sso").when("/register/confirm","top.register-confirm").when("/register/recover","top.register-recover").when("/register/ask-recover","top.register-ask-recover").within("top").segment("register",{templateUrl:"components/login/register.html?bust=1561537540072",controller:"Top.Register as Register"}).segment("sso",{templateUrl:"components/login/register.html?bust=1561537540072",controller:"Top.Register as Register"}).segment("register-confirm",{templateUrl:"components/login/register-confirm.html?bust=1561537540072",controller:"Top.RegisterConfirm as RegisterConfirm",dependencies:["id"]}).segment("register-recover",{templateUrl:"components/login/register-recover.html?bust=1561537540072",controller:"Top.RegisterRecover as RegisterRecover",resolve:{data:ngInject(["RegisterRecoverLoader","$routeParams",function(e,t){return e.load(t.t)}])},resolveFailed:{templateUrl:"components/login/register-recover-error.html?bust=1561537540072"}}).segment("register-ask-recover",{templateUrl:"components/login/register-ask-recover.html?bust=1561537540072",controller:"Top.RegisterAskRecover as RegisterAskRecover"})}]),mod.controller("Top.Register",["$scope","Api","$location","Auth","LocalStorage","$routeSegment","ZendeskSso","Login","$q","NwLocalFileSync","$timeout","CodeBranches",function(e,t,o,r,n,a,i,s,c,u,l,p){var m=this;this.email="",this.password="",this.username="",this.emailValidators={correct:function(e){return/^[\w\d-\.\+&]+\@[\w\d\-\.&]+\.[\w\d\-\.&]{2,}$/.test(e)},unique:function(e){return t.get("register/check-email",{email:e})}},this.usernameValidators={correct:function(e){return/^[a-zA-Z0-9_-]+$/.test(e)},unique:function(e){return t.get("register/check-username",{username:e})}},this.passwordValidators={correct:function(e){return/^[a-z0-9!@\#$%^&\*\(\),\.\\\/\[\]{}\'\";=\+|_\-\?\~\`\:\<\>]*$/i.test(e)},number:function(e){return/[0-9]/.test(e)},non_number:function(e){return/[^0-9]/.test(e)}},this.passwordConfirmValidators={match:function(e){return e==m.password}},this.signInGithub=function(){return r.signInGithub()},this.signInSteam=function(){return r.signInSteam()},e.$watchGroup([function(){return r.Me&&r.Me._id},function(){return r.Me&&r.Me.username}],function(e,t){e[0]==t[0]&&e[1]&&(r.Me.email||r.Me.steam?"top.sso"==a.name?i.run():o.url("/"):o.url(a.getSegmentUrl("top.register-confirm")))}),this.submit=function(e){var a=n.get("users.code.activeSim",[]);a[0]=a[0]||{},a[0].modules=a[0].modules||{};var i=a[0].modules,s=_.filter(n.get("branches",[]),function(e){return 0==e.userId||r.Me&&e.userId==r.Me._id});return r.Me?t.post("register/set-username",{username:m.username,recaptcha:e,email:m.noEmail?void 0:m.email,tutorialDone:!!n.get("tutorialSectionsDone",{1:!1})[1]}).then(function(){mixpanel.track("Register set username",{username:m.username}),fbq("track","CompleteRegistration"),ga("send","event","Register","Set username"),r.check(),o.url("/rooms")}).then(function(){return p.submitCode(void 0,i)}).then(function(){return c.all(_.map(s,function(e){return p.cloneBranch(void 0,e.branch).then(function(){return p.submitCode(e.branch,e.modules)}).then(function(t){return u.writeBranch(e.branch,e.modules,t.timestamp)})}))}):t.post("register/submit",{email:m.email,password:m.password,username:m.username,recaptcha:e,tutorialDone:!!n.get("tutorialSectionsDone",{1:!1})[1],modules:i,branches:s}).then(function(){try{window.nw||(mixpanel.track("Register submit",{email:m.email,username:m.username}),ga("send","event","Register","Register submit"),xnt("putTraits",{email:m.email,user_id:m.username}),xnt("sendEvent","register",{email:m.email,user_id:m.username}))}catch(e){}o.url("/register/confirm")})},this.loginExisting=function(){s.nwShow()},"top.sso"!=a.name||r.Me||s.show()}]),mod.controller("Top.RegisterConfirm",["Loader","Login","$routeSegment","Api","Auth","$location",function(e,t,o,r,n,a){var i=this;n.Me&&(n.Me.email||n.Me.steam||n.Me.github)&&!n.Me.emailDirty?a.url("/"):(o.$routeParams.id&&e.loading(r.post("register/confirm",{id:o.$routeParams.id,s:o.$routeParams.s}).then(function(e){i.result="ok",mixpanel.track("Register email confirm",{email:e.email}),mixpanel.alias(e.email),ga("send","event","Register","Register Success","Register Email"),fbq("track","CompleteRegistration")}).catch(function(){i.result="error"})),this.signIn=function(){return t.show()})}]),mod.controller("Top.RegisterAskRecover",["Api",function(e){var t=this;this.email="",this.submit=function(){return t.result=void 0,e.post("register/recover",{email:t.email}).then(function(){return t.result=!0}).catch(function(e){return t.result=e})}}]),mod.factory("RegisterRecoverLoader",["Loader","Api","$q",function(e,t,o){return e.factory(function(e){return t.post("register/change-password",{token:e}).catch(function(e){return"invalid password"==e?{}:o.reject(e)})})}]),mod.controller("Top.RegisterRecover",["Login","$routeSegment","Api",function(e,t,o){var r=this;this.password="",this.passwordConfirm="",this.result=void 0,this.passwordValidators={correct:function(e){return/^[a-z0-9!@\#$%^&\*\(\),\.\\\/\[\]{}\'\";=\+|_\-\?\~\`\:\<\>]*$/i.test(e)},number:function(e){return/[0-9]/.test(e)},non_number:function(e){return/[^0-9]/.test(e)}},this.passwordConfirmValidators={match:function(e){return e==r.password}},this.submit=function(){r.result=void 0,o.post("register/change-password",{token:t.$routeParams.t,password:r.password}).then(function(){return r.result=!0}).catch(function(){return r.result=!1})}}]),(mod=angular.module("app.profile.account",[])).config(["$routeSegmentProvider",function(e){e.when("/account","top.account").when("/account/password","top.account-password").when("/account/github","top.account-github").when("/account/email","top.account-email").within("top").segment("account",{templateUrl:"components/profile/account/account.html?bust=1561537540072",controller:"Top.Account as Account",resolve:{data:ngInject(["AccountAuthTokensLoader","Api",function(e,t){if(t.options.official)return e.load()}])}}).segment("account-password",{templateUrl:"components/profile/account/account-password.html?bust=1561537540072",controller:"Top.AccountPassword as AccountPassword"}).segment("account-email",{templateUrl:"components/profile/account/account-email.html?bust=1561537540072",controller:"Top.AccountEmail as AccountEmail"}).segment("account-github",{templateUrl:"components/profile/account/account-github.html?bust=1561537540072",controller:"Top.AccountGitHub as AccountGitHub",resolve:{data:ngInject(["AccountGitHubLoader",function(e){return e.load()}])}})}]),mod.factory("AccountAuthTokensLoader",["Loader","Api",function(e,t){return e.factory(function(){return new Object({tokens:t.get("user/auth-token").then(function(e){return e.tokens})})})}]),mod.controller("Top.Account",["data","Auth","Dialogs","Api","$timeout","$location","$routeSegment","$q",function(e,t,o,r,n,a,i,s){t.required(),this.data=e,this.linkGitHub=function(){return t.signInGithub()},this.unlinkGitHub=function(){o.ask("","Do you really want to unlink your GitHub account?").result.then(function(){return r.post("user/unlink-github")}).then(function(){return t.check()})},this.linkSteam=function(){return t.signInSteam()},this.unlinkSteam=function(){o.ask("","Do you really want to unlink your Steam account?").result.then(function(){return r.post("user/unlink-steam")}).then(function(){return t.check()})},this.toggleNotificationsDisabled=function(e){if(!e&&!t.Me.email)return o.alert("","Please specify your e-mail address first."),s.when();var n=t.Me.notifyPrefs&&t.Me.notifyPrefs.disabled;return r.post("user/notify-prefs",{disabled:!n}).then(function(){return t.check()})},this.setNotificationsInterval=function(){o.askForSelect({label:"Send interval",value:t.Me.notifyPrefs&&t.Me.notifyPrefs.interval||5,options:[{5:"5 min"},{10:"10 min"},{30:"30 min"},{60:"1 hour"},{180:"3 hours"},{360:"6 hours"},{720:"12 hours"},{1440:"24 hours"},{4320:"3 days"}],note:"All notifications will be grouped and mailed out periodically using this interval.",callback:function(e){return r.post("user/notify-prefs",{interval:e}).then(function(){return t.check()})}})},this.setNotificationsErrorsInterval=function(){o.askForSelect({label:"Notify on errors",value:t.Me.notifyPrefs&&void 0!==t.Me.notifyPrefs.errorsInterval?t.Me.notifyPrefs.errorsInterval:30,options:[{0:"Immediately"},{10:"Every 10 min"},{30:"Every 30 min"},{60:"Every 1 hour"},{180:"Every 3 hours"},{360:"Every 6 hours"},{720:"Every 12 hours"},{1440:"Every 24 hours"},{4320:"Every 3 days"},{100000:"Never"}],note:"Send notifications when your script throws an error.",callback:function(e){return r.post("user/notify-prefs",{errorsInterval:e}).then(function(){return t.check()})}})},this.toggleNotificationsMessages=function(e){var o=t.Me.notifyPrefs&&t.Me.notifyPrefs.disabledOnMessages;return r.post("user/notify-prefs",{disabledOnMessages:!o}).then(function(){return t.check()})},this.toggleNotificationsOnline=function(e){var o=t.Me.notifyPrefs&&t.Me.notifyPrefs.sendOnline;return r.post("user/notify-prefs",{sendOnline:!o}).then(function(){return t.check()})},this.setGitHubRepo=function(){return r.get("auth/github/check-repo-scope").catch(function(e){return"no scope"==e?t.signInGithub(!0):s.reject(e)}).then(function(){a.url(i.getSegmentUrl("top.account-github"))})},this.isSubscriptionActive=function(){return t.Me.subscription||t.Me.promoPeriodUntil>Date.now()||t.Me.isSteamSubscriber()}}]),mod.controller("Top.AccountPassword",["Auth","Api","$location","$routeSegment",function(e,t,o,r){var n=this;e.required(),this.password="",this.oldPassword="",this.passwordValidators={correct:function(e){return/^[a-z0-9!@\#$%^&\*\(\),\.\\\/\[\]{}\'\";=\+|_\-\?\~\`\:\<\>]*$/i.test(e)},number:function(e){return/[0-9]/.test(e)},non_number:function(e){return/[^0-9]/.test(e)}},this.passwordConfirmValidators={match:function(e){return e==n.password}},this.submit=function(){return t.post("user/password",{oldPassword:n.oldPassword,password:n.password}).then(function(){return e.check()}).then(function(){return o.url(r.getSegmentUrl("top.account"))})}}]),mod.controller("Top.AccountEmail",["Auth","Api","$location","$routeSegment","Dialogs",function(e,t,o,r,n){var a=this;e.required(),this.email="",this.emailValidators={correct:function(e){return/^[\w\d-\.\+&]+\@[\w\d\-\.&]+\.[\w\d\-\.&]{2,}$/.test(e)},unique:function(e){return t.get("register/check-email",{email:e})}},this.submit=function(){return t.post("user/email",{email:a.email}).then(function(){return e.check()}).then(function(){return o.url(r.getSegmentUrl("top.account"))}).then(function(){return t.options.official&&n.alert("",{html:"We have sent a confirmation e-mail to you.<br>Please check your mail and click the link there."})})}}]),mod.factory("AccountGitHubLoader",["Loader","Api",function(e,t){return e.factory(function(){return new Object({repos:t.get("user/github-repos").then(function(e){return e.repos})})})}]),mod.controller("Top.AccountGitHub",["Auth","Api","$location","$routeSegment","data","Dialogs","$q",function(e,t,o,r,n,a,i){var s=this;e.required(),this.repo=e.Me.github&&e.Me.github.repo&&e.Me.github.repo.name||void 0,this.folder=e.Me.github&&e.Me.github.repo&&e.Me.github.repo.folder||"",n.repos=_.uniq(n.repos,function(e){return e.name}),this.reposList=_.map(n.repos,function(e){return new Object(_defineProperty({},e.name,e.name))}),this.submit=function(){return a.ask("Warning","All your scripts in Screeps account will be overwritten with this action! Are you sure?").result.then(function(){return t.post("user/github-repo",{repo:s.repo,folder:s.folder})}).then(function(){return e.check()}).then(function(){return o.url(r.getSegmentUrl("top.account"))}).catch(function(e){return"no default branch"==e&&(s.error='You have no "default" branch.'),i.reject(e)})},this.reset=function(){return t.post("user/github-repo",{repo:!1}).then(function(){return e.check()}).then(function(){return o.url(r.getSegmentUrl("top.account"))})}}]),mod.directive("appAccountEditPage",function(){return{scope:{pageTitle:"@"},templateUrl:"account-edit-page",restrict:"E",transclude:!0}}),mod.factory("AccountSaveRedirector",["$location","$routeSegment",function(e,t){var o;return{set:function(e){o=e},reset:function(){o=null},redirect:function(){e.url(t.getSegmentUrl(o||"top.account",{shard:t.$routeParams.shard||"shard0"})),this.reset()}}}]),(mod=angular.module("app.profile.account.auth-tokens",[])).config(["$routeSegmentProvider",function(e){e.when("/account/auth-tokens","top.account-auth-tokens").within("top").segment("account-auth-tokens",{templateUrl:"components/profile/account/auth-tokens/account-auth-tokens.html?bust=1561537540072",controller:"Top.AccountAuthTokens as AccountAuthTokens",resolve:{data:ngInject(["AccountAuthTokensLoader",function(e){return e.load()}])}})}]),mod.controller("Top.AccountAuthTokens",["$scope","Auth","data","Api","AccountAuthTokensLoader","Dialogs","$window",function(e,t,o,r,n,a,i){var s=this;e.Math=Math,t.required(),t.check(),this.data=o,this.addFormDefault={type:"full",endpoints:{"GET /api/user/name":!1,"GET /api/user/money-history":!1,"GET /api/market/my-orders":!1,"GET /api/user/memory":!1,"GET /api/user/memory-segment":!1,"POST /api/user/memory-segment":!1},websockets:{console:!1,rooms:!1},memorySegments:""},this.addForm=_.cloneDeep(this.addFormDefault),this.generateToken=function(){return r.post("user/auth-token",s.addForm).then(function(e){n.load(),s.addForm=_.cloneDeep(s.addFormDefault),a.alert("",{html:'<p>Be sure to record your generated token, it will not be shown again!</p>\n                                          <p><input readonly style="font-size: 20px; margin-left: 0; width: 100%" value="'+e.token+'"></p>'})})},this.removeToken=function(e){return r.post("user/delete-auth-token",{tokenId:e}).then(function(e){return n.load()})},this.now=function(){return Date.now()},this.disableRateLimiting=function(e){var t="#!/account/auth-tokens/noratelimit?token="+e.substring(0,8);if(window.nw)nw.Shell.openExternal("https://screeps.com/a/"+t);else{var o={toolbar:"no",directories:"no",left:screenLeft+($(window).width()-500)/2,top:screenTop+($(window).height()-700),status:"no",menubar:"no",scrollbars:"yes",resizable:"yes",width:500,height:700},r=[];for(var a in o)r.push(a+"="+o[a]);var s=r.join(","),c=i.open(t,"noratelimit",s);c.addEventListener("message",function(e){"screepsTokenSuccess"==e.data&&n.load()},!1),c.focus()}}}]),(mod=angular.module("app.profile.account.auth-tokens.noratelimit",[])).config(["$routeSegmentProvider",function(e){e.when("/account/auth-tokens/noratelimit","account-auth-tokens-noratelimit").segment("account-auth-tokens-noratelimit",{templateUrl:"components/profile/account/auth-tokens/noratelimit/account-auth-tokens-noratelimit.html?bust=1561537540072",controller:"AccountAuthTokensNoratelimit as AccountAuthTokensNoratelimit"})}]),mod.controller("AccountAuthTokensNoratelimit",["$scope","Api","$routeParams","$timeout","$window",function(e,t,o,r,n){var a=this;this.token=o.token.substring(0,8),this.submit=function(e){return t.post("user/noratelimit",{token:a.token,recaptcha:e}).then(function(){a.success=!0,n.parent&&n.parent.postMessage("screepsTokenSuccess","*"),n.postMessage("screepsTokenSuccess","*"),n.close()}).catch(function(e){a.error=e})}}]),(mod=angular.module("app.profile.account.badge",[])).config(["$routeSegmentProvider",function(e){e.when("/account/badge","top.account-badge").within("top").segment("account-badge",{templateUrl:"components/profile/account/badge/account-badge.html?bust=1561537540072",controller:"Top.AccountBadge as AccountBadge"})}]),mod.controller("Top.AccountBadge",["Auth","Dialogs","Api","$interval","BadgeGenerator","BadgePaths","$scope","$location","$routeSegment","AccountSaveRedirector",function(e,t,o,r,n,a,i,s,c,u){var l=this;e.required(),this.pathInfo=function(){return a[l.data.type]},this.types=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],this.selectSymbol=function(e){l.data.type=e,l.data.flip=!1,l.data.param=0},this.resetSymbol=function(){return l.data.type=null},this.data=_.clone(e.Me.badge||{type:null,color1:"#000077",color2:"#5555dd",color3:"#9999ff",param:0,flip:!1}),_.isString(this.data.color1)||(this.data.color1=n.colors[this.data.color1].rgb),_.isString(this.data.color2)||(this.data.color2=n.colors[this.data.color2].rgb),_.isString(this.data.color3)||(this.data.color3=n.colors[this.data.color3].rgb),this.creep={_id:"creep",x:0,y:0,energyCapacity:100,energy:0,user:0,body:[]},this.data._watching=!0,this.save=function(){return o.post("user/badge",{badge:l.data}).then(function(){delete l.data._watching,e.Me.badge=l.data,u.redirect()})},this.randomize=function(){l.data.type=Math.floor(24*Math.random())+1,Math.random()>.5?(l.data.color1=n.colors[Math.floor(20*Math.random())].rgb,l.data.color2=n.colors[Math.floor(60*Math.random())+20].rgb,l.data.color3=n.colors[Math.floor(60*Math.random())+20].rgb):(l.data.color1=n.colors[Math.floor(20*Math.random())+60].rgb,l.data.color2=n.colors[Math.floor(60*Math.random())].rgb,l.data.color3=n.colors[Math.floor(60*Math.random())].rgb),l.data.flip=Math.random()>.5,l.data.param=Math.floor(200*Math.random())-100},this.energy=0;var p=1;r.bindToScope(i,function(){l.energy+=p,l.energy>70&&(l.energy=70,p=-1),l.energy<0&&(l.energy=0,p=1)},30);var m=function(){l.creep.energy=Math.random()>.6?80*Math.random()+20:0;var e=Math.floor(20*Math.random())+1,t=["work","attack","ranged_attack","claim"][Math.floor(4*Math.random())],o=Math.random()>.3?Math.floor(20*Math.random())+1:0,r=Math.random()>.7?Math.floor(20*Math.random())+2:0;l.creep.body=[];for(var n=0;n<e;n++)l.creep.body.push({type:"move",hits:100});for(n=0;n<o;n++)l.creep.body.push({type:t,hits:100});for(n=0;n<r;n++)l.creep.body.push({type:"tough",hits:100});i.$broadcast("roomObjectsUpdated")};m(),r.bindToScope(i,m,500)}]),(mod=angular.module("app.profile.account.runtime",[])).config(["$routeSegmentProvider",function(e){e.when("/account/runtime","top.account-runtime").within("top").segment("account-runtime",{templateUrl:"components/profile/account/runtime/account-runtime.html?bust=1561537540072",controller:"Top.AccountRuntime as AccountRuntime"})}]),mod.controller("Top.AccountRuntime",["$scope","Auth","Api","Dialogs",function(e,t,o,r){e.Math=Math,t.required(),t.check(),this.changeIvm=function(){r.askForSelect({label:"Virtual machine",value:t.Me.runtime.legacyVm?"shared":"isolated",options:[{isolated:"Isolated (default)"},{shared:"Shared (legacy)"}],note:{html:'Use this option to change your JavaScript virtual machine. <a app-nw-external-link target="_blank" href="http://blog.screeps.com/2018/03/changelog-2018-03-05/">Learn more</a>'},callback:function(e){return o.post("user/ivm",{legacy:"shared"===e}).then(function(){return t.check()})}})}}]),(mod=angular.module("app.profile.account.subscription",[])).config(["$routeSegmentProvider",function(e){e.when("/account/subscription","top.account-subscription").within("top").segment("account-subscription",{templateUrl:"components/profile/account/subscription/account-subscription.html?bust=1561537540072",controller:"Top.AccountSubscription as AccountSubscription",resolve:{data:ngInject(["AccountSubscriptionLoader",function(e){return e.load()}])}})}]),mod.factory("AccountSubscriptionLoader",["Loader","Api",function(e,t){return e.factory(function(){return new Object({sub:t.get("xsolla/user").then(function(e){return e})})})}]),mod.controller("Top.AccountSubscription",["$scope","Auth","data","Api","AccountSubscriptionLoader","Dialogs",function(e,t,o,r,n,a){e.Math=Math,t.required(),t.check(),this.data=o,this.getDays=function(){return Math.round((o.sub.active-Date.now())/24/3600/1e3)},this.cancelSubscription=function(){return a.ask("","Do you want to cancel your subscription?").result.then(function(){return r.post("xsolla/cancel-subscription")}).then(function(){return n.load()})},this.convertCredits=function(){return r.post("user/convert-credits-subscription").then(function(){return n.load()}).then(function(){return t.check()})}}]),(mod=angular.module("app.profile.cpu",[])).config(["$routeSegmentProvider",function(e){e.when("/cpu","top.cpu").within("top").segment("cpu",{templateUrl:"components/profile/cpu/cpu.html?bust=1561537540072",controller:"Top.ProfileCpu as ProfileCpu"})}]),mod.controller("Top.ProfileCpu",["$scope","Api","$timeout","$q","Login","Auth","Socket","Dialogs","WorldActivator","$rootScope","$location","$routeSegment",function(e,t,o,r,n,a,i,s,c,u,l,p){var m=this;if(a.required(),a.check(),0==a.Me.credits)return l.replace(),void l.url(p.getSegmentUrl("top.account-subscription"));this.changeLimit=function(){m.isChangingLimit=!0},this.resetChangeLimit=function(){m.isChangingLimit=!1,m.changeLimitValue=a.Me.cpu,m.changeLimitValue<20&&(m.changeLimitValue=19)},this.resetChangeLimit(),this.isValidChange=function(){return!!u.ptr||!(m.getChargeAmount()>a.Me.credits)&&m.changeLimitValue!=a.Me.cpu},this.getChargeAmount=function(){var e=m.changeLimitValue;e<20&&(e=0);var t=a.Me.lastChargeTime||i.now(),o=i.now()-t;o>864e5&&(o=864e5);var r=(864e5-o)/864e5*(e-a.Me.cpu)+o/864e5*e;return r<0&&r++,Math.round(r)},this.save=function(){return Date.now()<c.launchTime?(s.alert("","The game is not launched yet. Please try again on August 12"),r.when()):t.post("user/cpu-limit",{cpu:m.changeLimitValue}).then(function(){return a.check()}).then(function(){return m.resetChangeLimit()})},this.getNextChargeDate=function(){return new Date(a.Me.lastChargeTime+864e5)}}]),(mod=angular.module("app.profile.early-preview-request",[])).config(["$routeSegmentProvider",function(e){e.when("/early-preview-request","top.early-preview-request").within("top").segment("early-preview-request",{templateUrl:"components/profile/early-preview-request/early-preview-request.html?bust=1561537540072",controller:"Top.EarlyPreviewRequest as EarlyPreviewRequest"})}]),mod.controller("Top.EarlyPreviewRequest",["Api",function(e){var t=this;this.data={email:"",name:"",birthDate:{day:"",month:"",year:""},qualify:void 0},this.submit=function(){return e.post("user/request-early-preview",t.data).then(function(){t.ok=!0})}}]),(mod=angular.module("app.profile.messages.index",[])).config(["$routeSegmentProvider",function(e){e.when("/messages","top.messages-index").within("top").segment("messages-index",{templateUrl:"components/profile/messages/index/index.html?bust=1561537540072",controller:"Top.MessagesIndex as MessagesIndex",resolve:{data:ngInject(["MessagesIndexLoader",function(e){return e.load()}])}})}]),mod.factory("MessagesIndexLoader",["Loader","$routeParams","Api","$q",function(e,t,o,r){return e.factory(function(){return{index:o.get("user/messages/index")}})}]),mod.controller("Top.MessagesIndex",["$scope","data","Auth","Api","Socket","$location","$routeSegment","MessagesIndexLoader","TopLoader",function(e,t,o,r,n,a,i,s,c){o.required(),c.load(),this.data=t,this.goToRespondent=function(e){return a.url(i.getSegmentUrl("top.messages-respondent",{username:t.index.users[e._id].username}))},n.bindEventToScope(e,"user:"+o.Me._id+"/newMessage",function(){s.load()})}]),mod.controller("Top.MessagesIndex.Message",["$scope","Auth","Api","Socket",function(e,t,o,r){var n;e.$watch(function(){return"out"==e.item.message.type&&e.item.message.unread},function(o){o?n=r.bindEventToScope(e,"user:"+t.Me._id+"/message:"+e.item._id,function(t){t.message._id==e.item.message._id&&(e.item.message.unread=t.message.unread)}):n&&(n.remove(),n=null)})}]),(mod=angular.module("app.profile.messages.respondent",[])).config(["$routeSegmentProvider",function(e){e.when("/messages/:username","top.messages-respondent").within("top").segment("messages-respondent",{templateUrl:"components/profile/messages/respondent/respondent.html?bust=1561537540072",controller:"Top.MessagesRespondent as MessagesRespondent",dependencies:["username"],resolve:{data:ngInject(["MessagesRespondentLoader",function(e){return e.load()}])}})}]),mod.factory("MessagesRespondentLoader",["Loader","$routeParams","Api","$q",function(e,t,o,r){return e.factory(function(){var e=o.get("user/find",{username:t.username}).then(function(e){return e.user});return{user:e,messages:e.then(function(e){return o.get("user/messages/list",{respondent:e._id})}).then(function(e){return e.messages})}})}]),mod.controller("Top.MessagesRespondent",["$scope","data","Auth","Api","Socket",function(e,t,o,r,n){var a=this;o.required(),this.user=t.user,this.messages=t.messages,this.messageText="",this.sendMessage=function(){if(a.messageText)return r.post("user/messages/send",{respondent:a.user._id,text:a.messageText}).then(function(){return a.messageText=""})},n.bindEventToScope(e,"user:"+o.Me._id+"/message:"+this.user._id,function(e){var t=_.find(a.messages,{_id:e.message._id});t?_.extend(t,e.message):(a.messages.push(e.message),setTimeout(function(){return Prism.highlightAll()},0))}),setTimeout(function(){return Prism.highlightAll()},0)}]),mod.controller("Top.MessagesRespondent.Message",["$scope","Socket","Api","$timeout","LocalStorage",function(e,t,o,r,n){if(!n.get("noReadingMessages")&&e.message.unread&&"in"==e.message.type){var a=r(500).then(function(){e.Top.data.unreadMessages--,o.post("user/messages/mark-read",{id:e.message._id})});e.$on("$destroy",r.cancel(a))}}]),(mod=angular.module("app.profile",[])).config(["$routeSegmentProvider",function(e){e.when("/profile/:username","top.profile").within("top").segment("profile",{templateUrl:"components/profile/profile.html?bust=1561537540072",controller:"Top.Profile as Profile",dependencies:["username"],resolve:{data:ngInject(["ProfileLoader",function(e){return e.load()}])},resolveFailed:{templateUrl:"components/profile/profile-not-found.html?bust=1561537540072"}})}]),mod.factory("ProfileLoader",["Loader","$routeParams","Api","$q",function(e,t,o,r){return e.factory(function(e){var n=o.get("user/find",{username:t.username}).then(function(e){return e.user});return{user:n,seasons:o.get("leaderboard/seasons").then(function(e){return e.seasons}),leaderboard:r.all({world:o.get("leaderboard/find",{username:t.username,mode:"world"}).then(function(e){return e.list}),power:o.get("leaderboard/find",{username:t.username,mode:"power"}).then(function(e){return e.list})}),stats:n.then(function(t){return o.get("user/stats",{id:t._id,interval:0|e||1440})}).then(function(e){return e.stats}),rooms:n.then(function(e){return o.get("user/rooms",{id:e._id})}).then(function(e){return e.shards||(e.shards={shard0:e.rooms}),e.shards})}})}]),mod.controller("Top.Profile",["data","Constants","ProfileLoader","Api",function(e,t,o,r){var n=this;this.user=e.user,this.leaderboard={},_.forEach(e.leaderboard,function(t,o){return n.leaderboard[o]=_.indexBy(e.leaderboard[o],"season")}),this.seasons=_.indexBy(e.seasons,"_id"),this.currentSeason=e.seasons[0]._id,this.prevSeason=e.seasons[1]._id,this.data=e,this.statInterval=1440,this.mapUrl=r.options.official?"https://d3os7yery2usni.cloudfront.net/map/":"http://"+r.options.host+":"+r.options.port+"/assets/map/",this.allSeasons=_.filter(e.seasons,function(e){return e._id!=n.currentSeason}),this.getGcl=function(){return Math.floor(Math.pow((n.user.gcl||0)/t.GCL_MULTIPLY,1/t.GCL_POW))+1},this.getPowerLevel=function(){return Math.floor(Math.pow((n.user.power||0)/t.POWER_LEVEL_MULTIPLY,1/t.POWER_LEVEL_POW))},_.forEach(this.leaderboard,function(e){_.forEach(e,function(e){e&&(e.rankPage=Math.floor(e.rank/10)+1)})}),this.statIntervalChange=function(){return o.load(n.statInterval)},this.getRoomsCount=function(){return _(e.rooms).mapValues(function(e){return e.length}).sum()}}]),(mod=angular.module("app.timeline-stats",[])).config(["$routeSegmentProvider",function(e){e.when("/timeline-stats","top.timeline-stats").within("top").segment("timeline-stats",{templateUrl:"components/timeline-stats/timeline-stats.html?bust=1561537540072",controller:"Top.TimelineStats as TimelineStats",resolve:{data:ngInject(["Api","$routeParams",function(e,t){return e.get("adm/timeline-stats",{shard:t.shard}).then(function(e){return e.stats})}])}})}]),mod.controller("Top.TimelineStats",["$scope","Api","data","$timeout",function(e,t,o,r){this.data=o,r(function(){google.load("visualization","1",{packages:["timeline"],callback:function(){var e=document.getElementById("timeline"),t=new google.visualization.Timeline(e),r=new google.visualization.DataTable;r.addColumn({type:"string",id:"type"}),r.addColumn({type:"string",id:"name"}),r.addColumn({type:"date",id:"Start"}),r.addColumn({type:"date",id:"End"}),o.forEach(function(e){var t=JSON.parse(e);r.addRow([t.type,t.name,new Date(t.start),new Date(t.end)])}),t.draw(r,{backgroundColor:"#ffd"})}})},1e3)}]),(mod=angular.module("app.top",[])).config(["$routeSegmentProvider",function(e){e.when("/sim","top").segment("top",{templateUrl:"components/top/top.html?bust=1561537540072",controller:"Top as Top",resolve:{data:ngInject(["TopLoader",function(e){return e.load()}])}})}]),mod.factory("TopLoader",["Loader","$q","Api","Auth",function(e,t,o,r){return e.factory(function(){return{unreadMessages:r.Me?o.get("user/messages/unread-count").then(function(e){return e.count}):t.when(0)}})}]),mod.controller("Top",["$scope","data","TopLoader","Login","Auth","$window","Socket","$timeout","WorldRespawnChecker","$routeSegment","$mdSidenav","NwLocalFileSync","CodeBranches","Loader","$q","MemoryStorage","Dialogs","$document","$routeParams",function(e,t,o,r,n,a,i,s,c,u,l,p,m,d,h,f,g,v,y){var b,w=this;(this.LoginSvc=r,this.cpuUsed=0,this.memoryUsed=0,this.hideUi=!1,this.data=t,i.bindConnect(e),this.toggleMainNav=function(){l("main").toggle()},this.signOut=function(){n.signOut(),a.location.reload()},this.respawn=function(){return c.respawn()},this.getPromoDaysLeft=function(){return Math.floor(((n.Me.promoPeriodUntil||0)-Date.now())/3600/24/1e3)},n.Me)&&(i.bindEventToScope(e,"user:"+n.Me._id+"/cpu",function(e){b&&s.cancel(b),w.cpuUsed=e.cpu,w.memoryUsed=e.memory,b=s(function(){w.cpuUsed=0},1e4)}),i.bindEventToScope(e,"user:"+n.Me._id+"/newMessage",function(t){w.data.unreadMessages++,"top.messages-respondent"!=u.name&&e.$broadcast("newUnreadMail")}));if(f.get("users.code.activeSim")||f.put("users.code.activeSim",[{_id:"0",modules:{main:"module.exports.loop = function () {\n\t// Your code goes here\n}"}},{_id:"1",modules:{main:"module.exports.loop = function () {\n\t// Your code goes here\n}"}}]),f.get("users.code.activeWorld")||f.put("users.code.activeWorld",[{_id:"0",modules:{main:"module.exports.loop = function () {\n\t// Your code goes here\n}"}},{_id:"1",modules:{main:"module.exports.loop = function () {\n\t// Your code goes here\n}"}}]),v.bindToScope(e,"keydown",function(e){122==e.keyCode&&e.ctrlKey&&(w.hideUi=!w.hideUi)}),e.$watch(function(){return y.anonymous},function(e){return w.isAnonymous=!!+e}),window.nw){var S=function(){return m.init("activeSim").then(function(){return m.loadBranches(!0)})},M=function(e){return m.loadBranches().then(function(e){return _.reduce(e,function(e,t){return e.then(function(){return m.deleteBranch(t)})},h.when())}).then(function(){return _.reduce(e,function(e,t,o){return e.then(function(e){return m.submitCode(o,t,!0).catch(function(e){return"branch does not exist"==e?m.cloneBranch(void 0,o,t):h.reject(e)}).then(function(t){return Math.max(t,e)})})},h.when(0))})};p.init().then(function(){return p.sync(S,M).catch(function(){return!0})}).then(function(){p.startSync(e,{branchCreated:function(e,t){d.loading(m.cloneBranch(void 0,e,t))},branchRemoved:function(e){d.loading(m.deleteBranch(e))},branchChanged:function(e,t){d.loading(m.submitCode(e,t,!0))}})})}}]),mod.directive("appUnreadMailIcon",["$animate","$timeout",function(e,t){return function(o,r){o.$on("newUnreadMail",function(){t(function(){e.addClass(r,"new-mail").then(function(){r.removeClass("new-mail")})},10)})}}]),mod.directive("appLogoBlinking",["Connection",function(e){return{link:function(t,o,r){t.$on("routeSegmentChange",function(){o.removeClass("logo-blinking--blink")}),e.onRoomUpdate(t,function(){o.hasClass("logo-blinking--blink")?o.removeClass("logo-blinking--blink"):o.addClass("logo-blinking--blink")})}}}]),mod.directive("appClickCloseSidenav",["$mdSidenav",function(e){return{link:function(t,o,r){o.click(function(){return t.$apply(function(){e(r.appClickCloseSidenav).close()})})}}}]),(mod=angular.module("app.config",[])).config(["ApiProvider","SocketProvider",function(e,t){e.options.apiUrl="https://screeps.com/api/",e.options.historyUrl="https://screeps.com/room-history/",t.options.websocketUrl="//screeps.com/socket","1"!=localStorage.getItem("debug")&&(t.options.gzip=!0)}]),mod.run(["$rootScope","LocalStorage","Recaptcha",function(e,t,o){o.disabled=!0}]),(mod=angular.module("app.routing-app2",[])).config(["$routeSegmentProvider",function(e){e.when("/report-problem","top.report-problem").within("top").segment("report-problem",{template:"<app2-report-problem></app2-report-problem>"}),e.when("/order","top.order").within("top").segment("order",{template:"<app2-order></app2-order>"}),e.when("/shards","top.shards").within("top").segment("shards",{}),e.when("/overview/power","top.power").within("top").segment("power",{}),e.when("/power-promo","top.power-promo").within("top").segment("power-promo",{}),e.when("/nw-menu","nw-menu").segment("nw-menu",{template:"<div></div>"}),e.when("/sim","top.sim").within("top").segment("sim",{}),e.when("/sim/tutorial","top.sim.tutorial-index").within("top").within("sim").segment("tutorial-index",{template:""}),e.when("/market","top.market").within("top").segment("market",{}),e.when("/market/all","top.market.all").within("top").within("market").segment("all",{}),e.when("/market/all/:resourceType","top.market.all.all-orders-resource").within("top").within("market").within("all").segment("all-orders-resource",{}),e.when("/market/all/:shard/:resourceType","top.market.all.all-orders-resource").within("top").within("market").within("all").segment("all-orders-resource",{}),e.when("/market/my","top.market.my").within("top").within("market").segment("my",{}),e.when("/market/history","top.market.history").within("top").within("market").segment("history",{})}]),(mod=angular.module("app.api",[])).provider("Api",["$httpProvider",function(e){var t=this.options={apiUrl:"",official:!0,serverData:{historyChunkSize:100,shards:["shard0"]}};this.$get=ngInject(["$injector","$q",function(e,o){var r=function(e){return o.reject(e)};return{options:t,post:function(n,a){return e.get("$http").post(t.apiUrl+n,a,{withCredentials:!0}).then(function(e){return 200!=e.status?o.reject(e.statusText):e.data.ok?e.data:o.reject(e.data.error)},r)},get:function(n,a){return e.get("$http")({method:"GET",url:t.apiUrl+n,params:a,withCredentials:!0}).then(function(e){return e.data.ok?e.data:o.reject(e.data.error)},r)}}}])}]),(mod=angular.module("app.auth",[])).provider("Auth",["$httpProvider",function(e){var t={};e.interceptors.push(ngInject(["LocalStorage","Login","$rootScope","$injector","$q","Api",function(e,o,r,n,a,i){return{request:function(t){var o=e.get("auth",null);return o&&(t.headers["X-Token"]=o,t.headers["X-Username"]=o),e.get("ignoreServerDown",0)&&(t.headers["X-Ignore-Server-Down"]=1),!i.options.official&&i.options.password&&(t.headers["X-Server-Password"]=i.options.password),t},response:function(t){var o=t.headers("X-Token");return o&&e.put("auth",o),t},responseError:function(r){var i=r.headers("X-Token");if(i&&e.put("auth",i),401==r.status&&!/signin/.test(r.config.url)){t.Me=null,e.put("auth",null);var s=o.show();if(s)return s.then(function(){return n.get("$http")(r.config)})}return a.reject(r)}}}])),this.$get=ngInject(["$rootScope","LocalStorage","$q","Api","Login","$window","$location","Socket","Loader","Constants","Dialogs","$timeout",function(e,o,r,n,a,i,s,c,u,l,p,m){var d,h;return t.useNativeAuth=!1,t.check=function(){return o.get("auth",null)?n.get("auth/me").then(function(r){t.Me=r,t.Me.getGcl=function(){return Math.floor(Math.pow((t.Me.gcl||0)/l.GCL_MULTIPLY,1/l.GCL_POW))+1},t.Me.getPowerLevel=function(){return Math.floor(Math.pow((t.Me.power||0)/l.POWER_LEVEL_MULTIPLY,1/l.POWER_LEVEL_POW))},t.Me.getCpu=function(){return Math.min(10*(t.Me.getGcl()-1)+30,300)},t.Me.isSteamOwner=function(){return t.Me.steam&&t.Me.steam.ownership&&-1!==t.Me.steam.ownership.indexOf(464350)},t.Me.isSteamSubscriber=function(){return t.Me.steam&&t.Me.steam.ownership&&-1!==t.Me.steam.ownership.indexOf(491760)},t.Me.isLifetimeSubscriber=function(){return t.Me.lifetimeSubscription||t.Me.steam&&t.Me.steam.ownership&&-1!==t.Me.steam.ownership.indexOf(883940)};var n=o.get("firstVisit",!1,"");!1!==n&&n<1422783777e3&&!1===o.get("mixpanelAlias",!1)&&(mixpanel.alias(r.email),o.put("mixpanelAlias",1));try{mixpanel.identify(r.email),mixpanel.people.set({$email:r.email,userId:r._id}),mixpanel.register({email:r.email,userId:r._id}),window.nw||xnt("putTraits",{user_id:r.username,email:r.email})}catch(e){}d&&d.remove(),d=c.bindEventToScope(e,"user:"+r._id+"/money",function(e){t.Me.money=e})}).catch(function(){t.Me=null,o.put("auth",null),d&&d.remove()}):r.reject()},t.signIn=function(e,a,i){function s(r){return n.post("auth/signin",{email:e,password:a,recaptcha:i,steamTicket:r}).then(function(e){return o.put("auth",e.token),t.check()}).then(function(e){return mixpanel.track("Sign in",{email:t.Me.email}),e})}if(window.nw){var c=require("./greenworks");return r(function(e){return c.getAuthSessionTicket(e)}).then(function(e){return s(e.ticket.toString("hex")).then(function(t){return c.cancelAuthTicket(e.handle),t}).catch(function(t){return c.cancelAuthTicket(e.handle),r.reject(t)})})}return s()},t.signInGithub=function(e){return r(function(r,a){var s=n.options.apiUrl+"auth/github?";t.Me&&(s+="token="+o.get("auth")+"&");e&&(s+="repoScope=1");i.open(s);i.addEventListener("message",function e(o){i.removeEventListener("message",e);var n=JSON.parse(o.data);return n.username||(mixpanel.alias(n.email),mixpanel.track("Register GitHub"),ga("send","event","Register","Register Success","Register GitHub")),mixpanel.track("Sign in GitHub",{email:n.email}),t.set(n.token).then(r,a)})})},t.signInSteam=function(){return r(function(e,r){var a=n.options.apiUrl+"auth/steam?";t.Me&&(a+="token="+o.get("auth")+"&");i.open(a);i.addEventListener("message",function o(n){i.removeEventListener("message",o);var a=JSON.parse(n.data);return a.username||(mixpanel.alias(a.email),mixpanel.track("Register Steam"),ga("send","event","Register","Register Success","Register Steam")),mixpanel.track("Sign in Steam",{email:a.email,steamid:a.steamid}),t.set(a.token).then(e,r)})})},t.signInSteamByTicket=function(){var e=require("./greenworks");return r(function(o,r){t.useNativeAuth?h?o(h):e.getEncryptedAppTicket("",function(e){o(h={ticket:e})},r):e.getAuthSessionTicket(o,r),m(5e3).then(function(){return r("timeout")})}).then(function(o){return n.post("auth/steam-ticket",{ticket:o.ticket.toString("hex"),useNativeAuth:t.useNativeAuth}).then(function(r){return o.handle&&e.cancelAuthTicket(o.handle),r.username||(mixpanel.alias(r.email),mixpanel.track("Register Steam"),ga("send","event","Register","Register Success","Register Steam")),mixpanel.track("Sign in Steam",{steamid:r.steamid}),t.set(r.token)})}).catch(function(e){return p.alert("","An error occured while logging into your Steam account. Please restart Steam and try again."),r.reject(e)})},t.signOut=function(){t.Me=null,o.put("auth",null)},t.set=function(e){return o.put("auth",e),t.check()},t.required=function(){return t.Me?!(!t.Me.username||!(t.Me.email||t.Me.steam||t.Me.github))||(s.url("/register"),!1):(window.nw?t.signInSteamByTicket().then(function(){return i.location.reload()}):s.url("/register"),!1)},e.$watch(function(){return t.Me&&t.Me._id},function(e,t){e!==t&&c.reconnect()}),window.nw||u.registerPre(t.check().catch(function(){return null}).then(function(){try{xnt("sendEvent","login")}catch(e){}})),t}])}]),(mod=angular.module("app.code-branches",[])).factory("CodeBranches",["Auth","Api","LocalStorage","$q","MemoryStorage","Socket","$timeout",function(e,t,o,r,n,a,i){var s=[],c=[],u=Math.floor(1e6*Math.random()),l={userId:"0",init:function(e){var t=this;return this.loadBranches().then(function(r){if(!_.any(r,{branch:"default"})){var a=n.get("users.code."+e),i=_.find(a,function(e){return e._id==t.userId});r.push({branch:"default",activeWorld:!0,activeSim:!0,modules:i.modules,userId:t.userId,timestamp:Date.now()}),o.put("branches",r)}})},loadBranches:function(){var e=o.get("branches",[]);return r.when(_.filter(e,{userId:this.userId}))},loadModulesByActiveName:function(e){var t=this;return this.loadBranches().then(function(o){var r=_.find(o,_defineProperty({},e,!0));if(r)return r;var a=n.get("users.code."+e);return{branch:"default",modules:_.find(a,function(e){return e._id==t.userId}).modules}})},setActiveBranch:function(e,t){return this.loadBranches().then(function(r){r.forEach(function(o){return o[e]=o.branch==t}),o.put("branches",r),o.put("branches."+e,t),i(10).then(function(){return s.forEach(function(o){return o.activeName==e&&o.fn(t)})})})},deleteBranch:function(e){return this.loadBranches().then(function(t){var r=_.find(t,{branch:e});return!r||r.activeWorld||r.activeSim||_.remove(t,{branch:e}),o.put("branches",t),Date.now()})},cloneBranch:function(e,t,r){var n=this;return this.loadBranches().then(function(a){_.remove(a,{branch:t});var i=e?_.clone(_.find(a,{branch:e})):{modules:r||{main:""},userId:n.userId};return i.branch=t,i.activeWorld=!1,i.activeSim=!1,i.timestamp=Date.now(),a.push(i),o.put("branches",a),i.timestamp})},submitCode:function(e,t,r){return this.loadBranches().then(function(n){var a=_.find(n,{branch:e});return a.modules=t,a.timestamp=Date.now(),o.put("branches",n),r&&c.forEach(function(o){return o({branch:e,modules:t,timestamp:Date.now()},!0)}),a.timestamp})},registerActiveBranchCallback:function(e,t,o){var r={activeName:t,fn:o};s.push(r),e.$on("$destroy",function(){return _.pull(s,r)})},registerCodeCallback:function(e,t){c.push(t),e.$on("$destroy",function(){return _.pull(c,t)})}},p={init:function(){return r.when()},loadBranches:function(e){return t.get("user/branches",{withCode:e}).then(function(e){return e.list})},loadModulesByActiveName:function(e){return t.get("user/code",{branch:"$"+e})},setActiveBranch:function(e,o){return t.post("user/set-active-branch",{activeName:e,branch:o})},deleteBranch:function(e){return t.post("user/delete-branch",{branch:e}).then(function(e){return e.timestamp})},cloneBranch:function(e,o,r){return t.post("user/clone-branch",{branch:e,newName:o,defaultModules:r}).then(function(e){return e.timestamp})},submitCode:function(e,o){return t.post("user/code",{branch:e,modules:o,_hash:u}).then(function(e){return e.timestamp})},registerActiveBranchCallback:function(t,o,r){a.bindEventToScope(t,"user:"+e.Me._id+"/set-active-branch",function(e){e.activeName==o&&r(e.branch)})},registerCodeCallback:function(t,o){a.bindEventToScope(t,"user:"+e.Me._id+"/code",function(e){o(e,e.hash==u)})}};return e.Me?p:l}]);_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var o=[],r=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(o.push(i.value),!t||o.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}return o}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var boyNames=["Jackson","Aiden","Liam","Lucas","Noah","Mason","Jayden","Ethan","Jacob","Jack","Caden","Logan","Benjamin","Michael","Caleb","Ryan","Alexander","Elijah","James","William","Oliver","Connor","Matthew","Daniel","Luke","Brayden","Jayce","Henry","Carter","Dylan","Gabriel","Joshua","Nicholas","Isaac","Owen","Nathan","Grayson","Eli","Landon","Andrew","Max","Samuel","Gavin","Wyatt","Christian","Hunter","Cameron","Evan","Charlie","David","Sebastian","Joseph","Dominic","Anthony","Colton","John","Tyler","Zachary","Thomas","Julian","Levi","Adam","Isaiah","Alex","Aaron","Parker","Cooper","Miles","Chase","Muhammad","Christopher","Blake","Austin","Jordan","Leo","Jonathan","Adrian","Colin","Hudson","Ian","Xavier","Camden","Tristan","Carson","Jason","Nolan","Riley","Lincoln","Brody","Bentley","Nathaniel","Josiah","Declan","Jake","Asher","Jeremiah","Cole","Mateo","Micah","Elliot"],girlNames=["Sophia","Emma","Olivia","Isabella","Mia","Ava","Lily","Zoe","Emily","Chloe","Layla","Madison","Madelyn","Abigail","Aubrey","Charlotte","Amelia","Ella","Kaylee","Avery","Aaliyah","Hailey","Hannah","Addison","Riley","Harper","Aria","Arianna","Mackenzie","Lila","Evelyn","Adalyn","Grace","Brooklyn","Ellie","Anna","Kaitlyn","Isabelle","Sophie","Scarlett","Natalie","Leah","Sarah","Nora","Mila","Elizabeth","Lillian","Kylie","Audrey","Lucy","Maya","Annabelle","Makayla","Gabriella","Elena","Victoria","Claire","Savannah","Peyton","Maria","Alaina","Kennedy","Stella","Liliana","Allison","Samantha","Keira","Alyssa","Reagan","Molly","Alexandra","Violet","Charlie","Julia","Sadie","Ruby","Eva","Alice","Eliana","Taylor","Callie","Penelope","Camilla","Bailey","Kaelyn","Alexis","Kayla","Katherine","Sydney","Lauren","Jasmine","London","Bella","Adeline","Caroline","Vivian","Juliana","Gianna","Skyler","Jordyn"],idChars="0123456789abcdef";function keyFilter(){var e=memoize(primToObj);return function(t,o){if(o=!_.isBoolean(o)||o,!t||!_.isObject(t)||_.isArray(t)||!o)return t;var r=[],n=_.keys(t);return _.each(n,function(o){if("$value"!=o){var n=t[o];_.isObject(n)?n.$name=o:n=e(o,n),r.push(n)}}),r}}function primToObj(e,t){return{$value:t,$name:e}}function memoize(e){var t=function t(){var o=t.cache,r=arguments[0],n=arguments[1];return o[r]=o[r]||{},_.isUndefined(o[r][n])?(o[r][n]=e.call(null,r,n),o[r][n]):o[r][n]};return t.cache={},t}(mod=angular.module("app.connection",[])).factory("Connection",["MemoryStorage","$rootScope","$q","$routeParams","$http","$interval","Dialogs","Api","$routeSegment","Loader","Socket","Constants","Auth","$window","StaticMaps","$timeout","$location",function(e,t,o,r,n,a,i,s,c,u,l,p,m,d,h,f,g){var v,y,b,w,S,M,$,T,k,C,A,R,O,L,j,E={},I=[],P=[],x=1e3,D={3:{username:"Source Keeper"},2:{username:"Invader"}},G={timeoutTransactionId:null,timeoutInstance:null,modalInstance:null,setTimeout:function(e){function t(t,o,r){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,o){var r=this;this.timeoutTransactionId=e,this.timeoutInstance=setTimeout(function(){r.timeoutTransactionId==e?(r.modalInstance=i.ask({title:"Not Responding",message:"Your script is not responding. Do you want to terminate it?",buttonLabel:"Terminate",buttonCancelLabel:"Wait"}),r.modalInstance.result.then(function(){o.postMessage({transactionId:e}),r.timeoutTransactionId=null}).catch(function(){r.setTimeout(e,t,o)}).finally(function(){return r.modalInstance=null})):o.postMessage({transactionId:e,reject:!0})},t)}),clearTimeout:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){e||(e=this.timeoutTransactionId),this.timeoutInstance&&e==this.timeoutTransactionId&&(this.modalInstance&&this.modalInstance.close(),clearTimeout(this.timeoutInstance))})};function N(e){for(var t in e)if(_.isArray(e[t])){for(var o={},r=0;r<e[t].length;r++)o[r]=e[t][r];e[t]=o}}function U(e,t){for(var o in t){var r=t[o],n=_.find(e,{_id:o});n?null!==r?(N(n),N(r),n=_.merge(n,r,function(e,t){if(_.isArray(e)&&_.isArray(t))return t})):_.remove(e,{_id:o}):r&&(n=_.cloneDeep(r),e.push(n))}}function H(){var e=parseInt(r.t);if(e==T+1)U(S,M.ticks[e]),T=e;else{S=[],T=M.base-1;do{T++,U(S,M.ticks[T])}while(T<e)}}function z(e){return e.length?_.map(e.split("|"),function(e){var t=e.split("~");return t[0]=t[0].replace(/\$VLINE\$/g,"|").replace(/\$TILDE\$/g,"~"),t}):[]}function W(e){return e=e||[],_.map(e,function(e){return e[0]=e[0].replace(/\|/g,"$VLINE$").replace(/~/g,"$TILDE$"),e.join("~")}).join("|")}var B=void 0;function F(t,o){var r=e.get("users.memory")||[],n=_.find(r,{_id:t});n||(n={_id:t},r.push(n)),n.memory=JSON.stringify(o),e.put("users.memory",r)}function q(t,o){var r=e.get("users.memory"),n=_.find(r,{_id:t}),a=JSON.parse(n.memory);if(o)for(var i=o.split(/\./);i.length>0;)a=a[i.shift()];return a}return t.$on("$locationChangeStart",function(e,t){if(j){if(L==t)return L=null,!0;e.preventDefault(),B||(B=!0,i.ask("","Your script will be saved, but your simulation progress will be lost! Are you sure?").result.then(function(){j=!1,L=t,d.location.href=t}).finally(function(){B=!1}))}}),E.allowChangeUrl=function(e){return L=window.location.origin+window.location.pathname+"#!"+e},E.onRoomUpdate=function(e,t){var o=function(){return _.remove(I,function(e){return e==t})};return I.push(t),e.$on("$destroy",o),R&&t(R,O),o},E.setSimLostWarning=function(e){j=!0,d.onbeforeunload=function(){return"Your script will be saved, but your simulation progress will be lost! Are you sure?"},e.$on("$destroy",function(){j=!1,d.onbeforeunload=null})},E.onConsoleUpdate=function(e){return P.push(e),function(){return _.remove(P,function(t){return t==e})}},E.sendConsoleCommand=function(e,t){A?y&&y.postMessage({consoleCommand:e,userId:t}):u.loading(s.post("user/console",{expression:e,shard:r.shard}))},E.reloadRoom=function(t,o,r,n,a,i){R=t,!o&&M&&(o=D),O=o,A?(t=t||e.get("rooms.objects")||[],o=o||{0:{username:"Player 1"},1:{username:"Player 2"},2:{username:"Invader"},3:{username:"Source Keeper"}},r=r||e.get("gameinfo"),n=n||e.get("gametime"),m.Me&&(o[m.Me._id]=m.Me),a=a||e.get("rooms.flags"),i=i||_.reduce(e.get("visual")||{},function(e,t){return e+t},""),I.forEach(function(e){return e(t,o,r,n,a,i)})):t&&I.forEach(function(e){return e(t,o,r,n,a,i)})},E.runWave=function(){var t=e.get("gameinfo")||{};t.timeToWave=0,e.put("gameinfo",t)},E.survivalEnabled=function(t){var o=e.get("gameinfo")||{};o.survivalEnabled=t,e.put("gameinfo",o)},E.setRunningLocal=function(e){A=e,R=null,O=null},E.setTickPeriod=function(e){x=e},E.initReplay=function(t,a){if(S=[],k=0,T=0,M=t)if(M.ticks&&void 0!==M.ticks[r.t]){if(t.base!=Math.floor(parseInt(r.t)/s.options.serverData.historyChunkSize)*s.options.serverData.historyChunkSize)return;H(),e.put("rooms.objects",S),e.put("gameinfo",{mode:"world"}),_.forEach(t.ticks,function(e,t){parseInt(t)>k&&(k=parseInt(t))}),(i=e.get("gameinfo")).historyTimestamp=M.timestamp,i.historyTickRecorded=null!==M.ticks[r.t],e.put("gametime",T),E.reloadRoom()}else{var i;T=+r.t,e.put("rooms.objects",S),(i=e.get("gameinfo")||{mode:"world"}).historyTimestamp=void 0,i.historyTickRecorded=!1,e.put("gameinfo",i),e.put("gametime",T),E.reloadRoom()}a&&a.$watchGroup([function(){return r.t},function(){return r.room},function(){return r.shard},function(){return c.name}],function(t){var r=_slicedToArray(t,3),a=r[0],i=r[1],u=r[2];if("top.game-room-history"==c.name){a=parseInt(a);var l=Math.floor(a/s.options.serverData.historyChunkSize)*s.options.serverData.historyChunkSize;if(M&&M.room==i&&M.ticks&&void 0!==M.ticks[a]){H();var p=e.get("gameinfo");p.historyTickRecorded=null!==M.ticks[a],e.put("gameinfo",p),e.put("rooms.objects",S),E.reloadRoom(void 0,void 0,void 0,T)}else if(!M||M.base!=l||M.room!=i){C=l;var m=s.options.official?s.options.historyUrl+(u+"/")+i+"/"+l+".json":"http://"+s.options.host+":"+s.options.port+"/room-history?room="+i+"&time="+l;n.get(m).then(function(e){if(200!=e.status)return o.reject();if(C!=l)return o.reject();e.data.room||(e.data.room=i);var t={};_.forEach(e.data.ticks,function(e){_.forEach(e,function(e){e&&(e.user&&!D[e.user]&&(t[e.user]=!0),e.reservation&&e.reservation.user&&!D[e.reservation.user]&&(t[e.reservation.user]=!0))})});var r=[];return(t=_.keys(t)).length&&t.forEach(function(e){r.push(s.get("user/find",{id:e}).then(function(e){D[e.user._id]=e.user}))}),o.all(r).then(function(){if(C!=l)return o.reject();E.initReplay(e.data)})}).catch(function(e){E.initReplay({})}).finally(function(){C==l&&(C=!1)})}}})},E.run=function(){if(e.put("runTimestamp",(new Date).getTime()),M)return $&&a.cancel($),void($=a(function(){C||(g.replace(),g.search("t",parseInt(r.t)+1))},x));var n=!1,i=null;function s(e){return o(function(t,o){var r=new Worker(globalWorkersBlob);r.onerror=function(e){},t(r),setTimeout(function(){return r.postMessage({type:"launch",name:e})},10)})}s("main").then(function(o){(v=o).onmessage=function(o){"localStorage"==o.data.type&&e.handleMessage(o),"roomsDone"==o.data.type&&(t.$applyAsync(function(){E.reloadRoom()}),o.target.postMessage({transactionId:o.data.transactionId}),n&&(w.then(function(e){return e.terminate()}),w=null,n=!1))},v.postMessage({type:"setTickPeriod",period:x})}),s("runner").then(function(o){function r(){w||(w=s("runtime")).then(function(e){e.onmessage=function(e){y.postMessage({type:"worker",workerId:0,message:e.data})},i&&clearTimeout(i),i=setTimeout(function(){n=!0,i=null},1e4)})}(y=o).onmessage=function(o){"localStorage"==o.data.type&&e.handleMessage(o),"worker"==o.data.type&&(o.data.startSrc&&r(),o.data.message&&(r(),w.then(function(e){e.postMessage(o.data.message)})),o.data.terminate&&w&&w.then(function(e){e.terminate(),w=null,r()})),"console"==o.data.type&&t.$applyAsync(function(){P.forEach(function(e){return e(o.data)})}),"timeout"==o.data.type&&G.setTimeout(o.data.transactionId,o.data.timeout,o.target),"clearTimeout"==o.data.type&&(G.clearTimeout(o.data.timeoutTransactionId),o.target.postMessage({transactionId:o.data.transactionId}),o.target.postMessage({transactionId:o.data.timeoutTransactionId,reject:!0}))}}),s("processor").then(function(t){(b=t).onmessage=function(t){if("localStorage"==t.data.type&&e.handleMessage(t),"bulk"==t.data.type){var o=e.get(t.data.storage);t.data.removes.forEach(function(e){var t=_.findIndex(o,{_id:e});t>-1&&o.splice(t,1)});for(var r={},n=0;n<o.length;n++)r[o[n]._id]=n;t.data.updates.forEach(function(e){e._id in r&&_.merge(o[r[e._id]],e.data)}),t.data.inserts.forEach(function(e){var t;do{t="";for(var r=0;r<24;r++)t+=idChars[Math.floor(Math.random()*idChars.length)];0}while(_.any(o,{_id:t}));e._id=t,o.push(e)}),t.data.incs.forEach(function(e){e._id in r&&(o[r[e._id]][e.key]+=e.amount)}),r=null,e.put(t.data.storage,o),t.target.postMessage({transactionId:t.data.transactionId})}}}),E.reloadRoom()},E.terminate=function(){M?$&&(a.cancel($),$=null):(v&&v.terminate(),y&&y.terminate(),b&&b.terminate(),w&&w.then(function(e){e.terminate(),w=null}),G.clearTimeout())},E.getRoomTerrain=function(){return A&&"top.game-room-history"!=c.name?o(function(t){!function o(){var r=e.get("rooms.terrain");r&&r.length?t(h.decodeTerrain(r[0].terrain,r[0].room)):setTimeout(o,10)}()}):u.loading(s.get("game/room-terrain",{room:r.room,shard:r.shard,encoded:!0}).then(function(e){return e.terrain&&e.terrain.length?h.decodeTerrain(e.terrain[0].terrain,r.room):o.reject()}))},E.createFlag=function(t,n,a,i,c,l){if(A){var p=e.get("rooms.flags"),m=_.find(p,{user:l});m||(m={_id:l,user:l,data:""},p.push(m));var d=z(m.data),h=_.find(d,function(e){return e[0]==a});return h?(h[1]=i,h[2]=c,h[3]=t,h[4]=n):d.push([a,i,c,t,n]),m.data=W(d),e.put("rooms.flags",p),o.when()}return u.loading(s.post("game/create-flag",{x:t,y:n,name:a,color:i,secondaryColor:c,room:r.room,shard:r.shard}))},E.changeFlagColor=function(t,o,n,a){if(!A)return u.loading(s.post("game/change-flag-color",{room:r.room,shard:r.shard,name:t,color:o,secondaryColor:n}));var i=e.get("rooms.flags"),c=_.find(i,{user:a});if(c){var l=z(c.data),p=_.find(l,function(e){return e[0]==t});p&&(p[1]=o,p[2]=n,c.data=W(l),e.put("rooms.flags",i))}},E.removeFlag=function(t,o){if(!A)return u.loading(s.post("game/remove-flag",{room:r.room,shard:r.shard,name:t}));var n=e.get("rooms.flags"),a=_.find(n,{user:o});if(a){var i=z(a.data);_.remove(i,function(e){return e[0]==t}),a.data=W(i),e.put("rooms.flags",n)}},E.addObjectIntent=function(t,n,a,i){if(A){var c=e.get("rooms.intents")||[];return c.length||c.push({room:"sim"}),_.merge(_.find(c,{room:"sim"}),{users:_defineProperty({},n,{objects:_defineProperty({},t,_defineProperty({},a,i))})}),e.put("rooms.intents",c),o.when()}return u.loading(s.post("game/add-object-intent",{room:r.room,shard:r.shard,_id:t,name:a,intent:i}))},E.addGlobalIntent=function(t,n,a){if(A){var i=e.get("rooms.intents")||[];return i.length||i.push({room:"global"}),_.merge(_.find(i,{room:"global"}),{users:_defineProperty({},t,{objects:_defineProperty({},_id,_defineProperty({},n,a))})}),e.put("rooms.intents",i),o.when()}return u.loading(s.post("game/add-global-intent",{shard:r.shard,name:n,intent:a}))},E.createConstruction=function(t,n,a,i,l){if(A){var m=e.get("rooms.objects"),d=e.get("rooms.terrain"),h=p.CONSTRUCTION_COST[t];"road"==t&&_.any([m,d],function(e){return _.any(e,{x:n,y:a,type:"swamp"})})&&(h*=p.CONSTRUCTION_COST_ROAD_SWAMP_RATIO),"tower"==t&&"top.sim-tutorial"==c.name&&(h=100);var f={_id:E.genUniqueId(),type:"constructionSite",structureType:t,name:l,x:n,y:a,user:i,progress:0,progressTotal:h,room:"sim"};return m.push(f),e.put("rooms.objects",m),o.when(f._id)}return u.loading(s.post("game/create-construction",{room:r.room,shard:r.shard,structureType:t,x:n,y:a,name:l}).then(function(e){return e._id}))},E.placeSpawn=function(t,o,n,a){if(!A)return u.loading(s.post("game/place-spawn",{room:r.room,shard:r.shard,x:t,y:o,name:n}).then(function(e){return m.check(),e}));var i=e.get("rooms.objects");i.push({_id:E.genUniqueId(),type:"spawn",name:n,x:t,y:o,user:a,room:"sim",energy:p.SPAWN_ENERGY_START,energyCapacity:p.SPAWN_ENERGY_CAPACITY,hits:p.SPAWN_HITS,hitsMax:p.SPAWN_HITS,spawning:null}),e.put("rooms.objects",i)},E.genUniqueId=function(){var t,o=e.get("rooms.objects");do{t="";for(var r=0;r<24;r++)t+=idChars[Math.floor(Math.random()*idChars.length)];0}while(_.any(o,{_id:t}));return t},E.getMemory=function(t){var n=o.when();return A||t!=m.Me._id||(n=u.loading(s.get("user/memory",{shard:r.shard})).then(function(e){return F(t,e.memory)})),n.then(function(){var o=e.get("users.memory"),r=_.find(o,{_id:t});return r?r.memory:(F(t,{}),E.getMemory(t))})},E.setMemory=function(e,t){var n=o.when();return A||e!=m.Me._id||(n=u.loading(s.post("user/memory",{memory:t,shard:r.shard}))),n.then(function(){return F(e,t)})},E.getMemorySegment=function(t,n){if(A){var a=e.get("users.memory.segments")||[],i=_.find(a,{_id:t});return i?o.when(i.segments[n]):o.reject()}return u.loading(s.get("user/memory-segment",{segment:n,shard:r.shard})).then(function(e){return e.data})},E.setMemorySegment=function(t,n,a){if(A){var i=e.get("users.memory.segments")||[],c=_.find(i,{_id:t});return c?(c.segments[n]=a,e.put("users.memory.segments",i),o.when()):o.reject()}return u.loading(s.post("user/memory-segment",{segment:n,data:a,shard:r.shard}))},E.listenSocket=function(e){var t,o=[],n={};e.$watchCollection(function(){return[r.room,r.shard]},function(){t&&(t.remove(),o=[],n={}),t=l.bindEventToScope(e,"room:"+(s.options.serverData.shards.length>1?r.shard+"/":"")+r.room,function(e,t){t.type=="room:"+(s.options.serverData.shards.length>1?r.shard+"/":"")+r.room&&(E.roomSubscribeError=void 0,U(o,e.objects),_.extend(n,e.users),E.reloadRoom(o,n,e.info,e.gameTime,e.flags,e.visual))},function(e,t){t.type=="room:"+(s.options.serverData.shards.length>1?r.shard+"/":"")+r.room&&(E.roomSubscribeError=e)})}),l.bindEventToScope(e,"user:"+m.Me._id+"/console",function(e){e.messages&&(e.messages.log.forEach(function(e){return window.console.log(e)}),e.messages.results.forEach(function(e){return window.console.log(e)})),e.error&&window.console.error(e.error),P.forEach(function(t){e.userId=m.Me._id,t(e)})})},E.onMemoryUpdate=function(e,t,o,n){return A?E.onRoomUpdate(e,function(){try{var e=q(t,o);n(""+e)}catch(e){n("Incorrect memory path")}}):l.bindEventToScope(e,"user:"+t+"/memory/"+(s.options.serverData.shards.length>1?r.shard+"/":"")+o,function(e){n(e)}).remove},E.getMemoryByPath=function(e,t){if(!A)return s.get("user/memory",{path:t,shard:r.shard}).then(function(e){return _.isString(e.data)&&"gz:"==e.data.substring(0,3)?JSON.parse(pako.ungzip(atob(e.data.substring(3)),{to:"string"})):e.data});try{var n=q(e,t);return o.when(n)}catch(e){return o.reject("Incorrect memory path")}},E.setMemoryByPath=function(t,n,a){if(!A)return s.post("user/memory",{path:n,value:a,shard:r.shard});try{return function(t,o,r){var n=e.get("users.memory"),a=_.find(n,{_id:t}),i=JSON.parse(a.memory);if(o){for(var s=i,c=o.split(/\./),u=c.pop();c.length>0;)s=s[c.shift()];s[u]=r}else i=r;a.memory=JSON.stringify(i),e.put("users.memory",n)}(t,n,a),o.when()}catch(e){return o.reject("Incorrect memory path")}},E.genUniqueNameForType=function(t,n){if("creep"==t)return o.when(function(t){var o,r,n=e.get("rooms.objects"),a=0;do{var i=Math.random()>.5?boyNames:girlNames;o=i[Math.floor(Math.random()*i.length)],a>3&&(o+=i[Math.floor(Math.random()*i.length)]),a++,r=_.any(n,{user:t,type:"creep",name:o})}while(r);return o}(n));if(A){var a,i=e.get("rooms.objects"),c=1;do{a=_.capitalize(t)+c,c++}while(_.any(i,{user:n,type:t,name:a})||_.any(i,{user:n,type:"constructionSite",structureType:t,name:a}));return o.when(a)}return u.loading(s.post("game/gen-unique-object-name",{type:t,shard:r.shard}).then(function(e){return e.name}))},E.genUniqueFlagName=function(t){if(A){var n=e.get("rooms.flags"),a=z((_.find(n,{user:t})||{data:""}).data),i=0;do{i++}while(_.any(a,function(e){return e[0]=="Flag"+i}));return o.when("Flag"+i)}return u.loading(s.post("game/gen-unique-flag-name",{shard:r.shard}).then(function(e){return e.name}))},E.checkUniqueNameForType=function(t,n,a){if(A){var i=e.get("rooms.objects");return _.any(i,{user:a,type:n,name:t})||_.any(i,{user:a,type:"constructionSite",structureType:n,name:t})?o.reject("name exists"):o.when()}return u.loading(s.post("game/check-unique-object-name",{name:t,type:n,shard:r.shard}))},E.checkUniqueFlagName=function(t,n){if(A){var a=e.get("rooms.flags"),i=z((_.find(a,{user:n})||{data:""}).data);return _.any(i,function(e){return e[0]==t})?o.reject("name exists"):o.when()}return u.loading(s.post("game/check-unique-flag-name",{name:t,shard:r.shard}))},E.finishGame=function(){if(!A)return u.loading(s.post("game/finish",{room:r.room}));var t=e.get("gameinfo")||{};t.status="finished",e.put("gameinfo",t)},E.createInvader=function(t,n,a,i,c){if(A){var u=e.get("rooms.objects"),l={bigHealer:["move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","heal","move"],bigRanged:["tough","tough","tough","tough","tough","tough","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","ranged_attack","work","move"],bigMelee:["tough","tough","tough","tough","tough","tough","tough","tough","tough","tough","tough","tough","tough","tough","tough","tough","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","move","ranged_attack","ranged_attack","ranged_attack","work","work","work","work","attack","attack","move"],smallHealer:["move","move","move","move","heal","heal","heal","heal","heal","move"],smallRanged:["tough","tough","move","move","move","move","ranged_attack","ranged_attack","ranged_attack","move"],smallMelee:["tough","tough","move","move","move","move","ranged_attack","work","attack","move"]}[i+a],p={_id:E.genUniqueId(),type:"creep",user:"2",body:_.map(l,function(e){return{type:e,hits:100}}),hits:100*l.length,hitsMax:100*l.length,ticksToLive:1500,x:t,y:n,room:"sim",fatigue:0,energy:0,energyCapacity:0,name:"invader_"+Math.floor(1e3*Math.random())};return c&&p.body.forEach(function(e){"heal"==e.type&&(e.boost="LO"),"ranged_attack"==e.type&&(e.boost="KO"),"work"==e.type&&(e.boost="ZH"),"attack"==e.type&&(e.boost="UH")}),u.push(p),e.put("rooms.objects",u),o.when()}return s.post("game/create-invader",{room:r.room,shard:r.shard,x:t,y:n,size:i,type:a,boosted:c})},E}]),angular.module("app.key-filter",[]).filter("keyFilter",keyFilter),angular.module("app.local-storage",[]).provider("LocalStorage",function(){this.$get=ngInject(["$rootScope","$parse","$timeout","$window","$routeParams","AppInstanceId","$q",function(e,t,o,r,n,a,i){var s={prefix:""},c={},u=function(e,t){return void 0===t&&(t=s.prefix),t&&(e=(e=t+":"+e).replace(new RegExp("^("+t+":)+"),t+":")),e};s.get=function(e,t,o){e=u(e,o);var r=localStorage.getItem(e);if(null!==r){var n="undefined"==r?void 0:JSON.parse(r);return _.isArray(t)&&!n?t:angular.isObject(n)&&_&&_.defaultsDeep?_.defaultsDeep(n,t):n}return t},s.put=function(e,t,o){return e=u(e,o),localStorage.setItem(e,JSON.stringify(t)),t},s.remove=function(e,t){e=u(e,t),localStorage.removeItem(e)},s.removeAll=function(){localStorage.clear()},s.sync=function(t,o,r){t=u(t);var n=s.get(t,r);angular.extend(o,n),e.$watch(function(){return o},function(e){s.put(t,e)},!0)},s.syncArray=function(t,o){t=u(t);var r=s.get(t,[]);o.forEach(function(e,t){o[t]=null,delete o[t]}),r.forEach(function(e){return o.push(e)}),e.$watchCollection(function(){return o},function(e){s.put(t,e)})},s.syncExp=function(e,o,r,n){e=u(e);var a=s.get(e,n);t(r).assign(o,a),o.$watch(r,function(t){s.put(e,t)},!0)},s.createSyncedObj=function(e,t){e=u(e);var o={};return s.sync(e,o,t),o},s.createSyncedArray=function(e){e=u(e);var t=[];return s.syncArray(e,t),t},s.handleMessage=function(e){e.data.get&&(e.data.get.key=u(e.data.get.key),e.target.postMessage({type:"localStorage",transactionId:e.data.transactionId,get:{value:s.get(e.data.get.key)}})),e.data.put&&(e.data.put.key=u(e.data.put.key),e.target.postMessage({type:"localStorage",transactionId:e.data.transactionId,put:{value:s.put(e.data.put.key,e.data.put.value)}}))},s.onChange=function(e,t,o){t=u(t);var r=function(){return _.remove(c[t],function(e){return e==o})};return c[t]=c[t]||[],c[t].push(o),e.$on("$destroy",r),r};return window.addEventListener("storage",function(t){var o=t.key;c[o]&&e.$apply(function(){c[o].forEach(function(e){return e(JSON.parse(t.newValue))})})},!1),s.checkAppInstanceId=function(){var e=s.get("editor-popup",{}).appInstanceId;return e==n.app_instance_id||e==a},s.sendMessage=function(e,t,o){return s.checkAppInstanceId()?i(function(r,n){s.put(t,{send:!0,data:o});var a=s.onChange(e,t,function(e){e.resolve&&r(e.result),e.reject&&n(e.result),s.remove(t),a()})}):i.reject()},s.listenMessage=function(e,t,o){s.onChange(e,t,function(e){s.checkAppInstanceId()&&e&&e.send&&o(e.data).then(function(e){s.put(t,{resolve:!0,result:e})}).catch(function(e){s.put(t,{reject:!0,result:e})})})},s}])}),(mod=angular.module("app.memory-storage",[])).factory("MemoryStorage",["$cacheFactory","LocalStorage",function(e,t){var o=e("memoryStorage");return o.handleMessage=function(e){if(e.data.get){var t=o.get(e.data.get.key);e.target.postMessage({type:"localStorage",transactionId:e.data.transactionId,get:{value:t}})}e.data.put&&e.target.postMessage({type:"localStorage",transactionId:e.data.transactionId,put:{value:o.put(e.data.put.key,e.data.put.value)}})},o.put("users",t.get("users")),o.put("users.code.activeSim",t.get("users.code.activeSim")),o.put("users.code.activeWorld",t.get("users.code.activeWorld")),o}]);_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var o=[],r=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(o.push(i.value),!t||o.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}return o}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();function downloadNewPackage(e,t){var o=require("path").dirname(process.execPath),r=require("https"),n=require("graceful-fs"),a=/\\/.test(nw.App.dataPath)?"\\":"/",i=o+a+"package.nw.new",s=n.openSync(o+a+"update.log","a");function c(e){n.writeSync(s,"["+(new Date).toUTCString()+"] "+e+"\n")}try{c("Package "+e+" available");var u=n.createWriteStream(i);u.on("open",function(){c("File opened"),r.get("https://screeps.com/packages/"+e,function(e){c("Received response from the server: "+e.statusCode),200==e.statusCode?(e.pipe(u),u.on("finish",function(){c("File write finished, "+u.bytesWritten+" bytes written"),u.close(function(){c("File write closed"),n.renameSync(i,o+a+"package.nw"),c("File renamed"),n.close(s),t(null,!0)})})):(n.unlinkSync(i),n.close(s),t(e.statusCode))}).on("error",function(e){c("HTTP transfer error: "+e),n.unlinkSync(i),n.close(s),t(e.message)})}).on("error",function(e){c("File write error: "+e),n.unlinkSync(i),n.close(s),t(e.message)})}catch(e){c("Error: "+e),n.close(s),t(e)}}(mod=angular.module("app.nw-local-file-sync",[])).factory("NwLocalFileSync",["Dialogs","$q","$rootScope","Auth","CodeBranches","Loader","LocalStorage","Api",function(e,t,o,r,n,a,i,s){var c,u,l,p,m="/",d=0,h=3e3,f=[],g={};function v(e){return l.readdir(p+m+e).then(function(o){var r={},n=0;return o.forEach(function(t){var o=t.match(/^(.*)\.(js|wasm)$/);if(o){var a=p+m+e+m+t;r[o[1]]=l.stat(a).then(function(e){return e.mtime>n&&(n=e.mtime),"js"==o[2]?l.readFile(a,{encoding:"utf8"}):l.readFile(a).then(function(e){return{binary:e.toString("base64")}})})}}),t.all(r).then(function(e){return{modules:e,mtime:n}})}).catch(w)}function y(e){return l.writeFile(p+"/.sync",e+"\n"+(r.Me?r.Me._id:"<anonymous>")).catch(w)}function b(e,t){var r=u.watch(p+m+e+m+"*.{js,wasm}",{ignoreInitial:!0,depth:0});return r.on("all",function(r,n){return o.$apply(function(){"add"!=r&&"change"!=r&&"unlink"!=r||d>Date.now()-h||_.contains(f,n)||(Date.now(),a.loading(v(e).then(function(o){var r=o.modules;o.mtime;return t.branchChanged&&t.branchChanged(e,r),y(Date.now())})))})}),r}function w(e){return t.reject(e)}return g.init=function(){if(!window.nw)return t.when();var e=s.options.official?"screeps.com":s.options.host.replace(/[^a-zA-Z0-9]/g,"_")+"___"+s.options.port;c=require("graceful-fs"),u=require("chokidar"),l={};var o={};return["readFile","writeFile","stat","readdir","mkdir","unlink","rmdir"].forEach(function(e){l[e]=function(){Math.floor(1e5*Math.random());var r=Array.prototype.slice.apply(arguments);return"writeFile"==e&&f.push(r[0]),t(function(t,n){r.push(function(a,i){"writeFile"==e&&(o[r[0]]&&clearTimeout(o[r[0]]),o[r[0]]=setTimeout(function(){_.pull(f,r[0])},h)),a?n(a):t(i)}),c[e].apply(c,r)})}}),/\\/.test(nw.App.dataPath)&&(m="\\"),p=nw.App.dataPath.replace(/[\/\\]User Data/,"").replace(/[\/\\]Default/,""),p+=m+"scripts",l.stat(p).catch(function(){return l.mkdir(p)}).then(function(){return p=p+m+e,l.stat(p).catch(function(){return l.mkdir(p)})}).then(function(){return _.extend(g,{dataPath:p,sep:m,worldName:e})})},g.startSync=function(o,r){if(window.nw){var s,c={};l.readdir(p).then(function(e){e.forEach(function(e){".sync"!=e&&(c[e]=b(e,r))});var t=u.watch(p,{ignoreInitial:!0,depth:0,ignored:".sync"});t.on("addDir",function(e){return o.$apply(function(){e=e.replace(p+m,""),Date.now(),a.loading(v(e).then(function(t){var o=t.modules;t.mtime;d<Date.now()-h&&r.branchCreated&&r.branchCreated(e,o),c[e]=b(e,r)}).then(function(){return y(Date.now())}))})}),t.on("unlinkDir",function(e){return o.$apply(function(){e=e.replace(p+m,""),d<Date.now()-h&&r.branchRemoved&&r.branchRemoved(e),c[e]&&(c[e].close(),delete c[e]),y(Date.now())})}),o.$on("$destroy",function(){return t.close()})}),n.registerCodeCallback(o,function(o,r){r||(s&&s.dismiss(),i.get("nw.alwaysReplaceLocalScripts",0)?g.writeBranch(o.branch,o.modules,o.timestamp):(s=e.ask({message:"Your remote scripts have been changed. Do you want to replace scripts on your local file system with the remote scripts?",buttonLabel:"Replace",buttonOptionalLabel:"Always replace without asking"})).result.catch(function(e){if("optional click"!=e)return t.reject(e);i.put("nw.alwaysReplaceLocalScripts",1)}).then(function(){return g.writeBranch(o.branch,o.modules,o.timestamp)}))})}},g.writeBranch=function(e,o,r){if(!window.nw)return t.when();d=Date.now();var n=p+m+e;return l.stat(n).catch(function(){return l.mkdir(n)}).then(function(){return l.readdir(n)}).then(function(e){return t.all(_.map(e,function(e){var r=e.match(/^(.*)\.(js|wasm)$/);return r&&!o[r[1]]?l.unlink(n+m+e):t.when()}))}).then(function(){return t.all(_.map(o,function(e,o){return null===e?t.when():(d=Date.now(),_.isObject(e)&&e.binary?l.writeFile(n+m+o+".wasm",atob(e.binary)):l.writeFile(n+m+o+".js",e))}))}).then(function(){if(r)return y(r)}).catch(w)},g.deleteBranch=function(e,o){return window.nw?(d=Date.now(),l.readdir(p+m+e).then(function(o){return t.all(_.map(o,function(t){return l.unlink(p+m+e+m+t)}))}).then(function(){return l.rmdir(p+m+e)}).then(function(){return y(o)}).catch(w)):t.when()},g.cloneBranch=function(e,o,r){return window.nw?v(e).then(function(e){var t=e.modules;e.mtime;return g.writeBranch(o,t,r)}).catch(w):t.when()},g.sync=function(o,n){if(!window.nw)return t.when();var s=0,c=new Date(0),u=new Date(0),d=r.Me?r.Me._id:"<anonymous>";return a.loading(l.stat(p+m+".sync").then(function(e){return c=e.mtime,l.readFile(p+m+".sync",{encoding:"utf8"})}).then(function(e){if(e){var t=e.split("\n"),o=_slicedToArray(t,2),r=o[0],n=o[1];s=parseInt(r)||0,d=n}}).catch(function(){}).then(o).then(function(o){var a=o.length?_.max(o,"timestamp").timestamp:0;return l.readdir(p).then(function(e){var o={};return e.forEach(function(e){".sync"!=e&&(o[e]=l.stat(p+m+e).then(function(o){return o.isDirectory()?v(e).then(function(e){var t=e.modules,o=e.mtime;return o>u&&(u=o),t}):t.when()}))}),t.all(o)}).then(function(l){var p=u.getTime()>c.getTime()+h,m=d!=(r.Me?r.Me._id:"<anonymous>")||a>s+h;if(p&&!m)return function(){return n(l).then(function(e){return y(e)})}();if(m&&!p)return _.size(l)&&d==(r.Me?r.Me._id:"<anonymous>")?i.get("nw.alwaysReplaceLocalScripts",0)?f():e.ask({message:"Your remote scripts have been changed. Do you want to replace scripts on your local file system with the remote scripts?",buttonLabel:"Replace",buttonOptionalLabel:"Always replace without asking"}).result.catch(function(e){if("optional click"!=e)return t.reject(e);i.put("nw.alwaysReplaceLocalScripts",1)}).then(f):f();if(m&&p)return e.ask({message:"Your remote scripts have been changed. Do you want to replace scripts on your local file system with the remote scripts? Your local changes will be LOST!",buttonLabel:"Replace"}).result.then(f);if(!c.getTime())return f();function f(){return t.all(_.map(o,function(e){return g.writeBranch(e.branch,e.modules)})).then(function(){return y(a)})}})}).catch(w))},g}]),(mod=angular.module("app.nw-manifest",[])).factory("NwManifest",["$http",function(e){var t={};return e.get("package.json").then(function(e){_.extend(t,e.data)}),t}]),(mod=angular.module("app.socket",[])).provider("Socket",function(){var e=this.options={};this.$get=["$log","$q","$injector","LocalStorage","$rootScope","Dialogs","NwManifest",function(t,o,r,n,a,i,s){o.defer();var c,u=$({}),l={clientProtocolVersion:e.clientProtocolVersion,clientPackageVersion:e.clientPackageVersion,connected:!1,timeCorrection:0,options:e},p=!1,m={list:{},add:function(e){this.list[e]="pending",l.connected&&(c.send("subscribe "+e),this.list[e]="sent")},remove:function(e){"sent"==this.list[e]&&l.connected&&c.send("unsubscribe "+e),delete this.list[e]},send:function(){for(var e in this.list)"pending"==this.list[e]&&(c.send("subscribe "+e),this.list[e]="sent")},reset:function(){for(var e in this.list)this.list[e]="pending"}};function d(){(c=new SockJS(e.websocketUrl,null,{protocols_whitelist:["websocket","xdr-streaming","xhr-streaming","iframe-eventsource","iframe-htmlfile"]})).onopen=function(){r.get("Auth").Me?c.send("auth "+n.get("auth")):(m.send(),l.connected=!0),e.gzip&&c.send("gzip on")},c.onmessage=function(e){var t;if("gz:"==e.data.substring(0,3)&&(e.data=pako.ungzip(atob(e.data.substring(3)),{to:"string"})),t=e.data.match(/^auth ok (.*)$/))m.send(),l.connected=!0,r.get("Auth").set(t[1]);else if("auth failed"==e.data)m.send(),l.connected=!0;else if(t=e.data.match(/^time (\d+)$/))l.timeCorrection=t[1]-Date.now();else if(t=e.data.match(/^protocol (\d+)$/))l.protocolVersion=parseInt(t[1]);else if("server down"==e.data)n.get("ignoreServerDown",0)||(p=!1,i.alert("Under construction",window.nw?"The server is under maintenance. Please restart.":"The server is under maintenance. Please reload the page."),c.close());else if(t=e.data.match(/^package (\d+)$/))l.packageVersion=parseInt(t[1]),window.nw&&l.packageVersion>s.packageVersion&&downloadNewPackage(l.packageVersion,function(e,t){return a.$apply(function(){e||(l.newPackageDownloaded=!0)})});else if(t=e.data.match(/^cannot subscribe/));else{var o=JSON.parse(e.data);l.fireEvent(o[0],o[1])}},c.onclose=function(){m.reset(),l.connected=!1,p&&setTimeout(d,1e3)}}return l.now=function(){return Date.now()+l.timeCorrection},l.subscribe=function(e){m.add(e)},l.unsubscribe=function(e){m.remove(e)},l.on=function(e,t){l.subscribe(e),u.bind(btoa(e),t)},l.off=function(e,t){l.unsubscribe(e),u.unbind(btoa(e),t)},l.fireEvent=function(e,t){var o=e.match(/^err@(.*)$/);o&&(e=o[1]);var r=$.Event(btoa(e));r.edata=t,r.error=!!o,u.trigger(r)},l.bindEventToScope=function(t,o,r,n){e=e||{};var a={listener:function(e){t.$applyAsync(function(){try{e.type=atob(e.type)}catch(e){}e.error?n&&n(e.edata,e):r(e.edata,e)})},remove:function(){a.listener&&(l.off(o,a.listener),a.listener=null)}};return l.on(o,a.listener),t.$on("$destroy",function(){a.remove()}),a},l.bindConnect=function(e){p=!0,d(),e.$on("$destroy",function(){c.close(),p=!1})},l.reconnect=function(){p&&c.close()},l}]});idChars="0123456789abcdef";(mod=angular.module("app.static-maps",[])).factory("StaticMaps",["Loader","$http","Constants","$q",function(e,t,o,r){var n={get:function(o){var a=this;if("custom"==o){for(var i="",s=0;s<50;s++)for(var c=0;c<50;c++){i+=0==c||0==s||49==c||49==s?"1":"0"}var u=[];return u.push({_id:n.getUniqueId(u),type:"controller",x:25,y:25,level:1,progress:0,room:"sim"}),r.when({terrain:[{_id:"terrain",room:"sim",type:"terrain",terrain:i}],objects:u})}return e.loading(t.get("vendor/map-"+o+".json?4").then(function(e){return e.data.terrain?(e.data.terrain[0].room="sim",e.data.objects.forEach(function(t){t.room="sim",t._id=n.getUniqueId(e.data.objects)}),e.data):{terrain:[{_id:"terrain",type:"terrain",terrain:a.encodeTerrain(e.data),room:"sim"}],objects:_.filter(e.data,function(t){return t.room="sim",t._id=n.getUniqueId(e.data),"wall"!=t.type&&"swamp"!=t.type})}}))},encodeTerrain:function(e){for(var t="",r=0;r<50;r++)for(var n=0;n<50;n++){var a=_.filter(e,{x:n,y:r}),i=0;_.any(a,{type:"wall"})&&(i|=o.TERRAIN_MASK_WALL),_.any(a,{type:"swamp"})&&(i|=o.TERRAIN_MASK_SWAMP),t+=i}return t},decodeTerrain:function(e,t){for(var r=[],n=0;n<50;n++)for(var a=0;a<50;a++){var i=e.charAt(50*n+a);i&o.TERRAIN_MASK_WALL&&r.push({room:t,x:a,y:n,type:"wall"}),i&o.TERRAIN_MASK_SWAMP&&r.push({room:t,x:a,y:n,type:"swamp"})}return r},getUniqueId:function(e){var t;do{t="";for(var o=0;o<24;o++)t+=idChars[Math.floor(Math.random()*idChars.length)];0}while(_.any(e,{_id:t}));return t}};return n}]);